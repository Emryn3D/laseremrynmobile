<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>EMRYN Measurement Tool</title>
<style>
  :root {
    --bg: #0e0f12;
    --panel: rgba(21, 24, 33, 0.95);
    --muted: rgba(39, 43, 54, 0.8);
    --text: #e8ecf1;
    --sub: #b6c0cf;
    --accent: #004025;
    --danger: #ff6b6b;
    --ok: #52d273;
    --overlay: rgba(0, 0, 0, 0.6);
  }
  
  * { box-sizing: border-box; }
  html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  }
  
  body {
    background: var(--bg);
    color: var(--text);
  }

  .screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 100;
  }

  .hidden { display: none !important; }
  .visible { display: block !important; }

  /* Home screen */
  .home-screen {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    flex-direction: column;
    padding: 20px;
  }

  .home-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0;
    border-bottom: 1px solid #ddd;
    margin-bottom: 30px;
  }

  .home-logo {
    height: 40px;
    cursor: pointer;
    font-size: 24px;
    font-weight: bold;
    color: #004025;
  }

  .home-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .home-grid {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 0 10px;
  }

  .home-card {
    background: #fff;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    min-height: 140px;
    justify-content: center;
    position: relative;
  }

  .home-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .home-card-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: var(--ok);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
  }

  .home-card-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .home-card-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  /* Side menu */
  .side-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100vh;
    background: #fff;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 400;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
  }

  .side-menu.open {
    transform: translateX(0);
  }

  .side-menu-header {
    background: var(--accent);
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .side-menu-close {
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .side-menu-title {
    font-size: 16px;
    font-weight: 600;
  }

  .side-menu-content {
    padding: 0;
  }

  .side-menu-section {
    border-bottom: 1px solid #eee;
  }

  .side-menu-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 16px 20px;
    color: #333;
    cursor: pointer;
    transition: background-color 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 16px;
    min-height: 56px;
  }

  .side-menu-item:hover {
    background: #f8f9fa;
  }

  .side-menu-item-icon {
    width: 24px;
    text-align: center;
    font-size: 18px;
  }

  .menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 350;
  }

  .menu-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* App interface */
  .app-interface {
    background: var(--bg);
    display: flex;
    flex-direction: column;
  }

  .app-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    color: white;
  }

  .app-header-left {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .menu-logo {
    height: 32px;
    cursor: pointer;
    filter: invert(1);
  }

  .back-btn {
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .app-title {
    font-size: 16px;
    font-weight: 600;
  }

  .app-actions {
    display: flex;
    gap: 8px;
  }

  .app-btn {
    background: none;
    border: none;
    color: white;
    font-size: 11px;
    padding: 8px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    min-width: 44px;
    min-height: 44px;
  }

  .app-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .canvas-area {
    flex: 1;
    background: #0a0b0e;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  #canvas {
    max-width: 100%;
    max-height: 100%;
    border: 1px solid var(--muted);
    touch-action: none;
  }

  .floating-controls {
    position: fixed;
    bottom: 140px;
    right: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 130;
  }

  .float-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--panel);
    backdrop-filter: blur(10px);
    border: 1px solid var(--muted);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
    min-width: 44px;
    min-height: 44px;
  }

  .float-btn:hover {
    background: var(--accent);
    color: #fff;
    transform: scale(1.05);
  }

  .laser-control {
    position: fixed;
    bottom: 140px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 130;
  }

  .laser-btn {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #333;
    border: 4px solid #555;
    color: #fff;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    transition: all 0.2s ease;
  }

  .laser-btn.connected {
    background: var(--accent);
    border-color: #006635;
    color: #fff;
  }

  .laser-btn.measuring {
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  .measurement-history {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 120px;
    background: var(--panel);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--muted);
    z-index: 140;
    display: flex;
    flex-direction: column;
  }

  .history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--muted);
  }

  .history-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--sub);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .clear-history-btn {
    background: none;
    border: none;
    color: var(--sub);
    font-size: 11px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    min-height: 32px;
  }

  .clear-history-btn:hover {
    background: var(--muted);
    color: var(--text);
  }

  .history-list {
    flex: 1;
    overflow-x: auto;
    padding: 8px 16px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .history-item {
    background: var(--muted);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    transition: all 0.2s ease;
    min-height: 36px;
    display: flex;
    align-items: center;
  }

  .history-item:hover {
    background: var(--accent);
    color: #fff;
    transform: translateY(-1px);
  }

  /* Source chooser */
  .source-chooser {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    min-width: 280px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .source-chooser.visible {
    opacity: 1;
    visibility: visible;
  }

  .chooser-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 20px;
    text-align: center;
  }

  .chooser-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .chooser-btn {
    padding: 16px 20px;
    border: 1px solid var(--muted);
    border-radius: 8px;
    background: var(--muted);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    min-height: 56px;
  }

  .chooser-btn:hover {
    background: var(--accent);
    color: #fff;
    transform: translateY(-1px);
  }

  .chooser-btn-icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
  }

  /* Capture screen */
  .capture-screen {
    background: var(--bg);
    display: none;
    flex-direction: column;
    z-index: 275;
  }

  .capture-screen.visible {
    display: flex;
  }

  .capture-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 15px;
  }

  .capture-title {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
  }

  .capture-preview {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    position: relative;
  }

  .capture-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .capture-actions {
    padding: 20px;
    display: flex;
    gap: 12px;
    background: var(--panel);
  }

  .capture-btn {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 56px;
  }

  .capture-btn.secondary {
    background: var(--muted);
    color: var(--text);
  }

  .capture-btn.primary {
    background: var(--accent);
    color: #fff;
  }

  /* Keypad */
  .keypad {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    width: 320px;
    max-width: 90vw;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .keypad.visible {
    opacity: 1;
    visibility: visible;
  }

  .keypad-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .keypad-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .keypad-close {
    background: none;
    border: none;
    color: var(--sub);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .keypad-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .keypad-input {
    padding: 12px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    font-size: 14px;
    min-height: 44px;
    text-align: center;
  }

  .keypad-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0, 64, 37, 0.2);
  }

  .keypad-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .keypad-btn {
    padding: 12px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .keypad-btn.primary {
    background: var(--accent);
    color: #fff;
  }

  .keypad-btn.secondary {
    background: var(--muted);
    color: var(--text);
  }

  /* Other screens */
  .other-screen {
    background: var(--bg);
    display: none;
    flex-direction: column;
    z-index: 250;
  }

  .other-screen.visible {
    display: flex;
  }

  .other-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    padding: 0 15px;
    gap: 15px;
  }

  .other-back {
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .other-title {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    flex: 1;
  }

  .other-add {
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .other-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .section {
    margin-bottom: 30px;
  }

  .section h3 {
    margin: 0 0 15px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--sub);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .item-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .list-item {
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .list-item:hover {
    background: rgba(0, 64, 37, 0.1);
    transform: translateY(-1px);
  }

  .item-icon {
    width: 48px;
    height: 48px;
    background: var(--muted);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .item-details {
    flex: 1;
  }

  .item-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin: 0 0 4px 0;
  }

  .item-meta {
    font-size: 12px;
    color: var(--sub);
  }

  .item-actions {
    display: flex;
    gap: 8px;
  }

  .item-action-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--muted);
    border: none;
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .item-action-btn:hover {
    background: var(--accent);
    color: #fff;
  }

  .item-action-btn.danger:hover {
    background: var(--danger);
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--sub);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Settings specific */
  .settings-section {
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    margin-bottom: 20px;
    padding: 20px;
  }

  .settings-section h3 {
    margin: 0 0 16px 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--accent);
  }

  .logo-upload {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
  }

  .logo-upload:last-child {
    margin-bottom: 0;
  }

  .settings-label {
    font-size: 14px;
    color: var(--text);
    margin-bottom: 8px;
    font-weight: 600;
  }

  .logo-preview-container {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-preview {
    width: 80px;
    height: 80px;
    border: 2px dashed var(--muted);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .logo-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .logo-preview-placeholder {
    color: var(--sub);
    font-size: 12px;
    text-align: center;
  }

  .logo-actions {
    display: flex;
    gap: 8px;
    flex-direction: column;
  }

  .logo-btn {
    padding: 8px 12px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: var(--muted);
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 36px;
  }

  .logo-btn:hover {
    background: var(--accent);
    color: #fff;
  }

  .logo-btn.danger {
    background: var(--danger);
    color: #fff;
  }

  .device-card {
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
  }

  .device-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 16px;
  }

  .device-details h3 {
    margin: 0 0 4px 0;
    font-size: 16px;
    color: var(--text);
  }

  .device-status {
    font-size: 12px;
    color: var(--sub);
  }

  .device-status.connected {
    color: var(--accent);
    font-weight: 600;
  }

  .device-actions {
    display: flex;
    gap: 12px;
  }

  .device-btn {
    padding: 10px 16px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: var(--muted);
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .device-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  .device-btn:hover {
    transform: translateY(-1px);
  }

  .device-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .auto-connect-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 16px;
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
  }

  .toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
    background: var(--muted);
    border-radius: 13px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .toggle-switch.active {
    background: var(--accent);
  }

  .toggle-knob {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 22px;
    height: 22px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.2s ease;
  }

  .toggle-switch.active .toggle-knob {
    transform: translateX(24px);
  }

  /* Context menu */
  .context-menu {
    position: fixed;
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 8px 0;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transform: scale(0.95);
    transition: all 0.2s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    min-width: 180px;
  }

  .context-menu.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }

  .context-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: var(--text);
    cursor: pointer;
    transition: background-color 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 14px;
    min-height: 44px;
  }

  .context-menu-item:hover {
    background: rgba(0, 64, 37, 0.1);
  }

  .context-menu-item.danger:hover {
    background: rgba(255, 107, 107, 0.1);
    color: var(--danger);
  }

  /* Toast */
  .toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 16px 20px;
    z-index: 300;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    max-width: 90vw;
    text-align: center;
  }

  .toast.visible {
    opacity: 1;
    visibility: visible;
  }

  .toast.error {
    border-color: var(--danger);
    background: rgba(255, 107, 107, 0.1);
  }

  .toast.info {
    border-color: var(--accent);
    background: rgba(0, 64, 37, 0.1);
  }

  .toast.warning {
    border-color: #ffd166;
    background: rgba(255, 209, 102, 0.1);
  }

  .export-dialog {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    opacity: 0;
    visibility: hidden;
    transform: translate(-50%, 50%) scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    min-width: 280px;
  }

  .export-dialog.visible {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, 50%) scale(1);
  }

  .export-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
    text-align: center;
  }

  .export-input {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    font-size: 14px;
    margin-bottom: 20px;
  }

  .export-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0, 64, 37, 0.2);
  }

  .export-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .hidden-input {
    position: absolute;
    left: -9999px;
    opacity: 0;
  }

  @media (max-width: 480px) {
    .home-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .keypad {
      width: 95vw;
      padding: 20px;
    }
    
    .keypad-inputs {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .app-actions {
      gap: 4px;
    }
    
    .app-btn {
      min-width: 40px;
      font-size: 10px;
      padding: 6px 8px;
    }
  }
</style>
</head>
<body>
  <!-- Home Screen -->
  <div id="homeScreen" class="screen home-screen">
    <div class="home-header">
      <div class="home-logo" id="homeMenuBtn">EMRYN</div>
      <div class="home-title">Home</div>
    </div>
    
    <div class="home-grid">
      <div class="home-card" id="sketchCard">
        <div class="home-card-badge">FREE</div>
        <div class="home-card-icon">📏</div>
        <h3 class="home-card-title">Sketch on Photo</h3>
      </div>
      
      <div class="home-card" id="organizerCard">
        <div class="home-card-badge">FREE</div>
        <div class="home-card-icon">📁</div>
        <h3 class="home-card-title">Organiser</h3>
      </div>
    </div>
  </div>

  <!-- Menu overlay -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- Side menu -->
  <div class="side-menu" id="sideMenu">
    <div class="side-menu-header">
      <div class="side-menu-close" id="sideMenuClose">✕</div>
      <div class="side-menu-title">Menu</div>
    </div>
    
    <div class="side-menu-content">
      <div class="side-menu-section">
        <button class="side-menu-item" id="menuSketchPhoto">
          <div class="side-menu-item-icon">📏</div>
          <span>Sketch on Photo</span>
        </button>
        <button class="side-menu-item" id="menuOrganiser">
          <div class="side-menu-item-icon">📁</div>
          <span>Organiser</span>
        </button>
      </div>
      
      <div class="side-menu-section">
        <button class="side-menu-item" id="menuMyDevices">
          <div class="side-menu-item-icon">📱</div>
          <span>My Devices</span>
        </button>
        <button class="side-menu-item" id="menuSettings">
          <div class="side-menu-item-icon">⚙️</div>
          <span>Settings</span>
        </button>
      </div>
    </div>
  </div>

  <!-- App Interface -->
  <div id="appScreen" class="screen app-interface hidden">
    <div class="app-header">
      <div class="app-header-left">
        <div class="menu-logo" id="menuLogo">EMRYN</div>
        <div class="back-btn" id="backBtn">←</div>
      </div>
      
      <div class="app-title" id="appTitle">New Project</div>
      
      <div class="app-actions">
        <button class="app-btn" id="exportBtn">
          <div>↗</div>
          <div>Export</div>
        </button>
        <button class="app-btn" id="undoBtn">
          <div>↶</div>
          <div>Undo</div>
        </button>
        <button class="app-btn" id="newBtn">
          <div>🔄</div>
          <div>New</div>
        </button>
      </div>
    </div>
    
    <div class="canvas-area">
      <canvas id="canvas"></canvas>
    </div>
    
    <div class="floating-controls">
      <button class="float-btn" id="lineToolBtn" title="Draw Line" aria-label="Draw Line">✏️</button>
      <button class="float-btn" id="manualMeasureBtn" title="Manual Entry" aria-label="Manual Entry">📏</button>
    </div>
    
    <div class="laser-control">
      <button class="laser-btn" id="laserBtn" aria-label="Laser Measure">
        <div style="font-size: 10px;">LASER</div>
        <div id="laserStatus">OFF</div>
      </button>
    </div>
    
    <div class="measurement-history">
      <div class="history-header">
        <div class="history-title">Recent Measurements</div>
        <button class="clear-history-btn" id="clearHistoryBtn">Clear</button>
      </div>
      <div class="history-list" id="historyList">
        <div style="color: var(--sub); font-size: 11px; text-align: center; width: 100%;">
          Measurements from laser or manual entry will appear here
        </div>
      </div>
    </div>
  </div>

  <!-- Organizer Screen -->
  <div id="organizerScreen" class="screen other-screen">
    <div class="other-header">
      <div class="other-back" id="organizerBack">←</div>
      <div class="other-title">Organiser</div>
      <div class="other-add" id="organizerAdd">+</div>
    </div>
    
    <div class="other-content">
      <div class="section">
        <h3>Recently Opened</h3>
        <div class="item-list" id="recentProjectsList">
          <div class="empty-state">
            <div class="empty-state-icon">📄</div>
            <div>No recent projects</div>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h3>All Projects</h3>
        <div class="item-list" id="allProjectsList">
          <div class="empty-state">
            <div class="empty-state-icon">📂</div>
            <div>No projects yet. Tap + to create your first project.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Screen -->
  <div id="settingsScreen" class="screen other-screen">
    <div class="other-header">
      <div class="other-back" id="settingsBack">←</div>
      <div class="other-title">Settings</div>
    </div>
    
    <div class="other-content">
      <div class="settings-section">
        <h3>Branding</h3>
        
        <div class="logo-upload">
          <div class="settings-label">Menu Logo</div>
          <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">Used as the tappable menu icon throughout the app</div>
          <div class="logo-preview-container">
            <div class="logo-preview" id="menuLogoPreview">
              <div class="logo-preview-placeholder">No logo</div>
            </div>
            <div class="logo-actions">
              <button class="logo-btn" id="menuLogoUpload">Upload</button>
              <button class="logo-btn danger" id="menuLogoRemove">Remove</button>
            </div>
          </div>
        </div>

        <div class="logo-upload">
          <div class="settings-label">Watermark Logo</div>
          <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">Used as corner watermark on exported images</div>
          <div class="logo-preview-container">
            <div class="logo-preview" id="watermarkLogoPreview">
              <div class="logo-preview-placeholder">No logo</div>
            </div>
            <div class="logo-actions">
              <button class="logo-btn" id="watermarkLogoUpload">Upload</button>
              <button class="logo-btn danger" id="watermarkLogoRemove">Remove</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- My Devices Screen -->
  <div id="devicesScreen" class="screen other-screen">
    <div class="other-header">
      <div class="other-back" id="devicesBack">←</div>
      <div class="other-title">My Devices</div>
    </div>
    
    <div class="other-content">
      <div class="auto-connect-toggle">
        <div class="toggle-switch" id="autoConnectToggle">
          <div class="toggle-knob"></div>
        </div>
        <div>
          <div style="font-weight: 600; margin-bottom: 4px;">Auto-connect</div>
          <div style="font-size: 12px; color: var(--sub);">Automatically reconnect to last device</div>
        </div>
      </div>
      
      <div class="device-card">
        <div class="device-info">
          <div class="item-icon">📡</div>
          <div class="device-details">
            <h3>Laser Measure Device</h3>
            <div class="device-status" id="deviceStatus">Not connected</div>
          </div>
        </div>
        <div class="device-actions">
          <button class="device-btn primary" id="connectDeviceBtn">Connect</button>
          <button class="device-btn" id="disconnectDeviceBtn" disabled>Disconnect</button>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 16px; background: var(--panel); border: 1px solid var(--muted); border-radius: 8px;">
        <div style="font-size: 12px; color: var(--sub); line-height: 1.4;">
          <strong>Requirements for Web Bluetooth:</strong><br>
          • HTTPS connection required (not HTTP)<br>
          • Chrome/Edge browser (Safari not supported)<br>
          • Bluetooth permissions enabled<br>
          • Device must be in pairing mode<br><br>
          <strong>Supported devices:</strong><br>
          Leica DISTO series, Bosch GLM series, and other Bluetooth-enabled laser measuring devices.
        </div>
      </div>
    </div>
  </div>

  <!-- Source Chooser -->
  <div id="sourceChooser" class="source-chooser">
    <div class="chooser-title">Select picture</div>
    <div class="chooser-buttons">
      <button class="chooser-btn" id="chooserCamera" aria-label="Open Camera">
        <div class="chooser-btn-icon">📷</div>
        <span>Camera</span>
      </button>
      <button class="chooser-btn" id="chooserGallery" aria-label="Open Photo Library">
        <div class="chooser-btn-icon">🖼</div>
        <span>Photo Library</span>
      </button>
      <button class="chooser-btn" id="chooserPdf" aria-label="Open PDF">
        <div class="chooser-btn-icon">📄</div>
        <span>PDF</span>
      </button>
      <button class="chooser-btn" id="chooserCancel" aria-label="Cancel" style="background: var(--muted); margin-top: 12px;">
        <div class="chooser-btn-icon">✕</div>
        <span>Cancel</span>
      </button>
    </div>
  </div>

  <!-- Capture Screen -->
  <div id="captureScreen" class="screen capture-screen">
    <div class="capture-header">
      <div class="capture-title">Photo Captured</div>
    </div>
    
    <div class="capture-preview">
      <img class="capture-image" id="captureImage" alt="Captured photo">
    </div>
    
    <div class="capture-actions">
      <button class="capture-btn secondary" id="retakeBtn">Retake</button>
      <button class="capture-btn primary" id="usePhotoBtn">Use Photo</button>
    </div>
  </div>

  <!-- Measurement Keypad -->
  <div id="measurementKeypad" class="keypad">
    <div class="keypad-header">
      <div class="keypad-title">Enter Measurement</div>
      <button class="keypad-close" id="keypadClose">✕</button>
    </div>
    
    <div class="keypad-inputs">
      <input class="keypad-input" id="feetInput" type="number" placeholder="ft" min="0" aria-label="Feet">
      <input class="keypad-input" id="inchesInput" type="number" placeholder="in" min="0" max="11" aria-label="Inches">
      <input class="keypad-input" id="numInput" type="number" placeholder="num" min="0" aria-label="Fraction numerator">
      
      <select class="keypad-input" id="denomInput" aria-label="Fraction denominator" style="grid-column: 1 / -1; margin-top: 8px;">
        <option value="2">1/2</option>
        <option value="4">1/4</option>
        <option value="8" selected>1/8</option>
        <option value="16">1/16</option>
        <option value="32">1/32</option>
        <option value="64">1/64</option>
      </select>
    </div>
    
    <div class="keypad-actions">
      <button class="keypad-btn secondary" id="keypadCancel">Cancel</button>
      <button class="keypad-btn primary" id="keypadApply">Apply</button>
    </div>
  </div>

  <!-- Export Dialog -->
  <div id="exportDialog" class="export-dialog">
    <div class="export-title">Export Image</div>
    <input class="export-input" id="exportFilename" type="text" placeholder="Enter filename">
    <div class="export-actions">
      <button class="keypad-btn secondary" id="exportCancel">Cancel</button>
      <button class="keypad-btn primary" id="exportConfirm">Export</button>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="contextMenu" class="context-menu">
    <button class="context-menu-item" id="contextEdit">
      <div>✏️</div>
      <span>Edit Measurement</span>
    </button>
    <button class="context-menu-item" id="contextDuplicate">
      <div>📋</div>
      <span>Duplicate</span>
    </button>
    <button class="context-menu-item" id="contextAddText">
      <div>🅰</div>
      <span>Add Text</span>
    </button>
    <button class="context-menu-item" id="contextMoveToProject">
      <div>📁</div>
      <span>Move to Project</span>
    </button>
    <button class="context-menu-item danger" id="contextDelete">
      <div>🗑</div>
      <span>Delete</span>
    </button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Hidden file inputs -->
  <input type="file" id="fileInput" accept="image/*" class="hidden-input">
  <input type="file" id="pdfInput" accept=".pdf" class="hidden-input">
  <input type="file" id="menuLogoInput" accept="image/*" class="hidden-input">
  <input type="file" id="watermarkLogoInput" accept="image/*" class="hidden-input">

  <script>
    // Global app state
    const APP = {
      currentScreen: 'home',
      currentProject: null,
      currentImage: null,
      shapes: [],
      selectedShape: null,
      measurements: [],
      projects: JSON.parse(localStorage.getItem('emryn_projects') || '[]'),
      recentProjects: JSON.parse(localStorage.getItem('emryn_recent_projects') || '[]'),
      branding: {
        menuLogo: localStorage.getItem('emryn_menu_logo'),
        watermarkLogo: localStorage.getItem('emryn_watermark_logo')
      },
      bluetooth: {
        device: null,
        connected: false,
        measuring: false,
        autoConnect: JSON.parse(localStorage.getItem('emryn_auto_connect') || 'false')
      },
      capturedImageData: null,
      dragging: null
    };

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      showScreen('home');
      updateLogos();
      updateDeviceStatus();
      renderMeasurementHistory();
    });

    function setupEventListeners() {
      // Home screen
      document.getElementById('sketchCard').addEventListener('click', showSourceChooser);
      document.getElementById('organizerCard').addEventListener('click', () => showScreen('organizer'));
      document.getElementById('homeMenuBtn').addEventListener('click', toggleSideMenu);

      // Side menu
      document.getElementById('sideMenuClose').addEventListener('click', () => toggleSideMenu(false));
      document.getElementById('menuOverlay').addEventListener('click', () => toggleSideMenu(false));
      document.getElementById('menuSketchPhoto').addEventListener('click', () => {
        toggleSideMenu(false);
        showSourceChooser();
      });
      document.getElementById('menuOrganiser').addEventListener('click', () => {
        toggleSideMenu(false);
        showScreen('organizer');
      });
      document.getElementById('menuMyDevices').addEventListener('click', () => {
        toggleSideMenu(false);
        showScreen('devices');
      });
      document.getElementById('menuSettings').addEventListener('click', () => {
        toggleSideMenu(false);
        showScreen('settings');
      });

      // App interface
      document.getElementById('menuLogo').addEventListener('click', toggleSideMenu);
      document.getElementById('backBtn').addEventListener('click', () => showScreen('home'));
      document.getElementById('exportBtn').addEventListener('click', showExportDialog);
      document.getElementById('undoBtn').addEventListener('click', undo);
      document.getElementById('newBtn').addEventListener('click', showSourceChooser);

      // Tools
      document.getElementById('lineToolBtn').addEventListener('click', () => setTool('line'));
      document.getElementById('manualMeasureBtn').addEventListener('click', showMeasurementKeypad);
      document.getElementById('laserBtn').addEventListener('click', handleLaserClick);

      // Source chooser
      document.getElementById('chooserCamera').addEventListener('click', openCamera);
      document.getElementById('chooserGallery').addEventListener('click', openGallery);
      document.getElementById('chooserPdf').addEventListener('click', openPdf);
      document.getElementById('chooserCancel').addEventListener('click', hideSourceChooser);

      // Capture screen
      document.getElementById('retakeBtn').addEventListener('click', retakePhoto);
      document.getElementById('usePhotoBtn').addEventListener('click', usePhoto);

      // Measurement keypad
      document.getElementById('keypadClose').addEventListener('click', hideMeasurementKeypad);
      document.getElementById('keypadCancel').addEventListener('click', hideMeasurementKeypad);
      document.getElementById('keypadApply').addEventListener('click', applyMeasurement);

      // Export dialog
      document.getElementById('exportCancel').addEventListener('click', hideExportDialog);
      document.getElementById('exportConfirm').addEventListener('click', confirmExport);

      // Organizer
      document.getElementById('organizerBack').addEventListener('click', () => showScreen('home'));
      document.getElementById('organizerAdd').addEventListener('click', addNewProject);

      // Settings
      document.getElementById('settingsBack').addEventListener('click', () => showScreen('home'));
      document.getElementById('menuLogoUpload').addEventListener('click', () => {
        document.getElementById('menuLogoInput').click();
      });
      document.getElementById('watermarkLogoUpload').addEventListener('click', () => {
        document.getElementById('watermarkLogoInput').click();
      });
      document.getElementById('menuLogoRemove').addEventListener('click', () => removeLogo('menu'));
      document.getElementById('watermarkLogoRemove').addEventListener('click', () => removeLogo('watermark'));

      // Devices
      document.getElementById('devicesBack').addEventListener('click', () => showScreen('home'));
      document.getElementById('connectDeviceBtn').addEventListener('click', connectBluetooth);
      document.getElementById('disconnectDeviceBtn').addEventListener('click', disconnectBluetooth);
      document.getElementById('autoConnectToggle').addEventListener('click', toggleAutoConnect);

      // Context menu
      document.getElementById('contextEdit').addEventListener('click', () => {
        hideContextMenu();
        showMeasurementKeypad();
      });
      document.getElementById('contextDuplicate').addEventListener('click', () => {
        hideContextMenu();
        duplicateSelected();
      });
      document.getElementById('contextAddText').addEventListener('click', () => {
        hideContextMenu();
        addTextToSelected();
      });
      document.getElementById('contextMoveToProject').addEventListener('click', () => {
        hideContextMenu();
        showMoveToProjectDialog();
      });
      document.getElementById('contextDelete').addEventListener('click', () => {
        hideContextMenu();
        deleteSelected();
      });

      // History
      document.getElementById('clearHistoryBtn').addEventListener('click', clearMeasurementHistory);

      // File inputs
      document.getElementById('fileInput').addEventListener('change', handleFileInput);
      document.getElementById('pdfInput').addEventListener('change', handlePdfInput);
      document.getElementById('menuLogoInput').addEventListener('change', (e) => handleLogoUpload(e, 'menu'));
      document.getElementById('watermarkLogoInput').addEventListener('change', (e) => handleLogoUpload(e, 'watermark'));

      // Canvas interactions
      setupCanvasEvents();

      // Close overlays on outside click
      document.addEventListener('click', (e) => {
        const contextMenu = document.getElementById('contextMenu');
        if (contextMenu.classList.contains('visible') && !contextMenu.contains(e.target)) {
          hideContextMenu();
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          hideContextMenu();
          hideMeasurementKeypad();
          hideSourceChooser();
          hideExportDialog();
        }
        if (e.key === 'Delete' && APP.selectedShape) {
          deleteSelected();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
          e.preventDefault();
          undo();
        }
      });
    }

    // Screen management
    function showScreen(screen) {
      // Hide all screens
      document.getElementById('homeScreen').classList.toggle('hidden', screen !== 'home');
      document.getElementById('appScreen').classList.toggle('hidden', screen !== 'app');
      document.getElementById('organizerScreen').classList.toggle('visible', screen === 'organizer');
      document.getElementById('settingsScreen').classList.toggle('visible', screen === 'settings');
      document.getElementById('devicesScreen').classList.toggle('visible', screen === 'devices');
      document.getElementById('captureScreen').classList.toggle('visible', screen === 'capture');

      APP.currentScreen = screen;

      // Update screen content
      if (screen === 'organizer') {
        renderProjects();
      } else if (screen === 'settings') {
        updateLogoPreviewsInSettings();
      } else if (screen === 'devices') {
        updateDeviceStatus();
      }
    }

    function toggleSideMenu(show) {
      const sideMenu = document.getElementById('sideMenu');
      const menuOverlay = document.getElementById('menuOverlay');
      
      if (show === undefined) {
        show = !sideMenu.classList.contains('open');
      }
      
      sideMenu.classList.toggle('open', show);
      menuOverlay.classList.toggle('visible', show);
    }

    // Source chooser functionality
    function showSourceChooser() {
      document.getElementById('sourceChooser').classList.add('visible');
    }

    function hideSourceChooser() {
      document.getElementById('sourceChooser').classList.remove('visible');
    }

    async function openCamera() {
      hideSourceChooser();
      
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showToast('Camera not available on this device', 'error');
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;

        video.addEventListener('loadedmetadata', () => {
          setTimeout(() => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0);
            const imageSrc = canvas.toDataURL('image/jpeg', 0.9);
            
            stream.getTracks().forEach(track => track.stop());
            
            APP.capturedImageData = imageSrc;
            document.getElementById('captureImage').src = imageSrc;
            showScreen('capture');
          }, 100);
        });
        
        showToast('Camera opened - capturing photo...', 'info');
        
      } catch (error) {
        console.error('Camera error:', error);
        showToast(`Camera access failed: ${error.message}`, 'error');
      }
    }

    function openGallery() {
      hideSourceChooser();
      document.getElementById('fileInput').click();
    }

    function openPdf() {
      hideSourceChooser();
      document.getElementById('pdfInput').click();
    }

    function retakePhoto() {
      openCamera();
    }

    function usePhoto() {
      if (APP.capturedImageData) {
        loadImageFromData(APP.capturedImageData);
        showScreen('app');
      }
    }

    // File handling
    function handleFileInput(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (event) => {
          loadImageFromData(event.target.result);
          showScreen('app');
        };
        reader.readAsDataURL(file);
      } else if (file) {
        showToast('Please select an image file', 'error');
      }
      e.target.value = '';
    }

    function handlePdfInput(e) {
      const file = e.target.files[0];
      if (file) {
        showToast('PDF support coming soon', 'info');
      }
      e.target.value = '';
    }

    function loadImageFromData(imageSrc) {
      const img = new Image();
      img.onload = () => {
        APP.currentImage = img;
        APP.shapes = [];
        APP.selectedShape = null;
        
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // Resize canvas to fit image
        const maxWidth = window.innerWidth - 40;
        const maxHeight = window.innerHeight - 320;
        const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
        
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;
        
        // Draw image
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        showToast('Image loaded. Use tools to add measurements.', 'info');
      };
      img.src = imageSrc;
    }

    // Canvas interactions
    function setupCanvasEvents() {
      const canvas = document.getElementById('canvas');
      let isDrawing = false;
      let startPoint = null;

      function getEventPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        return {
          x: (clientX - rect.left) / rect.width * canvas.width,
          y: (clientY - rect.top) / rect.height * canvas.height
        };
      }

      function handleStart(e) {
        e.preventDefault();
        const pos = getEventPos(e);
        
        // Check if clicking on existing shape
        const clickedShape = findShapeAt(pos);
        if (clickedShape) {
          APP.selectedShape = clickedShape;
          redrawCanvas();
          
          // Show context menu on right click or long press
          if (e.type === 'contextmenu' || (e.type === 'touchstart' && e.touches.length === 1)) {
            setTimeout(() => {
              if (!isDrawing) {
                showContextMenu(e.clientX || e.touches[0].clientX, e.clientY || e.touches[0].clientY);
              }
            }, 500);
          }
          return;
        }

        // Start drawing new shape
        startPoint = pos;
        isDrawing = true;
        APP.selectedShape = null;
        hideContextMenu();
        redrawCanvas();
      }

      function handleMove(e) {
        if (!isDrawing || !startPoint) return;
        e.preventDefault();
        
        const pos = getEventPos(e);
        redrawCanvas();
        
        // Draw preview line
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#1e90ff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(startPoint.x, startPoint.y);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
      }

      function handleEnd(e) {
        if (!isDrawing || !startPoint) return;
        e.preventDefault();
        
        const pos = getEventPos(e);
        const distance = Math.sqrt(
          Math.pow(pos.x - startPoint.x, 2) + 
          Math.pow(pos.y - startPoint.y, 2)
        );
        
        if (distance > 20) {
          // Create new measurement
          const shape = {
            id: Date.now(),
            endpoints: [startPoint, pos],
            value: formatMeasurement(distance * 0.1), // Placeholder conversion
            callout: {
              x: (startPoint.x + pos.x) / 2,
              y: (startPoint.y + pos.y) / 2 - 30
            },
            style: {
              color: '#1e90ff',
              lineWidth: 2
            }
          };
          
          APP.shapes.push(shape);
          redrawCanvas();
          showToast('Measurement added. Click to edit value.', 'info');
        }
        
        isDrawing = false;
        startPoint = null;
      }

      // Mouse events
      canvas.addEventListener('mousedown', handleStart);
      canvas.addEventListener('mousemove', handleMove);
      canvas.addEventListener('mouseup', handleEnd);
      canvas.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        const pos = getEventPos(e);
        const shape = findShapeAt(pos);
        if (shape) {
          APP.selectedShape = shape;
          showContextMenu(e.clientX, e.clientY);
          redrawCanvas();
        }
      });

      // Touch events
      canvas.addEventListener('touchstart', handleStart);
      canvas.addEventListener('touchmove', handleMove);
      canvas.addEventListener('touchend', handleEnd);
    }

    function findShapeAt(point) {
      for (let i = APP.shapes.length - 1; i >= 0; i--) {
        const shape = APP.shapes[i];
        
        // Check callout
        if (isPointInCallout(point, shape)) {
          return shape;
        }
        
        // Check line
        if (isPointOnLine(point, shape.endpoints[0], shape.endpoints[1])) {
          return shape;
        }
      }
      return null;
    }

    function isPointInCallout(point, shape) {
      if (!shape.callout) return false;
      const callout = shape.callout;
      const textWidth = shape.value.length * 8 + 16;
      const textHeight = 24;
      
      return point.x >= callout.x - textWidth/2 && 
             point.x <= callout.x + textWidth/2 &&
             point.y >= callout.y - textHeight/2 && 
             point.y <= callout.y + textHeight/2;
    }

    function isPointOnLine(point, start, end) {
      const dist = distanceToLineSegment(point, start, end);
      return dist < 15;
    }

    function distanceToLineSegment(point, start, end) {
      const A = point.x - start.x;
      const B = point.y - start.y;
      const C = end.x - start.x;
      const D = end.y - start.y;

      const dot = A * C + B * D;
      const lenSq = C * C + D * D;
      
      if (lenSq === 0) return Math.sqrt(A * A + B * B);
      
      let param = dot / lenSq;
      param = Math.max(0, Math.min(1, param));
      
      const xx = start.x + param * C;
      const yy = start.y + param * D;
      
      const dx = point.x - xx;
      const dy = point.y - yy;
      
      return Math.sqrt(dx * dx + dy * dy);
    }

    function redrawCanvas() {
      if (!APP.currentImage) return;
      
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      // Clear and redraw image
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(APP.currentImage, 0, 0, canvas.width, canvas.height);
      
      // Draw shapes
      APP.shapes.forEach(shape => {
        drawShape(ctx, shape);
      });
    }

    function drawShape(ctx, shape) {
      const [start, end] = shape.endpoints;
      
      // Draw main line
      ctx.strokeStyle = shape.style.color;
      ctx.lineWidth = shape.style.lineWidth;
      if (shape === APP.selectedShape) {
        ctx.strokeStyle = '#ffff00';
        ctx.lineWidth = shape.style.lineWidth + 2;
      }
      
      ctx.beginPath();
      ctx.moveTo(start.x, start.y);
      ctx.lineTo(end.x, end.y);
      ctx.stroke();
      
      // Draw callout
      if (shape.callout) {
        // Leader line
        ctx.strokeStyle = shape.style.color;
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo((start.x + end.x) / 2, (start.y + end.y) / 2);
        ctx.lineTo(shape.callout.x, shape.callout.y);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Callout box
        const text = shape.value;
        ctx.font = '12px Arial';
        const textWidth = ctx.measureText(text).width;
        const padding = 8;
        const boxWidth = textWidth + padding * 2;
        const boxHeight = 20;
        
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.fillRect(
          shape.callout.x - boxWidth/2, 
          shape.callout.y - boxHeight/2, 
          boxWidth, 
          boxHeight
        );
        
        ctx.strokeStyle = shape.style.color;
        ctx.lineWidth = 1;
        ctx.strokeRect(
          shape.callout.x - boxWidth/2, 
          shape.callout.y - boxHeight/2, 
          boxWidth, 
          boxHeight
        );
        
        // Text
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, shape.callout.x, shape.callout.y);
      }
    }

    // Measurement functionality
    function showMeasurementKeypad() {
      // Clear inputs
      document.getElementById('feetInput').value = '';
      document.getElementById('inchesInput').value = '';
      document.getElementById('numInput').value = '';
      document.getElementById('denomInput').value = '8';
      
      // Pre-fill if editing
      if (APP.selectedShape) {
        const measurement = parseMeasurement(APP.selectedShape.value);
        document.getElementById('feetInput').value = measurement.feet || '';
        document.getElementById('inchesInput').value = measurement.inches || '';
        document.getElementById('numInput').value = measurement.numerator || '';
        document.getElementById('denomInput').value = measurement.denominator || 8;
      }
      
      document.getElementById('measurementKeypad').classList.add('visible');
    }

    function hideMeasurementKeypad() {
      document.getElementById('measurementKeypad').classList.remove('visible');
    }

    function applyMeasurement() {
      const feet = parseInt(document.getElementById('feetInput').value) || 0;
      const inches = parseInt(document.getElementById('inchesInput').value) || 0;
      const numerator = parseInt(document.getElementById('numInput').value) || 0;
      const denominator = parseInt(document.getElementById('denomInput').value) || 8;
      
      // Calculate total inches
      const totalInches = feet * 12 + inches + numerator / denominator;
      
      // Format measurement
      const formatted = formatMeasurement(totalInches);
      
      if (APP.selectedShape) {
        // Update existing measurement
        APP.selectedShape.value = formatted;
        redrawCanvas();
      } else {
        // Add to measurement history
        addToMeasurementHistory(formatted);
      }
      
      hideMeasurementKeypad();
      showToast(`Measurement: ${formatted}`, 'info');
    }

    function formatMeasurement(inches) {
      const feet = Math.floor(inches / 12);
      const remainingInches = inches % 12;
      const wholeInches = Math.floor(remainingInches);
      const fraction = remainingInches - wholeInches;
      
      let result = '';
      if (feet > 0) result += feet + "'";
      if (wholeInches > 0) result += wholeInches + '"';
      if (fraction > 0.01) {
        const fractionStr = decimalToFraction(fraction);
        if (fractionStr) result += fractionStr + '"';
      }
      
      return result || '0"';
    }

    function decimalToFraction(decimal) {
      const denominators = [64, 32, 16, 8, 4, 2];
      for (const denom of denominators) {
        const num = Math.round(decimal * denom);
        if (Math.abs(decimal - num / denom) < 0.01 && num > 0) {
          return ` ${num}/${denom}`;
        }
      }
      return '';
    }

    function parseMeasurement(measurement) {
      const result = {feet: 0, inches: 0, numerator: 0, denominator: 8};
      
      const feetMatch = measurement.match(/(\d+)'/);
      if (feetMatch) result.feet = parseInt(feetMatch[1]);
      
      const inchMatch = measurement.match(/(\d+)"/);
      if (inchMatch) result.inches = parseInt(inchMatch[1]);
      
      const fractionMatch = measurement.match(/(\d+)\/(\d+)"/);
      if (fractionMatch) {
        result.numerator = parseInt(fractionMatch[1]);
        result.denominator = parseInt(fractionMatch[2]);
      }
      
      return result;
    }

    function addToMeasurementHistory(measurement) {
      APP.measurements.unshift(measurement);
      APP.measurements = APP.measurements.slice(0, 10);
      renderMeasurementHistory();
    }

    function renderMeasurementHistory() {
      const historyList = document.getElementById('historyList');
      
      if (APP.measurements.length === 0) {
        historyList.innerHTML = '<div style="color: var(--sub); font-size: 11px; text-align: center; width: 100%;">Measurements from laser or manual entry will appear here</div>';
        return;
      }
      
      historyList.innerHTML = '';
      APP.measurements.forEach(measurement => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.textContent = measurement;
        item.addEventListener('click', () => {
          if (APP.selectedShape) {
            APP.selectedShape.value = measurement;
            redrawCanvas();
            showToast('Measurement updated', 'info');
          }
        });
        historyList.appendChild(item);
      });
    }

    function clearMeasurementHistory() {
      APP.measurements = [];
      renderMeasurementHistory();
      showToast('History cleared', 'info');
    }

    // Context menu
    function showContextMenu(x, y) {
      const contextMenu = document.getElementById('contextMenu');
      contextMenu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
      contextMenu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
      contextMenu.classList.add('visible');
    }

    function hideContextMenu() {
      document.getElementById('contextMenu').classList.remove('visible');
    }

    function duplicateSelected() {
      if (!APP.selectedShape) return;
      
      const shape = APP.selectedShape;
      const newShape = {
        id: Date.now(),
        endpoints: [
          {x: shape.endpoints[0].x + 20, y: shape.endpoints[0].y + 20},
          {x: shape.endpoints[1].x + 20, y: shape.endpoints[1].y + 20}
        ],
        value: shape.value,
        callout: {
          x: shape.callout.x + 20,
          y: shape.callout.y + 20
        },
        style: {...shape.style}
      };
      
      APP.shapes.push(newShape);
      APP.selectedShape = newShape;
      redrawCanvas();
      showToast('Measurement duplicated', 'info');
    }

    function addTextToSelected() {
      if (!APP.selectedShape) return;
      
      const text = prompt('Enter text label:', APP.selectedShape.value);
      if (text !== null && text.trim()) {
        APP.selectedShape.value = text.trim();
        redrawCanvas();
        showToast('Text updated', 'info');
      }
    }

    function showMoveToProjectDialog() {
      if (APP.projects.length === 0) {
        showToast('No projects available. Create a project first.', 'info');
        return;
      }
      
      const projectNames = APP.projects.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
      const choice = prompt(`Move to project:\n${projectNames}\n\nEnter project number:`);
      
      if (choice && !isNaN(choice)) {
        const index = parseInt(choice) - 1;
        if (index >= 0 && index < APP.projects.length) {
          const project = APP.projects[index];
          showToast(`Moved to project: ${project.name}`, 'info');
        }
      }
    }

    function deleteSelected() {
      if (!APP.selectedShape) return;
      
      const index = APP.shapes.indexOf(APP.selectedShape);
      if (index >= 0) {
        APP.shapes.splice(index, 1);
        APP.selectedShape = null;
        redrawCanvas();
        showToast('Measurement deleted', 'info');
      }
    }

    function undo() {
      if (APP.shapes.length > 0) {
        APP.shapes.pop();
        APP.selectedShape = null;
        redrawCanvas();
        showToast('Undid last action', 'info');
      }
    }

    function setTool(tool) {
      APP.selectedShape = null;
      redrawCanvas();
    }

    // Project management
    function addNewProject() {
      const name = prompt('Project name:');
      if (name && name.trim()) {
        const project = {
          id: Date.now(),
          name: name.trim(),
          createdAt: new Date().toISOString(),
          lastOpened: new Date().toISOString()
        };
        
        APP.projects.unshift(project);
        addToRecentProjects(project);
        saveSettings();
        renderProjects();
        showToast(`Created project: ${name}`, 'info');
      }
    }

    function addToRecentProjects(project) {
      APP.recentProjects = APP.recentProjects.filter(p => p.id !== project.id);
      APP.recentProjects.unshift(project);
      APP.recentProjects = APP.recentProjects.slice(0, 5);
    }

    function renderProjects() {
      renderProjectList('recentProjectsList', APP.recentProjects, 'No recent projects');
      renderProjectList('allProjectsList', APP.projects, 'No projects yet. Tap + to create your first project.');
    }

    function renderProjectList(containerId, projects, emptyMessage) {
      const container = document.getElementById(containerId);
      
      if (projects.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">${containerId === 'recentProjectsList' ? '📄' : '📂'}</div>
            <div>${emptyMessage}</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      projects.forEach(project => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
          <div class="item-icon">📄</div>
          <div class="item-details">
            <div class="item-name">${project.name}</div>
            <div class="item-meta">${new Date(project.lastOpened).toLocaleDateString()}</div>
          </div>
          <div class="item-actions">
            <button class="item-action-btn" title="Rename" onclick="renameProject('${project.id}')">✏️</button>
            <button class="item-action-btn danger" title="Delete" onclick="deleteProject('${project.id}')">🗑</button>
          </div>
        `;
        
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('item-action-btn')) {
            openProject(project);
          }
        });
        
        container.appendChild(item);
      });
    }

    function openProject(project) {
      APP.currentProject = project;
      project.lastOpened = new Date().toISOString();
      addToRecentProjects(project);
      saveSettings();
      
      document.getElementById('appTitle').textContent = project.name;
      showToast(`Opened project: ${project.name}`, 'info');
      showScreen('app');
    }

    window.renameProject = function(projectId) {
      const project = APP.projects.find(p => p.id == projectId);
      if (!project) return;
      
      const newName = prompt('New project name:', project.name);
      if (newName && newName.trim() && newName.trim() !== project.name) {
        project.name = newName.trim();
        saveSettings();
        renderProjects();
        showToast(`Renamed to: ${newName}`, 'info');
      }
    };

    window.deleteProject = function(projectId) {
      const project = APP.projects.find(p => p.id == projectId);
      if (!project) return;
      
      if (confirm(`Delete project "${project.name}"? This cannot be undone.`)) {
        APP.projects = APP.projects.filter(p => p.id != projectId);
        APP.recentProjects = APP.recentProjects.filter(p => p.id != projectId);
        saveSettings();
        renderProjects();
        showToast(`Deleted project: ${project.name}`, 'info');
      }
    };

    // Logo management
    function handleLogoUpload(event, type) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        
        if (type === 'menu') {
          APP.branding.menuLogo = dataUrl;
          localStorage.setItem('emryn_menu_logo', dataUrl);
        } else if (type === 'watermark') {
          APP.branding.watermarkLogo = dataUrl;
          localStorage.setItem('emryn_watermark_logo', dataUrl);
        }
        
        updateLogos();
        updateLogoPreviewsInSettings();
        showToast(`${type === 'menu' ? 'Menu' : 'Watermark'} logo uploaded`, 'info');
      };
      
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    function removeLogo(type) {
      if (type === 'menu') {
        APP.branding.menuLogo = null;
        localStorage.removeItem('emryn_menu_logo');
      } else if (type === 'watermark') {
        APP.branding.watermarkLogo = null;
        localStorage.removeItem('emryn_watermark_logo');
      }
      
      updateLogos();
      updateLogoPreviewsInSettings();
      showToast(`${type === 'menu' ? 'Menu' : 'Watermark'} logo removed`, 'info');
    }

    function updateLogos() {
      const menuLogos = document.querySelectorAll('#homeMenuBtn, #menuLogo');
      
      menuLogos.forEach(logo => {
        if (APP.branding.menuLogo) {
          if (logo.tagName === 'IMG') {
            logo.src = APP.branding.menuLogo;
          } else {
            logo.style.backgroundImage = `url(${APP.branding.menuLogo})`;
            logo.style.backgroundSize = 'contain';
            logo.style.backgroundRepeat = 'no-repeat';
            logo.style.backgroundPosition = 'center';
            logo.textContent = '';
          }
        } else {
          if (logo.tagName === 'IMG') {
            logo.src = '';
          } else {
            logo.style.backgroundImage = '';
            logo.textContent = 'EMRYN';
          }
        }
      });
    }

    function updateLogoPreviewsInSettings() {
      const menuPreview = document.getElementById('menuLogoPreview');
      const watermarkPreview = document.getElementById('watermarkLogoPreview');
      
      if (APP.branding.menuLogo) {
        menuPreview.innerHTML = `<img src="${APP.branding.menuLogo}" alt="Menu logo">`;
      } else {
        menuPreview.innerHTML = '<div class="logo-preview-placeholder">No logo</div>';
      }
      
      if (APP.branding.watermarkLogo) {
        watermarkPreview.innerHTML = `<img src="${APP.branding.watermarkLogo}" alt="Watermark logo">`;
      } else {
        watermarkPreview.innerHTML = '<div class="logo-preview-placeholder">No logo</div>';
      }
    }

    // Export functionality
    function showExportDialog() {
      const filename = APP.currentProject ? APP.currentProject.name : 'measurement';
      document.getElementById('exportFilename').value = filename;
      document.getElementById('exportDialog').classList.add('visible');
    }

    function hideExportDialog() {
      document.getElementById('exportDialog').classList.remove('visible');
    }

    function confirmExport() {
      const filename = document.getElementById('exportFilename').value.trim();
      if (!filename) {
        showToast('Please enter a filename', 'error');
        return;
      }
      
      exportImage(filename);
      hideExportDialog();
    }

    function exportImage(filename) {
      if (!APP.currentImage || APP.shapes.length === 0) {
        showToast('Add measurements before exporting', 'error');
        return;
      }
      
      const exportCanvas = document.createElement('canvas');
      const exportCtx = exportCanvas.getContext('2d');
      exportCanvas.width = APP.currentImage.width;
      exportCanvas.height = APP.currentImage.height;
      
      // Draw original image
      exportCtx.drawImage(APP.currentImage, 0, 0);
      
      // Scale measurements
      const canvas = document.getElementById('canvas');
      const scaleX = APP.currentImage.width / canvas.width;
      const scaleY = APP.currentImage.height / canvas.height;
      
      APP.shapes.forEach(shape => {
        const scaledStart = {
          x: shape.endpoints[0].x * scaleX,
          y: shape.endpoints[0].y * scaleY
        };
        const scaledEnd = {
          x: shape.endpoints[1].x * scaleX,
          y: shape.endpoints[1].y * scaleY
        };
        const scaledCallout = {
          x: shape.callout.x * scaleX,
          y: shape.callout.y * scaleY
        };
        
        // Draw line
        exportCtx.strokeStyle = shape.style.color;
        exportCtx.lineWidth = shape.style.lineWidth * Math.min(scaleX, scaleY);
        exportCtx.beginPath();
        exportCtx.moveTo(scaledStart.x, scaledStart.y);
        exportCtx.lineTo(scaledEnd.x, scaledEnd.y);
        exportCtx.stroke();
        
        // Draw callout
        if (shape.callout) {
          const fontSize = 16 * Math.min(scaleX, scaleY);
          exportCtx.font = `${fontSize}px Arial`;
          const textWidth = exportCtx.measureText(shape.value).width;
          const padding = 12 * Math.min(scaleX, scaleY);
          
          // Leader line
          exportCtx.strokeStyle = shape.style.color;
          exportCtx.lineWidth = Math.min(scaleX, scaleY);
          exportCtx.setLineDash([5 * Math.min(scaleX, scaleY), 5 * Math.min(scaleX, scaleY)]);
          exportCtx.beginPath();
          exportCtx.moveTo((scaledStart.x + scaledEnd.x) / 2, (scaledStart.y + scaledEnd.y) / 2);
          exportCtx.lineTo(scaledCallout.x, scaledCallout.y);
          exportCtx.stroke();
          exportCtx.setLineDash([]);
          
          // Callout box
          exportCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
          exportCtx.fillRect(
            scaledCallout.x - textWidth/2 - padding,
            scaledCallout.y - fontSize/2 - padding,
            textWidth + padding * 2,
            fontSize + padding * 2
          );
          
          exportCtx.strokeStyle = shape.style.color;
          exportCtx.lineWidth = Math.min(scaleX, scaleY);
          exportCtx.strokeRect(
            scaledCallout.x - textWidth/2 - padding,
            scaledCallout.y - fontSize/2 - padding,
            textWidth + padding * 2,
            fontSize + padding * 2
          );
          
          exportCtx.fillStyle = '#fff';
          exportCtx.textAlign = 'center';
          exportCtx.textBaseline = 'middle';
          exportCtx.fillText(shape.value, scaledCallout.x, scaledCallout.y);
        }
      });
      
      // Add watermark if available
      if (APP.branding.watermarkLogo) {
        const watermarkImg = new Image();
        watermarkImg.onload = () => {
          const watermarkSize = Math.min(exportCanvas.width, exportCanvas.height) * 0.1;
          const margin = 20;
          
          exportCtx.globalAlpha = 0.7;
          exportCtx.drawImage(
            watermarkImg,
            exportCanvas.width - watermarkSize - margin,
            exportCanvas.height - watermarkSize - margin,
            watermarkSize,
            watermarkSize
          );
          exportCtx.globalAlpha = 1;
          
          addTimestamp();
          downloadImage();
        };
        watermarkImg.src = APP.branding.watermarkLogo;
      } else {
        addTimestamp();
        downloadImage();
      }
      
      function addTimestamp() {
        const timestamp = new Date().toLocaleString();
        const fontSize = 14 * Math.min(scaleX, scaleY);
        exportCtx.font = `${fontSize}px Arial`;
        exportCtx.textAlign = 'left';
        exportCtx.textBaseline = 'top';
        
        const textWidth = exportCtx.measureText(timestamp).width;
        const padding = 8 * Math.min(scaleX, scaleY);
        
        exportCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        exportCtx.fillRect(20, 20, textWidth + padding * 2, fontSize + padding * 2);
        
        exportCtx.fillStyle = '#fff';
        exportCtx.fillText(timestamp, 20 + padding, 20 + padding);
      }
      
      function downloadImage() {
        exportCanvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${filename}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          saveProject();
          showToast(`Exported: ${filename}.png`, 'info');
        }, 'image/png');
      }
    }

    function saveProject() {
      if (APP.shapes.length > 0) {
        const project = {
          id: Date.now(),
          name: `Project ${APP.projects.length + 1}`,
          createdAt: new Date().toISOString(),
          lastOpened: new Date().toISOString(),
          measurements: APP.shapes.length
        };
        
        APP.projects.unshift(project);
        APP.projects = APP.projects.slice(0, 10);
        saveSettings();
      }
    }

    // Bluetooth functionality
    function updateDeviceStatus() {
      const statusEl = document.getElementById('deviceStatus');
      const connectBtn = document.getElementById('connectDeviceBtn');
      const disconnectBtn = document.getElementById('disconnectDeviceBtn');
      const laserBtn = document.getElementById('laserBtn');
      const laserStatus = document.getElementById('laserStatus');
      const autoConnectToggle = document.getElementById('autoConnectToggle');
      
      if (APP.bluetooth.connected) {
        statusEl.textContent = 'Connected';
        statusEl.classList.add('connected');
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        laserBtn.classList.add('connected');
        laserStatus.textContent = APP.bluetooth.measuring ? 'MEASURING' : 'READY';
      } else {
        statusEl.textContent = 'Not connected';
        statusEl.classList.remove('connected');
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        laserBtn.classList.remove('connected');
        laserStatus.textContent = 'OFF';
      }
      
      autoConnectToggle.classList.toggle('active', APP.bluetooth.autoConnect);
    }

    async function connectBluetooth() {
      if (!navigator.bluetooth) {
        showToast('Web Bluetooth not supported. Use Chrome/Edge with HTTPS.', 'error');
        return;
      }
      
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] },
            { namePrefix: 'DISTO' },
            { namePrefix: 'GLM' },
            { namePrefix: 'Laser' }
          ],
          optionalServices: [
            '0000ffe0-0000-1000-8000-00805f9b34fb',
            '0000ffe1-0000-1000-8000-00805f9b34fb'
          ]
        });
        
        const server = await device.gatt.connect();
        APP.bluetooth.device = device;
        APP.bluetooth.connected = true;
        
        device.addEventListener('gattserverdisconnected', () => {
          APP.bluetooth.connected = false;
          APP.bluetooth.device = null;
          updateDeviceStatus();
          showToast('Device disconnected', 'warning');
        });
        
        updateDeviceStatus();
        showToast(`Connected to ${device.name}`, 'info');
        
      } catch (error) {
        console.error('Bluetooth connection error:', error);
        showToast(`Connection failed: ${error.message}`, 'error');
      }
    }

    function disconnectBluetooth() {
      if (APP.bluetooth.device && APP.bluetooth.device.gatt.connected) {
        APP.bluetooth.device.gatt.disconnect();
      }
      APP.bluetooth.connected = false;
      APP.bluetooth.device = null;
      APP.bluetooth.measuring = false;
      updateDeviceStatus();
      showToast('Disconnected', 'info');
    }

    function toggleAutoConnect() {
      APP.bluetooth.autoConnect = !APP.bluetooth.autoConnect;
      updateDeviceStatus();
      saveSettings();
      showToast(`Auto-connect ${APP.bluetooth.autoConnect ? 'enabled' : 'disabled'}`, 'info');
    }

    async function handleLaserClick() {
      if (!APP.bluetooth.connected) {
        showToast('Connect laser device first', 'warning');
        return;
      }
      
      if (APP.bluetooth.measuring) {
        APP.bluetooth.measuring = false;
        document.getElementById('laserBtn').classList.remove('measuring');
        updateDeviceStatus();
        return;
      }
      
      APP.bluetooth.measuring = true;
      document.getElementById('laserBtn').classList.add('measuring');
      updateDeviceStatus();
      
      try {
        // Simulate laser measurement (replace with actual BLE communication)
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const measurement = (Math.random() * 120 + 12).toFixed(1);
        const formatted = formatMeasurement(parseFloat(measurement));
        
        addToMeasurementHistory(formatted);
        showToast(`Measured: ${formatted}`, 'info');
        
      } catch (error) {
        showToast(`Measurement failed: ${error.message}`, 'error');
      } finally {
        APP.bluetooth.measuring = false;
        document.getElementById('laserBtn').classList.remove('measuring');
        updateDeviceStatus();
      }
    }

    // Settings persistence
    function saveSettings() {
      try {
        localStorage.setItem('emryn_projects', JSON.stringify(APP.projects));
        localStorage.setItem('emryn_recent_projects', JSON.stringify(APP.recentProjects));
        localStorage.setItem('emryn_auto_connect', JSON.stringify(APP.bluetooth.autoConnect));
      } catch (e) {
        console.warn('Failed to save settings:', e);
      }
    }

    // Toast notifications
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} visible`;
      
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 3000);
    }

    // Initialize measurement history on load
    renderMeasurementHistory();
  </script>
</body>
</html>