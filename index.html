<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>EMRYN Measurement Tool</title>
<style>
  :root {
    --bg: #0e0f12;
    --panel: rgba(21, 24, 33, 0.95);
    --muted: rgba(39, 43, 54, 0.8);
    --text: #e8ecf1;
    --sub: #b6c0cf;
    --accent: #004025;
    --danger: #ff6b6b;
    --ok: #52d273;
    --overlay: rgba(0, 0, 0, 0.6);
  }
  
  * { box-sizing: border-box; }
  html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  }
  
  body {
    background: var(--bg);
    color: var(--text);
  }

  .screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 100;
  }

  .hidden { display: none !important; }

  /* Home screen */
  .home-screen {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    flex-direction: column;
    padding: 20px;
  }

  .home-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0;
    border-bottom: 1px solid #ddd;
    margin-bottom: 30px;
  }

  .home-logo {
    height: 40px;
    cursor: pointer;
    font-size: 24px;
    font-weight: bold;
    color: #004025;
  }

  .home-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .home-grid {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 0 10px;
  }

  .home-card {
    background: #fff;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    min-height: 140px;
    justify-content: center;
    position: relative;
  }

  .home-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .home-card-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: var(--ok);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
  }

  .home-card-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .home-card-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  /* Source chooser */
  .source-chooser {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    min-width: 280px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .source-chooser.visible {
    opacity: 1;
    visibility: visible;
  }

  .chooser-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 20px;
    text-align: center;
  }

  .chooser-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .chooser-btn {
    padding: 16px 20px;
    border: 1px solid var(--muted);
    border-radius: 8px;
    background: var(--muted);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    min-height: 56px;
  }

  .chooser-btn:hover {
    background: var(--accent);
    color: #fff;
    transform: translateY(-1px);
  }

  .chooser-btn-icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
  }

  /* App interface */
  .app-screen {
    background: var(--bg);
    display: flex;
    flex-direction: column;
  }

  .app-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    color: white;
  }

  .back-btn {
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .app-title {
    font-size: 16px;
    font-weight: 600;
  }

  .app-actions {
    display: flex;
    gap: 8px;
  }

  .app-btn {
    background: none;
    border: none;
    color: white;
    font-size: 11px;
    padding: 8px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    min-width: 44px;
    min-height: 44px;
  }

  .app-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .app-btn-icon {
    font-size: 16px;
  }

  .canvas-area {
    flex: 1;
    background: #0a0b0e;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #canvas {
    max-width: 100%;
    max-height: 100%;
    border: 1px solid var(--muted);
  }

  .controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 200;
  }

  .control-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--panel);
    backdrop-filter: blur(10px);
    border: 1px solid var(--muted);
    color: var(--text);
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .control-btn:hover {
    background: var(--accent);
    color: #fff;
    transform: scale(1.05);
  }

  .control-btn.active {
    background: var(--accent);
    color: #fff;
  }

  /* Keypad */
  .keypad {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    width: 320px;
    max-width: 90vw;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .keypad.visible {
    opacity: 1;
    visibility: visible;
  }

  .keypad-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .keypad-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .keypad-close {
    background: none;
    border: none;
    color: var(--sub);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .keypad-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }

  .keypad-input {
    padding: 12px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    font-size: 14px;
    min-height: 44px;
    text-align: center;
  }

  .keypad-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0, 64, 37, 0.2);
  }

  .keypad-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .keypad-btn {
    padding: 12px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .keypad-btn.primary {
    background: var(--accent);
    color: #fff;
  }

  .keypad-btn.secondary {
    background: var(--muted);
    color: var(--text);
  }

  .keypad-btn:hover {
    transform: translateY(-1px);
  }

  /* Toast */
  .toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 16px 20px;
    z-index: 300;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    max-width: 90vw;
    text-align: center;
  }

  .toast.visible {
    opacity: 1;
    visibility: visible;
  }

  .toast.error {
    border-color: var(--danger);
    background: rgba(255, 107, 107, 0.1);
  }

  .toast.info {
    border-color: var(--accent);
    background: rgba(0, 64, 37, 0.1);
  }

  .hidden-input {
    position: absolute;
    left: -9999px;
    opacity: 0;
  }

  @media (max-width: 480px) {
    .home-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .keypad {
      width: 95vw;
      padding: 20px;
    }
    
    .keypad-inputs {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
  }
</style>
</head>
<body>
  <!-- Home Screen -->
  <div id="homeScreen" class="screen home-screen">
    <div class="home-header">
      <div class="home-logo" id="homeMenuBtn">EMRYN</div>
      <div class="home-title">Home</div>
    </div>
    
    <div class="home-grid">
      <div class="home-card" id="sketchCard">
        <div class="home-card-badge">FREE</div>
        <div class="home-card-icon">üìè</div>
        <h3 class="home-card-title">Sketch on Photo</h3>
      </div>
      
      <div class="home-card" id="organizerCard">
        <div class="home-card-badge">FREE</div>
        <div class="home-card-icon">üìÅ</div>
        <h3 class="home-card-title">Organiser</h3>
      </div>
    </div>
  </div>

  <!-- App Screen -->
  <div id="appScreen" class="screen app-screen hidden">
    <div class="app-header">
      <div class="back-btn" id="backBtn">‚Üê</div>
      <div class="app-title" id="appTitle">New Project</div>
      <div class="app-actions">
        <button class="app-btn" id="exportBtn">
          <div class="app-btn-icon">‚Üó</div>
          <div>Export</div>
        </button>
        <button class="app-btn" id="newBtn">
          <div class="app-btn-icon">üîÑ</div>
          <div>New</div>
        </button>
      </div>
    </div>
    
    <div class="canvas-area">
      <canvas id="canvas"></canvas>
    </div>
    
    <div class="controls">
      <button class="control-btn" id="cameraBtn" title="Add Photo" aria-label="Add Photo">üì∑</button>
      <button class="control-btn" id="measureBtn" title="Add Measurement" aria-label="Add Measurement">üìè</button>
    </div>
  </div>

  <!-- Source Chooser -->
  <div id="sourceChooser" class="source-chooser">
    <div class="chooser-title">Select picture</div>
    <div class="chooser-buttons">
      <button class="chooser-btn" id="chooserCamera" aria-label="Open Camera">
        <div class="chooser-btn-icon">üì∑</div>
        <span>Camera</span>
      </button>
      <button class="chooser-btn" id="chooserGallery" aria-label="Open Photo Library">
        <div class="chooser-btn-icon">üñº</div>
        <span>Photo Library</span>
      </button>
      <button class="chooser-btn" id="chooserPdf" aria-label="Open PDF">
        <div class="chooser-btn-icon">üìÑ</div>
        <span>PDF</span>
      </button>
      <button class="chooser-btn" id="chooserCancel" aria-label="Cancel" style="background: var(--muted); margin-top: 12px;">
        <div class="chooser-btn-icon">‚úï</div>
        <span>Cancel</span>
      </button>
    </div>
  </div>

  <!-- Measurement Keypad -->
  <div id="measurementKeypad" class="keypad">
    <div class="keypad-header">
      <div class="keypad-title">Enter Measurement</div>
      <button class="keypad-close" id="keypadClose">‚úï</button>
    </div>
    
    <div class="keypad-inputs">
      <input class="keypad-input" id="feetInput" type="number" placeholder="ft" min="0" aria-label="Feet">
      <input class="keypad-input" id="inchesInput" type="number" placeholder="in" min="0" max="11" aria-label="Inches">
      <input class="keypad-input" id="numInput" type="number" placeholder="num" min="0" aria-label="Fraction numerator">
      
      <select class="keypad-input" id="denomInput" aria-label="Fraction denominator" style="grid-column: 1 / -1; margin-top: 8px;">
        <option value="2">1/2</option>
        <option value="4">1/4</option>
        <option value="8" selected>1/8</option>
        <option value="16">1/16</option>
        <option value="32">1/32</option>
        <option value="64">1/64</option>
      </select>
    </div>
    
    <div class="keypad-actions">
      <button class="keypad-btn secondary" id="keypadCancel">Cancel</button>
      <button class="keypad-btn primary" id="keypadApply">Apply</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Hidden file inputs -->
  <input type="file" id="fileInput" accept="image/*" class="hidden-input">
  <input type="file" id="pdfInput" accept=".pdf" class="hidden-input">

  <script>
    // App state
    const state = {
      currentScreen: 'home',
      currentImage: null,
      measurements: [],
      projects: JSON.parse(localStorage.getItem('emryn_projects') || '[]')
    };

    // Elements
    const homeScreen = document.getElementById('homeScreen');
    const appScreen = document.getElementById('appScreen');
    const sourceChooser = document.getElementById('sourceChooser');
    const measurementKeypad = document.getElementById('measurementKeypad');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const toast = document.getElementById('toast');

    // Initialize
    init();

    function init() {
      setupEventListeners();
      showScreen('home');
    }

    function setupEventListeners() {
      // Home screen
      document.getElementById('sketchCard').addEventListener('click', showSourceChooser);
      document.getElementById('organizerCard').addEventListener('click', showOrganizer);

      // App screen
      document.getElementById('backBtn').addEventListener('click', () => showScreen('home'));
      document.getElementById('exportBtn').addEventListener('click', exportImage);
      document.getElementById('newBtn').addEventListener('click', showSourceChooser);
      document.getElementById('cameraBtn').addEventListener('click', showSourceChooser);
      document.getElementById('measureBtn').addEventListener('click', showMeasurementKeypad);

      // Source chooser
      document.getElementById('chooserCamera').addEventListener('click', openCamera);
      document.getElementById('chooserGallery').addEventListener('click', openGallery);
      document.getElementById('chooserPdf').addEventListener('click', openPdf);
      document.getElementById('chooserCancel').addEventListener('click', hideSourceChooser);

      // Measurement keypad
      document.getElementById('keypadClose').addEventListener('click', hideMeasurementKeypad);
      document.getElementById('keypadCancel').addEventListener('click', hideMeasurementKeypad);
      document.getElementById('keypadApply').addEventListener('click', applyMeasurement);

      // File inputs
      document.getElementById('fileInput').addEventListener('change', handleFileInput);
      document.getElementById('pdfInput').addEventListener('change', handlePdfInput);

      // Canvas interactions
      canvas.addEventListener('click', handleCanvasClick);

      // Close overlays on outside click
      document.addEventListener('click', (e) => {
        if (sourceChooser.classList.contains('visible') && !sourceChooser.contains(e.target) && !e.target.closest('#sketchCard, #cameraBtn, #newBtn')) {
          hideSourceChooser();
        }
      });
    }

    function showScreen(screen) {
      homeScreen.classList.toggle('hidden', screen !== 'home');
      appScreen.classList.toggle('hidden', screen !== 'app');
      state.currentScreen = screen;
    }

    function showSourceChooser() {
      sourceChooser.classList.add('visible');
    }

    function hideSourceChooser() {
      sourceChooser.classList.remove('visible');
    }

    function showMeasurementKeypad() {
      measurementKeypad.classList.add('visible');
      // Clear inputs
      document.getElementById('feetInput').value = '';
      document.getElementById('inchesInput').value = '';
      document.getElementById('numInput').value = '';
      document.getElementById('denomInput').value = '8';
    }

    function hideMeasurementKeypad() {
      measurementKeypad.classList.remove('visible');
    }

    function showOrganizer() {
      if (state.projects.length === 0) {
        showToast('No projects yet. Create measurements to start.', 'info');
      } else {
        const projectList = state.projects.map((p, i) => `${i + 1}. ${p.name} (${new Date(p.date).toLocaleDateString()})`).join('\n');
        alert(`Projects:\n\n${projectList}\n\nProject management coming in next update!`);
      }
    }

    async function openCamera() {
      hideSourceChooser();
      
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showToast('Camera not available on this device', 'error');
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        // Create video element
        const video = document.createElement('video');
        video.srcObject = stream;
        video.autoplay = true;
        video.playsInline = true;

        // Wait for video to be ready
        video.addEventListener('loadedmetadata', () => {
          // Take photo after 2 seconds
          setTimeout(() => {
            const captureCanvas = document.createElement('canvas');
            const captureCtx = captureCanvas.getContext('2d');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            
            captureCtx.drawImage(video, 0, 0);
            const imageData = captureCanvas.toDataURL('image/jpeg', 0.9);
            
            // Stop camera
            stream.getTracks().forEach(track => track.stop());
            
            // Load image
            loadImage(imageData);
          }, 2000);
        });
        
        showToast('Camera opened - taking photo in 2 seconds...', 'info');
        
      } catch (error) {
        console.error('Camera error:', error);
        showToast(`Camera access failed: ${error.message}`, 'error');
      }
    }

    function openGallery() {
      hideSourceChooser();
      document.getElementById('fileInput').click();
    }

    function openPdf() {
      hideSourceChooser();
      document.getElementById('pdfInput').click();
    }

    function handleFileInput(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (event) => {
          loadImage(event.target.result);
        };
        reader.readAsDataURL(file);
      } else {
        showToast('Please select an image file', 'error');
      }
      e.target.value = ''; // Reset input
    }

    function handlePdfInput(e) {
      const file = e.target.files[0];
      if (file) {
        showToast('PDF support coming soon', 'info');
      }
      e.target.value = ''; // Reset input
    }

    function loadImage(imageSrc) {
      const img = new Image();
      img.onload = () => {
        state.currentImage = img;
        
        // Resize canvas to fit image
        const maxWidth = window.innerWidth - 40;
        const maxHeight = window.innerHeight - 200;
        const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
        
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;
        
        // Draw image
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        showScreen('app');
        showToast('Image loaded. Click to add measurements.', 'info');
      };
      img.src = imageSrc;
    }

    function handleCanvasClick(e) {
      if (!state.currentImage) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      showToast('Click measurement button to add measurements', 'info');
    }

    function applyMeasurement() {
      const feet = parseInt(document.getElementById('feetInput').value) || 0;
      const inches = parseInt(document.getElementById('inchesInput').value) || 0;
      const numerator = parseInt(document.getElementById('numInput').value) || 0;
      const denominator = parseInt(document.getElementById('denomInput').value) || 8;
      
      // Calculate total inches
      const totalInches = feet * 12 + inches + numerator / denominator;
      
      // Format measurement
      let formatted = '';
      const normalizedFeet = Math.floor(totalInches / 12);
      const remainingInches = totalInches % 12;
      const wholeInches = Math.floor(remainingInches);
      const fraction = remainingInches - wholeInches;
      
      if (normalizedFeet > 0) formatted += normalizedFeet + "'";
      if (wholeInches > 0) formatted += wholeInches + '"';
      if (fraction > 0.01) {
        // Convert to nearest fraction
        const denominators = [64, 32, 16, 8, 4, 2];
        for (const denom of denominators) {
          const num = Math.round(fraction * denom);
          if (Math.abs(fraction - num / denom) < 0.01 && num > 0) {
            formatted += ` ${num}/${denom}"`;
            break;
          }
        }
      }
      
      const measurement = formatted || '0"';
      
      // Add measurement to state
      state.measurements.push({
        id: Date.now(),
        value: measurement,
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height
      });
      
      // Redraw canvas with measurements
      redrawCanvas();
      
      hideMeasurementKeypad();
      showToast(`Added measurement: ${measurement}`, 'info');
    }

    function redrawCanvas() {
      if (!state.currentImage) return;
      
      // Clear and redraw image
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(state.currentImage, 0, 0, canvas.width, canvas.height);
      
      // Draw measurements
      state.measurements.forEach(measurement => {
        // Draw measurement callout
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.font = '14px Arial';
        const textWidth = ctx.measureText(measurement.value).width;
        const padding = 8;
        
        ctx.fillRect(
          measurement.x - textWidth/2 - padding,
          measurement.y - 10 - padding,
          textWidth + padding * 2,
          20 + padding * 2
        );
        
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(measurement.value, measurement.x, measurement.y);
        
        // Draw point
        ctx.fillStyle = '#1e90ff';
        ctx.beginPath();
        ctx.arc(measurement.x, measurement.y, 5, 0, 2 * Math.PI);
        ctx.fill();
      });
    }

    function exportImage() {
      if (!state.currentImage || state.measurements.length === 0) {
        showToast('Add measurements before exporting', 'error');
        return;
      }
      
      // Create export canvas with original image dimensions
      const exportCanvas = document.createElement('canvas');
      const exportCtx = exportCanvas.getContext('2d');
      exportCanvas.width = state.currentImage.width;
      exportCanvas.height = state.currentImage.height;
      
      // Draw original image
      exportCtx.drawImage(state.currentImage, 0, 0);
      
      // Scale measurements to original dimensions
      const scaleX = state.currentImage.width / canvas.width;
      const scaleY = state.currentImage.height / canvas.height;
      
      state.measurements.forEach(measurement => {
        const x = measurement.x * scaleX;
        const y = measurement.y * scaleY;
        
        // Draw measurement
        exportCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        exportCtx.font = `${16 * Math.min(scaleX, scaleY)}px Arial`;
        const textWidth = exportCtx.measureText(measurement.value).width;
        const padding = 10 * Math.min(scaleX, scaleY);
        
        exportCtx.fillRect(
          x - textWidth/2 - padding,
          y - 10 * Math.min(scaleX, scaleY) - padding,
          textWidth + padding * 2,
          20 * Math.min(scaleX, scaleY) + padding * 2
        );
        
        exportCtx.fillStyle = '#fff';
        exportCtx.textAlign = 'center';
        exportCtx.textBaseline = 'middle';
        exportCtx.fillText(measurement.value, x, y);
        
        // Draw point
        exportCtx.fillStyle = '#1e90ff';
        exportCtx.beginPath();
        exportCtx.arc(x, y, 8 * Math.min(scaleX, scaleY), 0, 2 * Math.PI);
        exportCtx.fill();
      });
      
      // Add timestamp
      const timestamp = new Date().toLocaleString();
      exportCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      exportCtx.font = `${14 * Math.min(scaleX, scaleY)}px Arial`;
      const timestampWidth = exportCtx.measureText(timestamp).width;
      exportCtx.fillRect(20, 20, timestampWidth + 20, 30);
      exportCtx.fillStyle = '#fff';
      exportCtx.fillText(timestamp, 30, 35);
      
      // Download image
      exportCanvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `measurement-${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Save project
        saveProject();
        showToast('Image exported successfully!', 'info');
      }, 'image/png');
    }

    function saveProject() {
      if (state.measurements.length > 0) {
        const project = {
          id: Date.now(),
          name: `Project ${state.projects.length + 1}`,
          date: new Date().toISOString(),
          measurements: state.measurements.length
        };
        
        state.projects.unshift(project);
        state.projects = state.projects.slice(0, 10); // Keep last 10
        localStorage.setItem('emryn_projects', JSON.stringify(state.projects));
      }
    }

    function showToast(message, type = 'info') {
      toast.textContent = message;
      toast.className = `toast ${type} visible`;
      
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 3000);
    }
  </script>
</body>
</html>