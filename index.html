<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>EMRYN Measurement Tool</title>
<style>
  :root {
    --bg: #0e0f12;
    --panel: rgba(21, 24, 33, 0.95);
    --muted: rgba(39, 43, 54, 0.8);
    --text: #e8ecf1;
    --sub: #b6c0cf;
    --accent: #004025;
    --danger: #ff6b6b;
    --ok: #52d273;
    --overlay: rgba(0, 0, 0, 0.6);
  }
  
  * { box-sizing: border-box; }
  html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  }
  
  body {
    background: var(--bg);
    color: var(--text);
    position: relative;
  }

  /* Home screen */
  .home-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    z-index: 300;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }

  .home-screen.hidden {
    display: none;
  }

  .home-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0;
    border-bottom: 1px solid #ddd;
    margin-bottom: 30px;
  }

  .home-logo {
    height: 40px;
    width: auto;
    opacity: 0.8;
    cursor: pointer;
  }

  .home-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .home-grid {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 0 10px;
  }

  .home-card {
    background: #fff;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    min-height: 140px;
    justify-content: center;
  }

  .home-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
  }

  .home-card-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: var(--ok);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: bold;
  }

  .home-card-icon {
    width: 60px;
    height: 60px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .home-card-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0;
  }

  /* Side menu */
  .side-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100vh;
    background: #fff;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: 400;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
  }

  .side-menu.open {
    transform: translateX(0);
  }

  .side-menu-header {
    background: var(--accent);
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .side-menu-close {
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 5px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .side-menu-logo {
    height: 32px;
    width: auto;
    filter: invert(1);
  }

  .side-menu-title {
    font-size: 16px;
    font-weight: 600;
  }

  .side-menu-content {
    padding: 0;
  }

  .side-menu-section {
    border-bottom: 1px solid #eee;
  }

  .side-menu-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 16px 20px;
    color: #333;
    cursor: pointer;
    transition: background-color 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 16px;
    min-height: 56px;
  }

  .side-menu-item:hover {
    background: #f8f9fa;
  }

  .side-menu-item-icon {
    width: 24px;
    text-align: center;
    font-size: 18px;
  }

  .menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--overlay);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 350;
  }

  .menu-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Organizer screen */
  .organizer-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 250;
    display: none;
    flex-direction: column;
  }

  .organizer-screen.visible {
    display: flex;
  }

  .organizer-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    padding: 0 15px;
    gap: 15px;
  }

  .organizer-back {
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .organizer-title {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    flex: 1;
  }

  .organizer-add {
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .organizer-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .organizer-section {
    margin-bottom: 30px;
  }

  .organizer-section h3 {
    margin: 0 0 15px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--sub);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .project-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .project-item {
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .project-item:hover {
    background: rgba(0, 64, 37, 0.1);
    transform: translateY(-1px);
  }

  .project-icon {
    width: 48px;
    height: 48px;
    background: var(--muted);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .project-details {
    flex: 1;
  }

  .project-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin: 0 0 4px 0;
  }

  .project-date {
    font-size: 12px;
    color: var(--sub);
  }

  .project-actions {
    display: flex;
    gap: 8px;
  }

  .project-action-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--muted);
    border: none;
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .project-action-btn:hover {
    background: var(--accent);
    color: #fff;
  }

  .project-action-btn.danger:hover {
    background: var(--danger);
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--sub);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Settings screen */
  .settings-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 250;
    display: none;
    flex-direction: column;
  }

  .settings-screen.visible {
    display: flex;
  }

  .settings-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    padding: 0 15px;
    gap: 15px;
  }

  .settings-back {
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .settings-title {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
  }

  .settings-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .settings-section {
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    margin-bottom: 20px;
    padding: 20px;
  }

  .settings-section h3 {
    margin: 0 0 16px 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--accent);
  }

  .settings-label {
    font-size: 14px;
    color: var(--text);
    margin-bottom: 8px;
    font-weight: 600;
  }

  .logo-upload {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
  }

  .logo-upload:last-child {
    margin-bottom: 0;
  }

  .logo-preview-container {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-preview {
    width: 80px;
    height: 80px;
    border: 2px dashed var(--muted);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
  }

  .logo-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .logo-preview-placeholder {
    color: var(--sub);
    font-size: 12px;
    text-align: center;
  }

  .logo-actions {
    display: flex;
    gap: 8px;
    flex-direction: column;
  }

  .logo-btn {
    padding: 8px 12px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: var(--muted);
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 36px;
  }

  .logo-btn:hover {
    background: var(--accent);
    color: #fff;
  }

  .logo-btn.danger {
    background: var(--danger);
    color: #fff;
  }

  /* Main app interface */
  .app-interface {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 100;
  }

  .top-toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    z-index: 150;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  }

  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .emryn-logo {
    height: 32px;
    width: auto;
    cursor: pointer;
    filter: invert(1);
    opacity: 0.9;
  }

  .back-btn {
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .toolbar-center {
    flex: 1;
    text-align: center;
  }

  .project-info {
    color: #fff;
    font-size: 14px;
    font-weight: 500;
  }

  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .toolbar-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 11px;
    padding: 8px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    min-width: 44px;
    min-height: 44px;
  }

  .toolbar-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .toolbar-btn-icon {
    font-size: 16px;
  }

  /* Main canvas area */
  .main {
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 120px;
    background: #0a0b0e;
  }

  #canvasContainer {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: none;
  }

  #imageCanvas, #drawCanvas {
    position: absolute;
    max-width: 100%;
    max-height: 100%;
  }
  
  #imageCanvas {
    background: #0b0e13;
    z-index: 1;
  }
  
  #drawCanvas {
    background: transparent;
    z-index: 2;
    touch-action: none;
  }

  /* Measurement history panel */
  .measurement-history {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 120px;
    background: var(--panel);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--muted);
    z-index: 140;
    display: flex;
    flex-direction: column;
  }

  .history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--muted);
  }

  .history-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--sub);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .clear-history-btn {
    background: none;
    border: none;
    color: var(--sub);
    font-size: 11px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    min-height: 32px;
  }

  .clear-history-btn:hover {
    background: var(--muted);
    color: var(--text);
  }

  .history-list {
    flex: 1;
    overflow-x: auto;
    padding: 8px 16px;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .history-item {
    background: var(--muted);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    transition: all 0.2s ease;
    min-height: 36px;
    display: flex;
    align-items: center;
  }

  .history-item:hover {
    background: var(--accent);
    color: #fff;
    transform: translateY(-1px);
  }

  /* Laser control */
  .laser-control {
    position: fixed;
    bottom: 140px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 130;
  }

  .laser-btn {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #333;
    border: 4px solid #555;
    color: #fff;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    transition: all 0.2s ease;
  }

  .laser-btn.connected {
    background: var(--accent);
    border-color: #006635;
    color: #fff;
  }

  .laser-btn.measuring {
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }

  /* Floating controls */
  .floating-controls {
    position: fixed;
    bottom: 140px;
    right: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 130;
  }

  .float-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--panel);
    backdrop-filter: blur(10px);
    border: 1px solid var(--muted);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
    min-width: 44px;
    min-height: 44px;
  }

  .float-btn:hover {
    background: var(--accent);
    color: #fff;
    transform: scale(1.05);
  }

  /* Context menu */
  .context-menu {
    position: fixed;
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 8px 0;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transform: scale(0.95);
    transition: all 0.2s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    min-width: 180px;
  }

  .context-menu.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }

  .context-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: var(--text);
    cursor: pointer;
    transition: background-color 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 14px;
    min-height: 44px;
  }

  .context-menu-item:hover {
    background: rgba(0, 64, 37, 0.1);
  }

  .context-menu-item.danger:hover {
    background: rgba(255, 107, 107, 0.1);
    color: var(--danger);
  }

  /* Manual measurement keypad */
  .measurement-keypad {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    opacity: 0;
    visibility: hidden;
    transform: translate(-50%, 50%) scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    width: 320px;
    max-width: 90vw;
  }

  .measurement-keypad.visible {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, 50%) scale(1);
  }

  .keypad-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .keypad-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .keypad-close {
    background: none;
    border: none;
    color: var(--sub);
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .keypad-close:hover {
    background: var(--muted);
    color: var(--text);
  }

  .keypad-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }

  .fraction-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    grid-column: 1 / -1;
    margin-top: 8px;
  }

  .keypad-input {
    padding: 12px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    font-size: 14px;
    min-height: 44px;
    text-align: center;
  }

  .keypad-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0, 64, 37, 0.2);
  }

  .keypad-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
  }

  .keypad-btn {
    padding: 12px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .keypad-btn.primary {
    background: var(--accent);
    color: #fff;
  }

  .keypad-btn.primary:hover {
    background: #006635;
    transform: translateY(-1px);
  }

  .keypad-btn.secondary {
    background: var(--muted);
    color: var(--text);
  }

  .keypad-btn.secondary:hover {
    background: #3a4050;
  }

  /* Source chooser */
  .source-chooser {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    opacity: 0;
    visibility: hidden;
    transform: translate(-50%, 50%) scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    min-width: 280px;
  }

  .source-chooser.visible {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, 50%) scale(1);
  }

  .chooser-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 20px;
    text-align: center;
  }

  .chooser-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .chooser-btn {
    padding: 16px 20px;
    border: 1px solid var(--muted);
    border-radius: 8px;
    background: var(--muted);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    min-height: 56px;
  }

  .chooser-btn:hover {
    background: var(--accent);
    color: #fff;
    transform: translateY(-1px);
  }

  .chooser-btn-icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
  }

  /* Capture screen */
  .capture-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 275;
    display: none;
    flex-direction: column;
  }

  .capture-screen.visible {
    display: flex;
  }

  .capture-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
  }

  .capture-title {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
  }

  .capture-preview {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #000;
    position: relative;
  }

  .capture-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .capture-actions {
    padding: 20px;
    display: flex;
    gap: 12px;
    background: var(--panel);
  }

  .capture-btn {
    flex: 1;
    padding: 16px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 56px;
  }

  .capture-btn.secondary {
    background: var(--muted);
    color: var(--text);
  }

  .capture-btn.primary {
    background: var(--accent);
    color: #fff;
  }

  /* My Devices screen */
  .my-devices-screen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--bg);
    z-index: 250;
    display: none;
    flex-direction: column;
  }

  .my-devices-screen.visible {
    display: flex;
  }

  .devices-header {
    height: 60px;
    background: var(--accent);
    display: flex;
    align-items: center;
    padding: 0 15px;
    gap: 15px;
  }

  .devices-back {
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .devices-title {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
  }

  .devices-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  .device-card {
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
  }

  .device-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 16px;
  }

  .device-icon {
    width: 48px;
    height: 48px;
    background: var(--muted);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  .device-details h3 {
    margin: 0 0 4px 0;
    font-size: 16px;
    color: var(--text);
  }

  .device-status {
    font-size: 12px;
    color: var(--sub);
  }

  .device-status.connected {
    color: var(--accent);
    font-weight: 600;
  }

  .device-actions {
    display: flex;
    gap: 12px;
  }

  .device-btn {
    padding: 10px 16px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: var(--muted);
    color: var(--text);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 44px;
  }

  .device-btn.primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }

  .device-btn:hover {
    transform: translateY(-1px);
  }

  .device-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .auto-connect-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding: 16px;
    background: var(--panel);
    border: 1px solid var(--muted);
    border-radius: 8px;
  }

  .toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
    background: var(--muted);
    border-radius: 13px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .toggle-switch.active {
    background: var(--accent);
  }

  .toggle-knob {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 22px;
    height: 22px;
    background: #fff;
    border-radius: 50%;
    transition: transform 0.2s ease;
  }

  .toggle-switch.active .toggle-knob {
    transform: translateX(24px);
  }

  /* Toast notifications */
  .toast {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 16px 20px;
    z-index: 300;
    opacity: 0;
    visibility: hidden;
    transform: translateX(-50%) translateY(-20px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    max-width: 90vw;
    text-align: center;
  }

  .toast.visible {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  .toast.error {
    border-color: var(--danger);
    background: rgba(255, 107, 107, 0.1);
  }

  .toast.warning {
    border-color: #ffd166;
    background: rgba(255, 209, 102, 0.1);
  }

  .toast.info {
    border-color: var(--accent);
    background: rgba(0, 64, 37, 0.1);
  }

  .export-dialog {
    position: fixed;
    bottom: 50%;
    left: 50%;
    transform: translate(-50%, 50%);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    z-index: 250;
    opacity: 0;
    visibility: hidden;
    transform: translate(-50%, 50%) scale(0.9);
    transition: all 0.3s ease;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    min-width: 280px;
  }

  .export-dialog.visible {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, 50%) scale(1);
  }

  .export-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
    text-align: center;
  }

  .export-input {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    font-size: 14px;
    margin-bottom: 20px;
  }

  .export-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(0, 64, 37, 0.2);
  }

  .export-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .hidden { display: none !important; }

  /* Responsive adjustments */
  @media (max-width: 480px) {
    .measurement-keypad {
      width: 95vw;
      padding: 20px;
    }
    
    .keypad-inputs {
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .fraction-row {
      grid-template-columns: 1fr 80px;
    }
    
    .home-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .toolbar-right {
      gap: 4px;
    }
    
    .toolbar-btn {
      min-width: 40px;
      font-size: 10px;
      padding: 6px 8px;
    }
  }
</style>
</head>
<body>
  <!-- Home screen -->
  <div class="home-screen" id="homeScreen">
    <div class="home-header">
      <img src="data:image/svg+xml,%3Csvg viewBox='0 0 200 50' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='10' y='35' font-family='Arial, sans-serif' font-size='32' font-weight='bold' fill='%23004025'%3EEMRYN%3C/text%3E%3C/svg%3E" alt="EMRYN" class="home-logo" id="homeMenuBtn" />
      <div class="home-title">Home</div>
    </div>
    
    <div class="home-grid">
      <div class="home-card" id="sketchOnPhotoCard">
        <div class="home-card-badge">FREE</div>
        <div class="home-card-icon">üìè</div>
        <h3 class="home-card-title">Sketch on Photo</h3>
      </div>
      
      <div class="home-card" id="organiserCard">
        <div class="home-card-badge">FREE</div>
        <div class="home-card-icon">üìÅ</div>
        <h3 class="home-card-title">Organiser</h3>
      </div>
    </div>
  </div>

  <!-- Menu overlay -->
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- Side menu -->
  <div class="side-menu" id="sideMenu">
    <div class="side-menu-header">
      <div class="side-menu-close" id="sideMenuClose">‚úï</div>
      <img src="" alt="EMRYN" class="side-menu-logo" id="sideMenuLogo" />
      <div class="side-menu-title">Menu</div>
    </div>
    
    <div class="side-menu-content">
      <div class="side-menu-section">
        <button class="side-menu-item" id="menuSketchPhoto">
          <div class="side-menu-item-icon">üìè</div>
          <span>Sketch on Photo</span>
        </button>
        <button class="side-menu-item" id="menuOrganiser">
          <div class="side-menu-item-icon">üìÅ</div>
          <span>Organiser</span>
        </button>
      </div>
      
      <div class="side-menu-section">
        <button class="side-menu-item" id="menuMyDevices">
          <div class="side-menu-item-icon">üì±</div>
          <span>My Devices</span>
        </button>
        <button class="side-menu-item" id="menuSettings">
          <div class="side-menu-item-icon">‚öôÔ∏è</div>
          <span>Settings</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Organizer screen -->
  <div class="organizer-screen" id="organizerScreen">
    <div class="organizer-header">
      <div class="organizer-back" id="organizerBack">‚Üê</div>
      <div class="organizer-title">Organiser</div>
      <div class="organizer-add" id="organizerAdd">+</div>
    </div>
    
    <div class="organizer-content">
      <div class="organizer-section">
        <h3>Recently Opened</h3>
        <div class="project-list" id="recentProjectsList">
          <div class="empty-state">
            <div class="empty-state-icon">üìÑ</div>
            <div>No recent projects</div>
          </div>
        </div>
      </div>
      
      <div class="organizer-section">
        <h3>All Projects</h3>
        <div class="project-list" id="allProjectsList">
          <div class="empty-state">
            <div class="empty-state-icon">üìÇ</div>
            <div>No projects yet. Tap + to create your first project.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings screen -->
  <div class="settings-screen" id="settingsScreen">
    <div class="settings-header">
      <div class="settings-back" id="settingsBack">‚Üê</div>
      <div class="settings-title">Settings</div>
    </div>
    
    <div class="settings-content">
      <div class="settings-section">
        <h3>Branding</h3>
        
        <div class="logo-upload">
          <div class="settings-label">Menu Logo</div>
          <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">Used as the tappable menu icon throughout the app</div>
          <div class="logo-preview-container">
            <div class="logo-preview" id="menuLogoPreview">
              <div class="logo-preview-placeholder">No logo</div>
            </div>
            <div class="logo-actions">
              <input type="file" id="menuLogoInput" accept="image/*" class="hidden" />
              <button class="logo-btn" id="menuLogoUpload">Upload</button>
              <button class="logo-btn danger" id="menuLogoRemove">Remove</button>
            </div>
          </div>
        </div>

        <div class="logo-upload">
          <div class="settings-label">Watermark Logo</div>
          <div style="font-size: 12px; color: var(--sub); margin-bottom: 8px;">Used as corner watermark on exported images</div>
          <div class="logo-preview-container">
            <div class="logo-preview" id="watermarkLogoPreview">
              <div class="logo-preview-placeholder">No logo</div>
            </div>
            <div class="logo-actions">
              <input type="file" id="watermarkLogoInput" accept="image/*" class="hidden" />
              <button class="logo-btn" id="watermarkLogoUpload">Upload</button>
              <button class="logo-btn danger" id="watermarkLogoRemove">Remove</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main app interface -->
  <div class="app-interface hidden" id="appInterface">
    <!-- Top toolbar -->
    <div class="top-toolbar">
      <div class="toolbar-left">
        <img src="" alt="EMRYN" class="emryn-logo" id="emrynLogo" />
        <div class="back-btn" id="backBtn">‚Üê</div>
      </div>
      
      <div class="toolbar-center">
        <div class="project-info" id="projectInfo">New Project</div>
      </div>
      
      <div class="toolbar-right">
        <button class="toolbar-btn" id="exportBtn">
          <div class="toolbar-btn-icon">‚Üó</div>
          <div>Export</div>
        </button>
        <button class="toolbar-btn" id="undoBtn">
          <div class="toolbar-btn-icon">‚Ü∂</div>
          <div>Undo</div>
        </button>
        <button class="toolbar-btn" id="newBtn">
          <div class="toolbar-btn-icon">üîÑ</div>
          <div>New</div>
        </button>
      </div>
    </div>

    <!-- Main canvas -->
    <main class="main">
      <div id="canvasContainer">
        <canvas id="imageCanvas"></canvas>
        <canvas id="drawCanvas"></canvas>
      </div>
    </main>

    <!-- Measurement history panel -->
    <div class="measurement-history">
      <div class="history-header">
        <div class="history-title">Recent Measurements</div>
        <button class="clear-history-btn" id="clearHistoryBtn">Clear</button>
      </div>
      <div class="history-list" id="historyList">
        <div style="color: var(--sub); font-size: 11px; text-align: center; width: 100%;">
          Measurements from laser or manual entry will appear here
        </div>
      </div>
    </div>

    <!-- Floating controls -->
    <div class="floating-controls">
      <button class="float-btn" id="lineToolBtn" title="Draw Line" aria-label="Draw Line">‚úèÔ∏è</button>
      <button class="float-btn" id="manualMeasureBtn" title="Manual Entry" aria-label="Manual Entry">üìè</button>
    </div>

    <!-- Laser control -->
    <div class="laser-control">
      <button class="laser-btn" id="laserBtn" aria-label="Laser Measure">
        <div style="font-size: 10px;">LASER</div>
        <div id="laserStatus">OFF</div>
      </button>
    </div>

    <!-- Context menu -->
    <div class="context-menu" id="contextMenu">
      <button class="context-menu-item" id="contextEdit">
        <div>‚úèÔ∏è</div>
        <span>Edit Measurement</span>
      </button>
      <button class="context-menu-item" id="contextDuplicate">
        <div>üìã</div>
        <span>Duplicate</span>
      </button>
      <button class="context-menu-item" id="contextAddText">
        <div>üÖ∞</div>
        <span>Add Text</span>
      </button>
      <button class="context-menu-item" id="contextMoveToProject">
        <div>üìÅ</div>
        <span>Move to Project</span>
      </button>
      <button class="context-menu-item danger" id="contextDelete">
        <div>üóë</div>
        <span>Delete</span>
      </button>
    </div>
  </div>

  <!-- Source chooser -->
  <div class="source-chooser" id="sourceChooser">
    <div class="chooser-title">Select picture</div>
    <div class="chooser-buttons">
      <button class="chooser-btn" id="chooserCamera" aria-label="Open Camera">
        <div class="chooser-btn-icon">üì∑</div>
        <span>Camera</span>
      </button>
      <button class="chooser-btn" id="chooserGallery" aria-label="Open Photo Library">
        <div class="chooser-btn-icon">üñº</div>
        <span>Photo Library</span>
      </button>
      <button class="chooser-btn" id="chooserPdf" aria-label="Open PDF">
        <div class="chooser-btn-icon">üìÑ</div>
        <span>PDF</span>
      </button>
      <button class="chooser-btn" id="chooserCancel" aria-label="Cancel" style="background: var(--muted); margin-top: 12px;">
        <div class="chooser-btn-icon">‚úï</div>
        <span>Cancel</span>
      </button>
    </div>
  </div>

  <!-- Capture screen -->
  <div class="capture-screen" id="captureScreen">
    <div class="capture-header">
      <div class="capture-title">Photo Captured</div>
    </div>
    
    <div class="capture-preview">
      <img class="capture-image" id="captureImage" alt="Captured photo" />
    </div>
    
    <div class="capture-actions">
      <button class="capture-btn secondary" id="retakeBtn">Retake</button>
      <button class="capture-btn primary" id="usePhotoBtn">Use Photo</button>
    </div>
  </div>

  <!-- Manual measurement keypad -->
  <div class="measurement-keypad" id="measurementKeypad">
    <div class="keypad-header">
      <div class="keypad-title">Enter Measurement</div>
      <button class="keypad-close" id="keypadClose">‚úï</button>
    </div>
    
    <div class="keypad-inputs">
      <input class="keypad-input" id="feetInput" type="number" placeholder="ft" min="0" aria-label="Feet" />
      <input class="keypad-input" id="inchesInput" type="number" placeholder="in" min="0" max="11" aria-label="Inches" />
      <input class="keypad-input" id="numInput" type="number" placeholder="num" min="0" aria-label="Fraction numerator" />
      
      <div class="fraction-row">
        <select class="keypad-input" id="denomInput" aria-label="Fraction denominator">
          <option value="2">1/2</option>
          <option value="4">1/4</option>
          <option value="8" selected>1/8</option>
          <option value="16">1/16</option>
          <option value="32">1/32</option>
          <option value="64">1/64</option>
        </select>
      </div>
    </div>
    
    <div class="keypad-actions">
      <button class="keypad-btn secondary" id="keypadCancel">Cancel</button>
      <button class="keypad-btn primary" id="keypadApply">Apply</button>
    </div>
  </div>

  <!-- Export dialog -->
  <div class="export-dialog" id="exportDialog">
    <div class="export-title">Export Image</div>
    <input class="export-input" id="exportFilename" type="text" placeholder="Enter filename" />
    <div class="export-actions">
      <button class="keypad-btn secondary" id="exportCancel">Cancel</button>
      <button class="keypad-btn primary" id="exportConfirm">Export</button>
    </div>
  </div>

  <!-- My Devices screen -->
  <div class="my-devices-screen" id="myDevicesScreen">
    <div class="devices-header">
      <div class="devices-back" id="devicesBack">‚Üê</div>
      <div class="devices-title">My Devices</div>
    </div>
    
    <div class="devices-content">
      <div class="auto-connect-toggle">
        <div class="toggle-switch" id="autoConnectToggle">
          <div class="toggle-knob"></div>
        </div>
        <div>
          <div style="font-weight: 600; margin-bottom: 4px;">Auto-connect</div>
          <div style="font-size: 12px; color: var(--sub);">Automatically reconnect to last device</div>
        </div>
      </div>
      
      <div class="device-card">
        <div class="device-info">
          <div class="device-icon">üì°</div>
          <div class="device-details">
            <h3>Laser Measure Device</h3>
            <div class="device-status" id="deviceStatus">Not connected</div>
          </div>
        </div>
        <div class="device-actions">
          <button class="device-btn primary" id="connectDeviceBtn">Connect</button>
          <button class="device-btn" id="disconnectDeviceBtn" disabled>Disconnect</button>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 16px; background: var(--panel); border: 1px solid var(--muted); border-radius: 8px;">
        <div style="font-size: 12px; color: var(--sub); line-height: 1.4;">
          <strong>Requirements for Web Bluetooth:</strong><br>
          ‚Ä¢ HTTPS connection required (not HTTP)<br>
          ‚Ä¢ Chrome/Edge browser (Safari not supported)<br>
          ‚Ä¢ Bluetooth permissions enabled<br>
          ‚Ä¢ Device must be in pairing mode<br><br>
          <strong>Supported devices:</strong><br>
          Leica DISTO series, Bosch GLM series, and other Bluetooth-enabled laser measuring devices.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>

  <!-- Hidden file inputs -->
  <input type="file" id="fileInput" accept="image/*" class="hidden" />
  <input type="file" id="pdfInput" accept=".pdf" class="hidden" />

<script>
(() => {
  // State with preserved measurement data structure per spec
  const state = {
    currentScreen: 'home',
    currentProject: null,
    itemTitle: 'New Project',
    tool: 'line',
    activeColor: '#1e90ff',
    lineWidth: 3,
    units: 'imperial',
    tagPrefix: 'A',
    tagCounter: 1,
    shapes: [], // Each shape stores: endpoints [x1,y1],[x2,y2], value, callout [cx,cy], leaderAnchor (parametric t), style
    selectedShape: null,
    dragging: null,
    image: null,
    imageNaturalSize: {w: 0, h: 0},
    zoom: 1,
    history: [],
    measurementHistory: [], // Running list of measurements from laser/manual
    bluetooth: {device: null, connected: false, measuring: false, autoConnect: false},
    contextMenuVisible: false,
    keypadVisible: false,
    sourceChooserVisible: false,
    capturedImageData: null,
    projects: [], // {id, name, createdAt, lastOpened}
    recentProjects: [],
    branding: {
      menuLogo: null, // DataURL for menu logo
      watermarkLogo: null // DataURL for watermark logo
    }
  };

  // Elements
  const homeScreen = document.getElementById('homeScreen');
  const appInterface = document.getElementById('appInterface');
  const organizerScreen = document.getElementById('organizerScreen');
  const settingsScreen = document.getElementById('settingsScreen');
  const myDevicesScreen = document.getElementById('myDevicesScreen');
  const sideMenu = document.getElementById('sideMenu');
  const menuOverlay = document.getElementById('menuOverlay');
  const contextMenu = document.getElementById('contextMenu');
  const measurementKeypad = document.getElementById('measurementKeypad');
  const sourceChooser = document.getElementById('sourceChooser');
  const captureScreen = document.getElementById('captureScreen');
  const exportDialog = document.getElementById('exportDialog');
  const toast = document.getElementById('toast');
  
  const imageCanvas = document.getElementById('imageCanvas');
  const drawCanvas = document.getElementById('drawCanvas');
  const container = document.getElementById('canvasContainer');
  const imgCtx = imageCanvas.getContext('2d');
  const drawCtx = drawCanvas.getContext('2d');

  // Initialize
  loadSettings();
  setupEventListeners();
  showScreen('home');
  updateLogos();

  function setupEventListeners() {
    // Home screen
    document.getElementById('homeMenuBtn').addEventListener('click', () => toggleSideMenu(true));
    document.getElementById('sketchOnPhotoCard').addEventListener('click', () => showSourceChooser());
    document.getElementById('organiserCard').addEventListener('click', () => showScreen('organizer'));

    // Side menu
    document.getElementById('sideMenuClose').addEventListener('click', () => toggleSideMenu(false));
    document.getElementById('menuSketchPhoto').addEventListener('click', () => {
      toggleSideMenu(false);
      showSourceChooser();
    });
    document.getElementById('menuOrganiser').addEventListener('click', () => {
      toggleSideMenu(false);
      showScreen('organizer');
    });
    document.getElementById('menuMyDevices').addEventListener('click', () => {
      toggleSideMenu(false);
      showScreen('devices');
    });
    document.getElementById('menuSettings').addEventListener('click', () => {
      toggleSideMenu(false);
      showScreen('settings');
    });

    menuOverlay.addEventListener('click', () => toggleSideMenu(false));

    // Organizer
    document.getElementById('organizerBack').addEventListener('click', () => showScreen('home'));
    document.getElementById('organizerAdd').addEventListener('click', addNewProject);

    // Settings
    document.getElementById('settingsBack').addEventListener('click', () => showScreen('home'));
    
    // Logo uploads
    document.getElementById('menuLogoUpload').addEventListener('click', () => {
      document.getElementById('menuLogoInput').click();
    });
    document.getElementById('menuLogoInput').addEventListener('change', (e) => {
      handleLogoUpload(e, 'menu');
    });
    document.getElementById('menuLogoRemove').addEventListener('click', () => {
      removeLogo('menu');
    });
    
    document.getElementById('watermarkLogoUpload').addEventListener('click', () => {
      document.getElementById('watermarkLogoInput').click();
    });
    document.getElementById('watermarkLogoInput').addEventListener('change', (e) => {
      handleLogoUpload(e, 'watermark');
    });
    document.getElementById('watermarkLogoRemove').addEventListener('click', () => {
      removeLogo('watermark');
    });

    // App interface
    document.getElementById('emrynLogo').addEventListener('click', () => toggleSideMenu(true));
    document.getElementById('backBtn').addEventListener('click', () => showScreen('home'));
    document.getElementById('undoBtn').addEventListener('click', undo);
    document.getElementById('exportBtn').addEventListener('click', showExportDialog);
    document.getElementById('newBtn').addEventListener('click', () => showSourceChooser());

    // Tools
    document.getElementById('lineToolBtn').addEventListener('click', () => setTool('line'));
    document.getElementById('manualMeasureBtn').addEventListener('click', () => showMeasurementKeypad());

    // Laser control
    document.getElementById('laserBtn').addEventListener('click', handleLaserClick);

    // Context menu
    document.getElementById('contextEdit').addEventListener('click', () => {
      hideContextMenu();
      showMeasurementKeypad();
    });
    document.getElementById('contextDuplicate').addEventListener('click', () => {
      hideContextMenu();
      duplicateSelected();
    });
    document.getElementById('contextAddText').addEventListener('click', () => {
      hideContextMenu();
      addTextToSelected();
    });
    document.getElementById('contextMoveToProject').addEventListener('click', () => {
      hideContextMenu();
      showMoveToProjectDialog();
    });
    document.getElementById('contextDelete').addEventListener('click', () => {
      hideContextMenu();
      deleteSelected();
    });

    // Source chooser
    document.getElementById('chooserCamera').addEventListener('click', () => {
      hideSourceChooser();
      openCamera();
    });
    document.getElementById('chooserGallery').addEventListener('click', () => {
      hideSourceChooser();
      document.getElementById('fileInput').click();
    });
    document.getElementById('chooserPdf').addEventListener('click', () => {
      hideSourceChooser();
      document.getElementById('pdfInput').click();
    });
    document.getElementById('chooserCancel').addEventListener('click', hideSourceChooser);

    // Capture screen
    document.getElementById('retakeBtn').addEventListener('click', retakePhoto);
    document.getElementById('usePhotoBtn').addEventListener('click', usePhoto);

    // File inputs
    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) loadImageFile(file);
    });

    document.getElementById('pdfInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) loadPdfFile(file);
    });

    // Measurement keypad
    document.getElementById('keypadClose').addEventListener('click', hideMeasurementKeypad);
    document.getElementById('keypadCancel').addEventListener('click', hideMeasurementKeypad);
    document.getElementById('keypadApply').addEventListener('click', applyManualMeasurement);

    // Export dialog
    document.getElementById('exportCancel').addEventListener('click', hideExportDialog);
    document.getElementById('exportConfirm').addEventListener('click', confirmExport);

    // My Devices screen
    document.getElementById('devicesBack').addEventListener('click', () => showScreen('home'));
    document.getElementById('connectDeviceBtn').addEventListener('click', connectBluetooth);
    document.getElementById('disconnectDeviceBtn').addEventListener('click', disconnectBluetooth);
    document.getElementById('autoConnectToggle').addEventListener('click', toggleAutoConnect);

    // History
    document.getElementById('clearHistoryBtn').addEventListener('click', clearMeasurementHistory);

    // Canvas interactions
    setupCanvasEvents();

    // Hide overlays when clicking outside
    document.addEventListener('click', (e) => {
      if (state.contextMenuVisible && !contextMenu.contains(e.target)) {
        hideContextMenu();
      }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideContextMenu();
        hideMeasurementKeypad();
        hideSourceChooser();
        hideExportDialog();
      }
      if (e.key === 'Delete' && state.selectedShape) {
        deleteSelected();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
        e.preventDefault();
        undo();
      }
    });
  }

  function loadSettings() {
    try {
      const savedProjects = localStorage.getItem('emryn_projects');
      if (savedProjects) {
        state.projects = JSON.parse(savedProjects);
      }
      
      const savedRecentProjects = localStorage.getItem('emryn_recent_projects');
      if (savedRecentProjects) {
        state.recentProjects = JSON.parse(savedRecentProjects);
      }

      const savedMenuLogo = localStorage.getItem('emryn_menu_logo');
      if (savedMenuLogo) {
        state.branding.menuLogo = savedMenuLogo;
      }

      const savedWatermarkLogo = localStorage.getItem('emryn_watermark_logo');
      if (savedWatermarkLogo) {
        state.branding.watermarkLogo = savedWatermarkLogo;
      }

      const savedAutoConnect = localStorage.getItem('emryn_auto_connect');
      if (savedAutoConnect) {
        state.bluetooth.autoConnect = JSON.parse(savedAutoConnect);
      }
    } catch (e) {
      console.warn('Failed to load settings:', e);
    }
  }

  function saveSettings() {
    try {
      localStorage.setItem('emryn_projects', JSON.stringify(state.projects));
      localStorage.setItem('emryn_recent_projects', JSON.stringify(state.recentProjects));
      localStorage.setItem('emryn_auto_connect', JSON.stringify(state.bluetooth.autoConnect));
      
      if (state.branding.menuLogo) {
        localStorage.setItem('emryn_menu_logo', state.branding.menuLogo);
      }
      
      if (state.branding.watermarkLogo) {
        localStorage.setItem('emryn_watermark_logo', state.branding.watermarkLogo);
      }
    } catch (e) {
      console.warn('Failed to save settings:', e);
    }
  }

  function showScreen(screen) {
    // Hide all screens
    homeScreen.classList.toggle('hidden', screen !== 'home');
    organizerScreen.classList.toggle('visible', screen === 'organizer');
    settingsScreen.classList.toggle('visible', screen === 'settings');
    myDevicesScreen.classList.toggle('visible', screen === 'devices');
    appInterface.classList.toggle('hidden', screen !== 'app');

    state.currentScreen = screen;

    // Update screen content
    if (screen === 'organizer') {
      renderProjects();
    } else if (screen === 'settings') {
      updateLogoPreviewsInSettings();
    } else if (screen === 'devices') {
      updateDeviceStatus();
    }
  }

  function toggleSideMenu(show) {
    sideMenu.classList.toggle('open', show);
    menuOverlay.classList.toggle('visible', show);
  }

  function showSourceChooser() {
    sourceChooser.classList.add('visible');
    state.sourceChooserVisible = true;
  }

  function hideSourceChooser() {
    sourceChooser.classList.remove('visible');
    state.sourceChooserVisible = false;
  }

  function showCaptureScreen(imageSrc) {
    const captureImage = document.getElementById('captureImage');
    captureImage.src = imageSrc;
    captureScreen.classList.add('visible');
  }

  function hideCaptureScreen() {
    captureScreen.classList.remove('visible');
  }

  async function openCamera() {
    try {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('Camera not available on this device', 'error');
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'environment' } 
      });
      
      const video = document.createElement('video');
      video.srcObject = stream;
      video.autoplay = true;
      video.playsInline = true;

      video.addEventListener('loadedmetadata', () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        ctx.drawImage(video, 0, 0);
        const imageSrc = canvas.toDataURL('image/jpeg', 0.9);
        
        stream.getTracks().forEach(track => track.stop());
        
        state.capturedImageData = imageSrc;
        showCaptureScreen(imageSrc);
      });
      
    } catch (error) {
      console.error('Camera error:', error);
      showToast(`Camera access failed: ${error.message}`, 'error');
    }
  }

  function retakePhoto() {
    hideCaptureScreen();
    openCamera();
  }

  function usePhoto() {
    if (state.capturedImageData) {
      loadImageFromData(state.capturedImageData);
      hideCaptureScreen();
      showScreen('app');
    }
  }

  function loadImageFile(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      loadImageFromData(e.target.result);
      showScreen('app');
    };
    reader.readAsDataURL(file);
  }

  function loadPdfFile(file) {
    showToast('PDF support coming soon', 'info');
  }

  function loadImageFromData(imageSrc) {
    const img = new Image();
    img.onload = () => {
      state.image = img;
      state.imageNaturalSize = {w: img.naturalWidth, h: img.naturalHeight};
      
      // Reset canvas and shapes
      state.shapes = [];
      state.selectedShape = null;
      
      // Resize canvases to fit image
      const maxWidth = container.clientWidth;
      const maxHeight = container.clientHeight;
      const ratio = Math.min(maxWidth / img.naturalWidth, maxHeight / img.naturalHeight);
      
      const displayWidth = img.naturalWidth * ratio;
      const displayHeight = img.naturalHeight * ratio;
      
      imageCanvas.width = displayWidth;
      imageCanvas.height = displayHeight;
      drawCanvas.width = displayWidth;
      drawCanvas.height = displayHeight;
      
      // Draw the image
      imgCtx.clearRect(0, 0, displayWidth, displayHeight);
      imgCtx.drawImage(img, 0, 0, displayWidth, displayHeight);
      
      redraw();
    };
    img.src = imageSrc;
  }

  function setupCanvasEvents() {
    let startPoint = null;
    let isDragging = false;
    let dragOffset = {x: 0, y: 0};

    function getEventPos(e) {
      const rect = drawCanvas.getBoundingClientRect();
      const clientX = e.clientX || (e.touches && e.touches[0].clientX);
      const clientY = e.clientY || (e.touches && e.touches[0].clientY);
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    function handleStart(e) {
      e.preventDefault();
      const pos = getEventPos(e);
      
      // Check if clicking on a shape or callout
      const clickedShape = findShapeAt(pos);
      if (clickedShape) {
        state.selectedShape = clickedShape;
        
        // Check if clicking on callout specifically
        if (clickedShape.callout && isPointInCallout(pos, clickedShape)) {
          isDragging = true;
          dragOffset = {
            x: pos.x - clickedShape.callout.x,
            y: pos.y - clickedShape.callout.y
          };
          state.dragging = {type: 'callout', shape: clickedShape};
        } else {
          // Show context menu on long press or right click
          if (e.type === 'contextmenu' || e.type === 'touchstart') {
            setTimeout(() => {
              if (!isDragging) {
                showContextMenu(pos.x, pos.y);
              }
            }, 500);
          }
        }
        redraw();
        return;
      }

      // Start drawing new line if in line tool mode
      if (state.tool === 'line') {
        startPoint = pos;
        state.selectedShape = null;
        hideContextMenu();
        redraw();
      }
    }

    function handleMove(e) {
      e.preventDefault();
      const pos = getEventPos(e);

      if (state.dragging && state.dragging.type === 'callout') {
        // Update callout position
        const shape = state.dragging.shape;
        shape.callout.x = pos.x - dragOffset.x;
        shape.callout.y = pos.y - dragOffset.y;
        
        // Update leader anchor based on closest point on line
        const [x1, y1] = shape.endpoints[0];
        const [x2, y2] = shape.endpoints[1];
        const t = getClosestPointOnLine(shape.callout, {x: x1, y: y1}, {x: x2, y: y2});
        shape.leaderAnchor = Math.max(0, Math.min(1, t));
        
        redraw();
        return;
      }

      if (startPoint && state.tool === 'line') {
        redraw();
        // Draw preview line
        drawCtx.strokeStyle = state.activeColor;
        drawCtx.lineWidth = state.lineWidth;
        drawCtx.beginPath();
        drawCtx.moveTo(startPoint.x, startPoint.y);
        drawCtx.lineTo(pos.x, pos.y);
        drawCtx.stroke();
      }
    }

    function handleEnd(e) {
      e.preventDefault();
      const pos = getEventPos(e);

      if (state.dragging) {
        state.dragging = null;
        isDragging = false;
        return;
      }

      if (startPoint && state.tool === 'line') {
        // Create new measurement line
        const distance = Math.sqrt(
          Math.pow(pos.x - startPoint.x, 2) + 
          Math.pow(pos.y - startPoint.y, 2)
        );
        
        if (distance > 10) { // Minimum line length
          const shape = {
            id: Date.now(),
            endpoints: [[startPoint.x, startPoint.y], [pos.x, pos.y]],
            value: formatMeasurement(distance * 0.1), // Placeholder conversion
            callout: {
              x: (startPoint.x + pos.x) / 2,
              y: (startPoint.y + pos.y) / 2 - 30
            },
            leaderAnchor: 0.5,
            style: {
              color: state.activeColor,
              lineWidth: state.lineWidth
            }
          };
          
          state.shapes.push(shape);
          saveToHistory();
        }
        
        startPoint = null;
        redraw();
      }
    }

    // Mouse events
    drawCanvas.addEventListener('mousedown', handleStart);
    drawCanvas.addEventListener('mousemove', handleMove);
    drawCanvas.addEventListener('mouseup', handleEnd);
    drawCanvas.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const pos = getEventPos(e);
      const shape = findShapeAt(pos);
      if (shape) {
        state.selectedShape = shape;
        showContextMenu(pos.x, pos.y);
        redraw();
      }
    });

    // Touch events
    drawCanvas.addEventListener('touchstart', handleStart);
    drawCanvas.addEventListener('touchmove', handleMove);
    drawCanvas.addEventListener('touchend', handleEnd);
  }

  function findShapeAt(point) {
    for (let i = state.shapes.length - 1; i >= 0; i--) {
      const shape = state.shapes[i];
      
      // Check callout first
      if (shape.callout && isPointInCallout(point, shape)) {
        return shape;
      }
      
      // Check line
      if (isPointOnLine(point, shape.endpoints[0], shape.endpoints[1])) {
        return shape;
      }
    }
    return null;
  }

  function isPointInCallout(point, shape) {
    const callout = shape.callout;
    const text = shape.value;
    const textWidth = drawCtx.measureText(text).width + 16;
    const textHeight = 24;
    
    return point.x >= callout.x - textWidth/2 && 
           point.x <= callout.x + textWidth/2 &&
           point.y >= callout.y - textHeight/2 && 
           point.y <= callout.y + textHeight/2;
  }

  function isPointOnLine(point, start, end) {
    const dist = distanceToLineSegment(point, start, end);
    return dist < 10; // 10px tolerance
  }

  function distanceToLineSegment(point, start, end) {
    const A = point.x - start[0];
    const B = point.y - start[1];
    const C = end[0] - start[0];
    const D = end[1] - start[1];

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    
    if (lenSq === 0) return Math.sqrt(A * A + B * B);
    
    let param = dot / lenSq;
    param = Math.max(0, Math.min(1, param));
    
    const xx = start[0] + param * C;
    const yy = start[1] + param * D;
    
    const dx = point.x - xx;
    const dy = point.y - yy;
    
    return Math.sqrt(dx * dx + dy * dy);
  }

  function getClosestPointOnLine(point, start, end) {
    const A = point.x - start.x;
    const B = point.y - start.y;
    const C = end.x - start.x;
    const D = end.y - start.y;

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    
    if (lenSq === 0) return 0;
    
    return dot / lenSq;
  }

  function redraw() {
    drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
    
    state.shapes.forEach(shape => {
      drawShape(shape);
    });
  }

  function drawShape(shape) {
    const [x1, y1] = shape.endpoints[0];
    const [x2, y2] = shape.endpoints[1];
    
    // Draw main line
    drawCtx.strokeStyle = shape.style.color;
    drawCtx.lineWidth = shape.style.lineWidth;
    drawCtx.beginPath();
    drawCtx.moveTo(x1, y1);
    drawCtx.lineTo(x2, y2);
    drawCtx.stroke();
    
    // Draw callout and leader line
    if (shape.callout) {
      // Calculate leader line anchor point
      const t = shape.leaderAnchor || 0.5;
      const anchorX = x1 + t * (x2 - x1);
      const anchorY = y1 + t * (y2 - y1);
      
      // Draw dashed leader line
      drawCtx.strokeStyle = shape.style.color;
      drawCtx.lineWidth = 1;
      drawCtx.setLineDash([5, 5]);
      drawCtx.beginPath();
      drawCtx.moveTo(anchorX, anchorY);
      drawCtx.lineTo(shape.callout.x, shape.callout.y);
      drawCtx.stroke();
      drawCtx.setLineDash([]);
      
      // Draw callout box
      const text = shape.value;
      drawCtx.font = '12px Arial';
      const textWidth = drawCtx.measureText(text).width;
      const padding = 8;
      const boxWidth = textWidth + padding * 2;
      const boxHeight = 20;
      
      drawCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
      drawCtx.fillRect(
        shape.callout.x - boxWidth/2, 
        shape.callout.y - boxHeight/2, 
        boxWidth, 
        boxHeight
      );
      
      drawCtx.strokeStyle = shape.style.color;
      drawCtx.lineWidth = 1;
      drawCtx.strokeRect(
        shape.callout.x - boxWidth/2, 
        shape.callout.y - boxHeight/2, 
        boxWidth, 
        boxHeight
      );
      
      // Draw text
      drawCtx.fillStyle = '#fff';
      drawCtx.textAlign = 'center';
      drawCtx.textBaseline = 'middle';
      drawCtx.fillText(text, shape.callout.x, shape.callout.y);
    }
    
    // Highlight if selected
    if (shape === state.selectedShape) {
      drawCtx.strokeStyle = '#ffff00';
      drawCtx.lineWidth = shape.style.lineWidth + 2;
      drawCtx.beginPath();
      drawCtx.moveTo(x1, y1);
      drawCtx.lineTo(x2, y2);
      drawCtx.stroke();
    }
  }

  function formatMeasurement(inches) {
    const feet = Math.floor(inches / 12);
    const remainingInches = inches % 12;
    const wholeInches = Math.floor(remainingInches);
    const fraction = remainingInches - wholeInches;
    
    let result = '';
    if (feet > 0) result += feet + "'";
    if (wholeInches > 0) result += wholeInches + '"';
    if (fraction > 0) {
      const fractionStr = decimalToFraction(fraction);
      result += fractionStr + '"';
    }
    
    return result || '0"';
  }

  function decimalToFraction(decimal) {
    const denominators = [64, 32, 16, 8, 4, 2];
    for (const denom of denominators) {
      const num = Math.round(decimal * denom);
      if (Math.abs(decimal - num / denom) < 0.01) {
        return num > 0 ? ` ${num}/${denom}` : '';
      }
    }
    return '';
  }

  function showContextMenu(x, y) {
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    contextMenu.classList.add('visible');
    state.contextMenuVisible = true;
  }

  function hideContextMenu() {
    contextMenu.classList.remove('visible');
    state.contextMenuVisible = false;
  }

  function showMeasurementKeypad() {
    // Pre-fill with current measurement if editing
    if (state.selectedShape) {
      const measurement = parseMeasurement(state.selectedShape.value);
      document.getElementById('feetInput').value = measurement.feet || '';
      document.getElementById('inchesInput').value = measurement.inches || '';
      document.getElementById('numInput').value = measurement.numerator || '';
      document.getElementById('denomInput').value = measurement.denominator || 8;
    } else {
      // Clear inputs for new measurement
      document.getElementById('feetInput').value = '';
      document.getElementById('inchesInput').value = '';
      document.getElementById('numInput').value = '';
      document.getElementById('denomInput').value = 8;
    }
    
    measurementKeypad.classList.add('visible');
    state.keypadVisible = true;
  }

  function hideMeasurementKeypad() {
    measurementKeypad.classList.remove('visible');
    state.keypadVisible = false;
  }

  function applyManualMeasurement() {
    const feet = parseInt(document.getElementById('feetInput').value) || 0;
    const inches = parseInt(document.getElementById('inchesInput').value) || 0;
    const numerator = parseInt(document.getElementById('numInput').value) || 0;
    const denominator = parseInt(document.getElementById('denomInput').value) || 8;
    
    // Normalize inches (12 inches = 1 foot)
    const totalInches = feet * 12 + inches + numerator / denominator;
    const normalizedFeet = Math.floor(totalInches / 12);
    const remainingInches = totalInches % 12;
    const wholeInches = Math.floor(remainingInches);
    const fraction = remainingInches - wholeInches;
    
    // Format the measurement
    let formatted = '';
    if (normalizedFeet > 0) formatted += normalizedFeet + "'";
    if (wholeInches > 0) formatted += wholeInches + '"';
    if (fraction > 0.01) {
      const fractionStr = decimalToFraction(fraction);
      formatted += fractionStr + '"';
    }
    
    const measurement = formatted || '0"';
    
    if (state.selectedShape) {
      // Update existing measurement
      state.selectedShape.value = measurement;
      redraw();
    } else {
      // Add to measurement history for next line draw
      addToMeasurementHistory(measurement);
    }
    
    hideMeasurementKeypad();
  }

  function parseMeasurement(measurement) {
    const result = {feet: 0, inches: 0, numerator: 0, denominator: 8};
    
    const feetMatch = measurement.match(/(\d+)'/);
    if (feetMatch) result.feet = parseInt(feetMatch[1]);
    
    const inchMatch = measurement.match(/(\d+)"/);
    if (inchMatch) result.inches = parseInt(inchMatch[1]);
    
    const fractionMatch = measurement.match(/(\d+)\/(\d+)"/);
    if (fractionMatch) {
      result.numerator = parseInt(fractionMatch[1]);
      result.denominator = parseInt(fractionMatch[2]);
    }
    
    return result;
  }

  function addToMeasurementHistory(measurement) {
    state.measurementHistory.unshift(measurement);
    state.measurementHistory = state.measurementHistory.slice(0, 10); // Keep last 10
    renderMeasurementHistory();
  }

  function renderMeasurementHistory() {
    const historyList = document.getElementById('historyList');
    
    if (state.measurementHistory.length === 0) {
      historyList.innerHTML = '<div style="color: var(--sub); font-size: 11px; text-align: center; width: 100%;">Measurements from laser or manual entry will appear here</div>';
      return;
    }
    
    historyList.innerHTML = '';
    state.measurementHistory.forEach(measurement => {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.textContent = measurement;
      item.addEventListener('click', () => {
        // Use this measurement for next shape
        if (state.selectedShape) {
          state.selectedShape.value = measurement;
          redraw();
        }
      });
      historyList.appendChild(item);
    });
  }

  function clearMeasurementHistory() {
    state.measurementHistory = [];
    renderMeasurementHistory();
  }

  function duplicateSelected() {
    if (!state.selectedShape) return;
    
    const shape = state.selectedShape;
    const newShape = {
      id: Date.now(),
      endpoints: [
        [shape.endpoints[0][0] + 20, shape.endpoints[0][1] + 20],
        [shape.endpoints[1][0] + 20, shape.endpoints[1][1] + 20]
      ],
      value: shape.value,
      callout: {
        x: shape.callout.x + 20,
        y: shape.callout.y + 20
      },
      leaderAnchor: shape.leaderAnchor,
      style: {...shape.style}
    };
    
    state.shapes.push(newShape);
    state.selectedShape = newShape;
    saveToHistory();
    redraw();
  }

  function addTextToSelected() {
    if (!state.selectedShape) return;
    
    const text = prompt('Enter text label:');
    if (text) {
      state.selectedShape.value = text;
      redraw();
    }
  }

  function showMoveToProjectDialog() {
    if (state.projects.length === 0) {
      showToast('No projects available. Create a project first.', 'info');
      return;
    }
    
    // Simple implementation - show alert with project names
    const projectNames = state.projects.map((p, i) => `${i + 1}. ${p.name}`).join('\n');
    const choice = prompt(`Move to project:\n${projectNames}\n\nEnter project number:`);
    
    if (choice && !isNaN(choice)) {
      const index = parseInt(choice) - 1;
      if (index >= 0 && index < state.projects.length) {
        const project = state.projects[index];
        showToast(`Moved to project: ${project.name}`, 'info');
      }
    }
  }

  function deleteSelected() {
    if (!state.selectedShape) return;
    
    const index = state.shapes.indexOf(state.selectedShape);
    if (index >= 0) {
      state.shapes.splice(index, 1);
      state.selectedShape = null;
      saveToHistory();
      redraw();
    }
  }

  function undo() {
    if (state.history.length > 0) {
      const previousState = state.history.pop();
      state.shapes = previousState.shapes;
      state.selectedShape = null;
      redraw();
    }
  }

  function saveToHistory() {
    state.history.push({
      shapes: JSON.parse(JSON.stringify(state.shapes))
    });
    // Keep last 20 states
    if (state.history.length > 20) {
      state.history.shift();
    }
  }

  function setTool(tool) {
    state.tool = tool;
    state.selectedShape = null;
    redraw();
  }

  // Project Management
  function addNewProject() {
    const name = prompt('Project name:');
    if (name && name.trim()) {
      const project = {
        id: Date.now(),
        name: name.trim(),
        createdAt: new Date(),
        lastOpened: new Date()
      };
      
      state.projects.unshift(project);
      addToRecentProjects(project);
      saveSettings();
      renderProjects();
      showToast(`Created project: ${name}`, 'info');
    }
  }

  function addToRecentProjects(project) {
    state.recentProjects = state.recentProjects.filter(p => p.id !== project.id);
    state.recentProjects.unshift(project);
    state.recentProjects = state.recentProjects.slice(0, 5); // Keep last 5
  }

  function renderProjects() {
    renderProjectList('recentProjectsList', state.recentProjects, 'No recent projects');
    renderProjectList('allProjectsList', state.projects, 'No projects yet. Tap + to create your first project.');
  }

  function renderProjectList(containerId, projects, emptyMessage) {
    const container = document.getElementById(containerId);
    
    if (projects.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">${containerId === 'recentProjectsList' ? 'üìÑ' : 'üìÇ'}</div>
          <div>${emptyMessage}</div>
        </div>
      `;
      return;
    }
    
    container.innerHTML = '';
    projects.forEach(project => {
      const item = document.createElement('div');
      item.className = 'project-item';
      item.innerHTML = `
        <div class="project-icon">üìÑ</div>
        <div class="project-details">
          <div class="project-name">${project.name}</div>
          <div class="project-date">${new Date(project.lastOpened).toLocaleDateString()}</div>
        </div>
        <div class="project-actions">
          <button class="project-action-btn" title="Rename" onclick="renameProject('${project.id}')">‚úèÔ∏è</button>
          <button class="project-action-btn danger" title="Delete" onclick="deleteProject('${project.id}')">üóë</button>
        </div>
      `;
      
      item.addEventListener('click', (e) => {
        if (!e.target.classList.contains('project-action-btn')) {
          openProject(project);
        }
      });
      
      container.appendChild(item);
    });
  }

  function openProject(project) {
    state.currentProject = project;
    state.itemTitle = project.name;
    project.lastOpened = new Date();
    addToRecentProjects(project);
    saveSettings();
    
    document.getElementById('projectInfo').textContent = project.name;
    showToast(`Opened project: ${project.name}`, 'info');
    showScreen('app');
  }

  window.renameProject = function(projectId) {
    const project = state.projects.find(p => p.id == projectId);
    if (!project) return;
    
    const newName = prompt('New project name:', project.name);
    if (newName && newName.trim() && newName.trim() !== project.name) {
      project.name = newName.trim();
      saveSettings();
      renderProjects();
      showToast(`Renamed to: ${newName}`, 'info');
    }
  };

  window.deleteProject = function(projectId) {
    const project = state.projects.find(p => p.id == projectId);
    if (!project) return;
    
    if (confirm(`Delete project "${project.name}"? This cannot be undone.`)) {
      state.projects = state.projects.filter(p => p.id != projectId);
      state.recentProjects = state.recentProjects.filter(p => p.id != projectId);
      saveSettings();
      renderProjects();
      showToast(`Deleted project: ${project.name}`, 'info');
    }
  };

  // Logo Management
  function handleLogoUpload(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
      showToast('Please select an image file', 'error');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      
      if (type === 'menu') {
        state.branding.menuLogo = dataUrl;
        localStorage.setItem('emryn_menu_logo', dataUrl);
      } else if (type === 'watermark') {
        state.branding.watermarkLogo = dataUrl;
        localStorage.setItem('emryn_watermark_logo', dataUrl);
      }
      
      updateLogos();
      updateLogoPreviewsInSettings();
      showToast(`${type === 'menu' ? 'Menu' : 'Watermark'} logo uploaded`, 'info');
    };
    
    reader.readAsDataURL(file);
    event.target.value = ''; // Reset input
  }

  function removeLogo(type) {
    if (type === 'menu') {
      state.branding.menuLogo = null;
      localStorage.removeItem('emryn_menu_logo');
    } else if (type === 'watermark') {
      state.branding.watermarkLogo = null;
      localStorage.removeItem('emryn_watermark_logo');
    }
    
    updateLogos();
    updateLogoPreviewsInSettings();
    showToast(`${type === 'menu' ? 'Menu' : 'Watermark'} logo removed`, 'info');
  }

  function updateLogos() {
    const defaultLogo = "data:image/svg+xml,%3Csvg viewBox='0 0 200 50' xmlns='http://www.w3.org/2000/svg'%3E%3Ctext x='10' y='35' font-family='Arial, sans-serif' font-size='32' font-weight='bold' fill='%23004025'%3EEMRYN%3C/text%3E%3C/svg%3E";
    
    // Update all menu logos
    const menuLogos = document.querySelectorAll('#homeMenuBtn, #sideMenuLogo, #emrynLogo');
    const logoSrc = state.branding.menuLogo || defaultLogo;
    
    menuLogos.forEach(logo => {
      logo.src = logoSrc;
      if (state.branding.menuLogo) {
        logo.style.filter = logo.id === 'sideMenuLogo' || logo.id === 'emrynLogo' ? 'invert(1)' : 'none';
      }
    });
  }

  function updateLogoPreviewsInSettings() {
    const menuPreview = document.getElementById('menuLogoPreview');
    const watermarkPreview = document.getElementById('watermarkLogoPreview');
    
    if (state.branding.menuLogo) {
      menuPreview.innerHTML = `<img src="${state.branding.menuLogo}" alt="Menu logo" />`;
    } else {
      menuPreview.innerHTML = '<div class="logo-preview-placeholder">No logo</div>';
    }
    
    if (state.branding.watermarkLogo) {
      watermarkPreview.innerHTML = `<img src="${state.branding.watermarkLogo}" alt="Watermark logo" />`;
    } else {
      watermarkPreview.innerHTML = '<div class="logo-preview-placeholder">No logo</div>';
    }
  }

  // Export functionality
  function showExportDialog() {
    const filename = state.currentProject ? state.currentProject.name : state.itemTitle;
    document.getElementById('exportFilename').value = filename;
    exportDialog.classList.add('visible');
  }

  function hideExportDialog() {
    exportDialog.classList.remove('visible');
  }

  function confirmExport() {
    const filename = document.getElementById('exportFilename').value.trim();
    if (!filename) {
      showToast('Please enter a filename', 'error');
      return;
    }
    
    exportImage(filename);
    hideExportDialog();
  }

  function exportImage(filename) {
    if (!state.image) {
      showToast('No image to export', 'error');
      return;
    }
    
    // Create export canvas
    const exportCanvas = document.createElement('canvas');
    const exportCtx = exportCanvas.getContext('2d');
    
    // Use original image dimensions
    exportCanvas.width = state.imageNaturalSize.w;
    exportCanvas.height = state.imageNaturalSize.h;
    
    // Draw original image
    exportCtx.drawImage(state.image, 0, 0);
    
    // Scale factor from display to original
    const scaleX = state.imageNaturalSize.w / imageCanvas.width;
    const scaleY = state.imageNaturalSize.h / imageCanvas.height;
    
    // Draw shapes scaled to original dimensions
    state.shapes.forEach(shape => {
      const [x1, y1] = shape.endpoints[0];
      const [x2, y2] = shape.endpoints[1];
      
      // Scale coordinates
      const scaledX1 = x1 * scaleX;
      const scaledY1 = y1 * scaleY;
      const scaledX2 = x2 * scaleX;
      const scaledY2 = y2 * scaleY;
      
      // Draw main line
      exportCtx.strokeStyle = shape.style.color;
      exportCtx.lineWidth = shape.style.lineWidth * Math.min(scaleX, scaleY);
      exportCtx.beginPath();
      exportCtx.moveTo(scaledX1, scaledY1);
      exportCtx.lineTo(scaledX2, scaledY2);
      exportCtx.stroke();
      
      // Draw callout and leader
      if (shape.callout) {
        const scaledCalloutX = shape.callout.x * scaleX;
        const scaledCalloutY = shape.callout.y * scaleY;
        
        // Leader line anchor
        const t = shape.leaderAnchor || 0.5;
        const anchorX = scaledX1 + t * (scaledX2 - scaledX1);
        const anchorY = scaledY1 + t * (scaledY2 - scaledY1);
        
        // Draw dashed leader line
        exportCtx.strokeStyle = shape.style.color;
        exportCtx.lineWidth = Math.min(scaleX, scaleY);
        exportCtx.setLineDash([5 * Math.min(scaleX, scaleY), 5 * Math.min(scaleX, scaleY)]);
        exportCtx.beginPath();
        exportCtx.moveTo(anchorX, anchorY);
        exportCtx.lineTo(scaledCalloutX, scaledCalloutY);
        exportCtx.stroke();
        exportCtx.setLineDash([]);
        
        // Draw callout box
        const fontSize = 16 * Math.min(scaleX, scaleY);
        exportCtx.font = `${fontSize}px Arial`;
        const textWidth = exportCtx.measureText(shape.value).width;
        const padding = 12 * Math.min(scaleX, scaleY);
        const boxWidth = textWidth + padding * 2;
        const boxHeight = fontSize + padding;
        
        exportCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        exportCtx.fillRect(
          scaledCalloutX - boxWidth/2, 
          scaledCalloutY - boxHeight/2, 
          boxWidth, 
          boxHeight
        );
        
        exportCtx.strokeStyle = shape.style.color;
        exportCtx.lineWidth = Math.min(scaleX, scaleY);
        exportCtx.strokeRect(
          scaledCalloutX - boxWidth/2, 
          scaledCalloutY - boxHeight/2, 
          boxWidth, 
          boxHeight
        );
        
        exportCtx.fillStyle = '#fff';
        exportCtx.textAlign = 'center';
        exportCtx.textBaseline = 'middle';
        exportCtx.fillText(shape.value, scaledCalloutX, scaledCalloutY);
      }
    });
    
    // Add watermark if available
    if (state.branding.watermarkLogo) {
      const watermarkImg = new Image();
      watermarkImg.onload = () => {
        const watermarkSize = Math.min(exportCanvas.width, exportCanvas.height) * 0.1;
        const margin = 20;
        
        // Draw in bottom-right corner
        exportCtx.globalAlpha = 0.7;
        exportCtx.drawImage(
          watermarkImg,
          exportCanvas.width - watermarkSize - margin,
          exportCanvas.height - watermarkSize - margin,
          watermarkSize,
          watermarkSize
        );
        exportCtx.globalAlpha = 1;
        
        // Add timestamp in opposite corner
        addTimestamp();
        downloadImage();
      };
      watermarkImg.src = state.branding.watermarkLogo;
    } else {
      addTimestamp();
      downloadImage();
    }
    
    function addTimestamp() {
      const timestamp = new Date().toLocaleString();
      const fontSize = 14 * Math.min(scaleX, scaleY);
      exportCtx.font = `${fontSize}px Arial`;
      exportCtx.textAlign = 'left';
      exportCtx.textBaseline = 'top';
      
      // Background box for timestamp
      const textWidth = exportCtx.measureText(timestamp).width;
      const padding = 8 * Math.min(scaleX, scaleY);
      
      exportCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
      exportCtx.fillRect(20, 20, textWidth + padding * 2, fontSize + padding * 2);
      
      exportCtx.fillStyle = '#fff';
      exportCtx.fillText(timestamp, 20 + padding, 20 + padding);
    }
    
    function downloadImage() {
      exportCanvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`Exported: ${filename}.png`, 'info');
      }, 'image/png');
    }
  }

  // Bluetooth functionality
  function updateDeviceStatus() {
    const statusEl = document.getElementById('deviceStatus');
    const connectBtn = document.getElementById('connectDeviceBtn');
    const disconnectBtn = document.getElementById('disconnectDeviceBtn');
    const laserBtn = document.getElementById('laserBtn');
    const laserStatus = document.getElementById('laserStatus');
    const autoConnectToggle = document.getElementById('autoConnectToggle');
    
    if (state.bluetooth.connected) {
      statusEl.textContent = 'Connected';
      statusEl.classList.add('connected');
      connectBtn.disabled = true;
      disconnectBtn.disabled = false;
      laserBtn.classList.add('connected');
      laserStatus.textContent = state.bluetooth.measuring ? 'MEASURING' : 'READY';
    } else {
      statusEl.textContent = 'Not connected';
      statusEl.classList.remove('connected');
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      laserBtn.classList.remove('connected');
      laserStatus.textContent = 'OFF';
    }
    
    autoConnectToggle.classList.toggle('active', state.bluetooth.autoConnect);
  }

  async function connectBluetooth() {
    if (!navigator.bluetooth) {
      showToast('Web Bluetooth not supported. Use Chrome/Edge with HTTPS.', 'error');
      return;
    }
    
    try {
      // Request device with common laser measure service UUIDs
      const device = await navigator.bluetooth.requestDevice({
        filters: [
          { services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }, // Common BLE service
          { namePrefix: 'DISTO' },
          { namePrefix: 'GLM' },
          { namePrefix: 'Laser' }
        ],
        optionalServices: [
          '0000ffe0-0000-1000-8000-00805f9b34fb',
          '0000ffe1-0000-1000-8000-00805f9b34fb'
        ]
      });
      
      const server = await device.gatt.connect();
      state.bluetooth.device = device;
      state.bluetooth.connected = true;
      
      // Set up disconnect listener
      device.addEventListener('gattserverdisconnected', () => {
        state.bluetooth.connected = false;
        state.bluetooth.device = null;
        updateDeviceStatus();
        showToast('Device disconnected', 'warning');
      });
      
      updateDeviceStatus();
      showToast(`Connected to ${device.name}`, 'info');
      
    } catch (error) {
      console.error('Bluetooth connection error:', error);
      showToast(`Connection failed: ${error.message}`, 'error');
    }
  }

  function disconnectBluetooth() {
    if (state.bluetooth.device && state.bluetooth.device.gatt.connected) {
      state.bluetooth.device.gatt.disconnect();
    }
    state.bluetooth.connected = false;
    state.bluetooth.device = null;
    state.bluetooth.measuring = false;
    updateDeviceStatus();
    showToast('Disconnected', 'info');
  }

  function toggleAutoConnect() {
    state.bluetooth.autoConnect = !state.bluetooth.autoConnect;
    updateDeviceStatus();
    saveSettings();
    showToast(`Auto-connect ${state.bluetooth.autoConnect ? 'enabled' : 'disabled'}`, 'info');
  }

  async function handleLaserClick() {
    if (!state.bluetooth.connected) {
      showToast('Connect laser device first', 'warning');
      return;
    }
    
    if (state.bluetooth.measuring) {
      // Stop measuring
      state.bluetooth.measuring = false;
      document.getElementById('laserBtn').classList.remove('measuring');
      updateDeviceStatus();
      return;
    }
    
    // Start measuring
    state.bluetooth.measuring = true;
    document.getElementById('laserBtn').classList.add('measuring');
    updateDeviceStatus();
    
    try {
      // Simulate laser measurement (replace with actual BLE communication)
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Generate simulated measurement
      const measurement = (Math.random() * 120 + 12).toFixed(1); // 1-10 feet range
      const formatted = formatMeasurement(parseFloat(measurement));
      
      addToMeasurementHistory(formatted);
      showToast(`Measured: ${formatted}`, 'info');
      
    } catch (error) {
      showToast(`Measurement failed: ${error.message}`, 'error');
    } finally {
      state.bluetooth.measuring = false;
      document.getElementById('laserBtn').classList.remove('measuring');
      updateDeviceStatus();
    }
  }

  // Toast notifications
  function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} visible`;
    
    setTimeout(() => {
      toast.classList.remove('visible');
    }, 3000);
  }

  // Initialize measurement history
  renderMeasurementHistory();