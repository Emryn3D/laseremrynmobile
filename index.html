<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Photo Measurement & Markup Tool</title>
<style>
  :root{
    --bg:#0e0f12; --panel:#151821; --muted:#272b36; --text:#e8ecf1; --sub:#b6c0cf;
    --accent:#69b3ff; --danger:#ff6b6b; --ok:#52d273; --warn:#ffd166; --ink:#12141b;
  }
  *{box-sizing:border-box}
  html,body{height:100%; overflow:hidden}
  body{
    margin:0; background:var(--bg); color:var(--text); font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    display:flex; flex-direction:column; position:relative;
  }

  /* Mobile header - compact and collapsible */
  .header{
    background:var(--panel); border-bottom:1px solid var(--muted); padding:8px 12px; 
    display:flex; align-items:center; gap:8px; flex-shrink:0; z-index:100;
  }
  .header .logo{
    width:28px;height:28px;border-radius:6px;background:var(--muted);
    display:flex;align-items:center;justify-content:center;font-weight:700;
  }
  .header .project-inputs{
    display:flex; gap:6px; flex:1; min-width:0;
  }
  .header input{
    background:transparent;border:1px solid var(--muted);color:var(--text);
    padding:6px 8px;border-radius:6px; flex:1; min-width:60px; font-size:13px;
  }
  .header .controls{
    display:flex; gap:6px; align-items:center;
  }
  .header button{
    background:var(--muted);border:1px solid #1f2330;color:var(--text);
    padding:6px 8px;border-radius:6px;cursor:pointer;font-size:12px;
    white-space:nowrap;
  }
  .header button:hover{filter:brightness(1.15)}

  /* Mobile sidebar - slides in from left */
  .sidebar{
    position:fixed; left:0; top:0; bottom:0; width:100vw; max-width:320px;
    background:var(--panel); border-right:1px solid var(--muted);
    transform:translateX(-100%); transition:transform 0.3s ease;
    overflow-y:auto; z-index:200; padding-top:60px;
  }
  .sidebar.open{transform:translateX(0)}
  .sidebar-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:150;
    opacity:0; pointer-events:none; transition:opacity 0.3s ease;
  }
  .sidebar-overlay.visible{opacity:1; pointer-events:auto}

  /* Panel styling for mobile */
  .panel{padding:12px 16px; border-bottom:1px solid var(--muted)}
  .panel h3{
    margin:0 0 12px; font-size:13px; font-weight:700; letter-spacing:.06em;
    text-transform:uppercase; color:var(--sub);
  }
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px}
  .row:last-child{margin-bottom:0}
  
  .panel input[type="text"], .panel input[type="number"], .panel select{
    background:transparent;border:1px solid var(--muted);color:var(--text);
    padding:8px 10px;border-radius:6px; min-height:44px;
  }
  .panel button{
    background:var(--muted);border:1px solid #1f2330;color:var(--text);
    padding:10px 12px;border-radius:6px;cursor:pointer; min-height:44px;
  }
  .panel button:hover{filter:brightness(1.15)}

  .swatch{
    width:36px;height:36px;border-radius:8px;border:2px solid transparent;
    cursor:pointer; transition:border-color 0.2s;
  }
  .swatch.selected{border-color:var(--accent)}

  .tool{
    padding:10px 12px;border-radius:6px;border:1px solid var(--muted);
    cursor:pointer;background:#1b1f2a; min-height:44px; flex:1; text-align:center;
  }
  .tool.active{border-color:var(--accent); background:var(--accent); color:var(--ink)}
  .danger{background:#2a171a;border-color:#4e1d25;color:#ffb5b5}
  .ok{background:#1a2a1f;border-color:#224b2f;color:#bdf0c9}

  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{
    background:#1b1f2a;border:1px solid var(--muted);padding:8px 12px;
    border-radius:999px;cursor:pointer; min-height:36px;
  }
  .chip:hover{filter:brightness(1.15)}

  .cap-toggle{display:flex; gap:8px}
  .cap-toggle label{
    display:flex; gap:6px; align-items:center; padding:8px 12px;
    border:1px solid var(--muted); border-radius:6px; cursor:pointer;
    flex:1; justify-content:center; min-height:44px;
  }
  .cap-toggle input{accent-color:var(--accent)}

  /* Main canvas area */
  .main{flex:1; position:relative; overflow:hidden; background:#0a0b0e}
  #canvasContainer{
    position:relative; width:100%; height:100%; 
    display:grid; place-items:center; touch-action:none;
  }
  #imageCanvas{background:#0b0e13; position:absolute; z-index:1}
  #drawCanvas{background:transparent; position:absolute; z-index:2; touch-action:none}

  /* Mobile toolbar at bottom */
  .mobile-toolbar{
    position:fixed; bottom:0; left:0; right:0;
    background:var(--panel); border-top:1px solid var(--muted);
    padding:8px 12px; display:flex; gap:8px; align-items:center;
    z-index:50;
  }
  .mobile-toolbar button{
    background:var(--muted);border:1px solid #1f2330;color:var(--text);
    padding:10px 12px;border-radius:6px;cursor:pointer; flex:1; font-size:12px;
    min-height:44px;
  }
  .mobile-toolbar button:hover{filter:brightness(1.15)}
  .mobile-toolbar .tool-group{display:flex; gap:4px; flex:2}

  /* Floating action button */
  .fab{
    position:fixed; top:70px; right:12px; z-index:80;
    width:48px; height:48px; border-radius:50%;
    background:var(--accent); color:var(--ink); border:none;
    display:flex; align-items:center; justify-content:center;
    font-size:18px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }
  .fab:hover{filter:brightness(1.1)}

  /* Zoom controls */
  .zoom-controls{
    position:fixed; right:12px; bottom:80px; z-index:80;
    display:flex; flex-direction:column; gap:6px;
  }
  .zoom-btn{
    width:44px; height:44px; border-radius:50%;
    background:var(--panel); border:1px solid var(--muted);
    color:var(--text); font-size:18px; font-weight:bold;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.2);
  }
  .zoom-btn:hover{filter:brightness(1.15)}

  /* Dropdown menus for compact mobile UI */
  .dropdown{position:relative; display:inline-block}
  .dropdown-content{
    position:absolute; top:100%; left:0; min-width:200px;
    background:var(--panel); border:1px solid var(--muted);
    border-radius:6px; padding:8px; z-index:300;
    display:none; box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }
  .dropdown.open .dropdown-content{display:block}

  /* Units toggle in toolbar */
  .units-toggle{
    display:flex; border:1px solid var(--muted); border-radius:6px; overflow:hidden;
  }
  .units-toggle label{
    padding:8px 12px; cursor:pointer; background:var(--muted);
    color:var(--text); border:none; flex:1; text-align:center;
    transition:background-color 0.2s;
  }
  .units-toggle input:checked + span{background:var(--accent); color:var(--ink)}

  .hidden{display:none !important}
  .footer-note{color:var(--sub);font-size:11px;margin:6px 0 4px}
  .hint{color:var(--sub); font-size:11px; line-height:1.4}

  /* Modal styling */
  .modal{
    position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center;
    z-index:999; padding:20px;
  }
  .modal.hidden{display:none !important}
  .modal-content{
    background:var(--panel); border:1px solid var(--muted); border-radius:8px;
    padding:20px; width:100%; max-width:380px; color:var(--text);
  }
  .modal-content h3{margin-top:0; font-size:16px; color:var(--sub)}
  .modal-content label{
    display:block; margin:8px 0 4px 0; font-size:12px; color:var(--sub);
  }
  .modal-content input[type="text"], .modal-content input[type="file"]{
    width:100%; margin:6px 0 12px 0; background:transparent;
    border:1px solid var(--muted); padding:10px 12px; border-radius:6px;
    color:var(--text); min-height:44px;
  }
  .modal-content .actions{display:flex; gap:8px; margin-top:16px}
  .modal-content .actions button{flex:1; min-height:44px}

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .header{padding:6px 8px}
    .header input{padding:8px; font-size:14px}
    .header button{padding:8px 10px}
    .sidebar{max-width:100vw}
    .mobile-toolbar{padding:6px 8px}
    .zoom-controls{bottom:70px; right:8px}
    .fab{top:60px; right:8px}
  }

  @media (max-width: 480px) {
    .header .project-inputs{flex-direction:column; gap:4px}
    .header .controls{gap:4px}
    .header button{padding:6px 8px; font-size:11px}
    .mobile-toolbar button{font-size:11px; padding:8px}
  }
</style>
</head>
<body>
  <!-- Compact mobile header -->
  <header class="header">
    <div class="logo" title="Logo Preview" id="logoPreview">M</div>
    <div class="project-inputs">
      <input id="projectInput" type="text" placeholder="Project" />
      <input id="areaInput" type="text" placeholder="Area" />
    </div>
    <div class="controls">
      <div class="dropdown">
        <button id="fileMenuBtn">File</button>
        <div class="dropdown-content" id="fileDropdown">
          <input id="fileInput" type="file" accept="image/*" class="hidden" />
          <button id="chooseBtn">Choose Image</button>
          <button id="cameraBtn">Camera</button>
          <div style="border-top:1px solid var(--muted); margin:8px 0; padding-top:8px">
            <button id="exportJpgBtn">Export JPG</button>
            <button id="exportPdfBtn">Export PDF</button>
            <button id="exportPdfProBtn">PDF Pro</button>
          </div>
        </div>
      </div>
      <button id="settingsBtn">Settings</button>
    </div>
  </header>

  <!-- Overlay for sidebar -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Mobile sidebar (slides in from left) -->
  <aside class="sidebar" id="sidebar">
    <div class="panel">
      <h3>Tools</h3>
      <div class="row">
        <button class="tool active" id="toolDraw">Draw</button>
        <button class="tool" id="toolSelect">Select</button>
        <button class="tool" id="toolRecolor">Recolor</button>
      </div>
      <div class="row">
        <button class="tool danger" id="deleteBtn">Delete</button>
        <button class="tool" id="undoBtn">Undo</button>
      </div>
      <div class="row">
        <label style="font-size:12px">
          <input type="checkbox" id="followAngle" checked> Label follows angle
        </label>
      </div>
    </div>

    <div class="panel">
      <h3>Style</h3>
      <div class="row" id="paletteRow"></div>
      <div class="row">
        <label style="width:100%">
          Line width: <span id="widthValue">3</span>
          <input id="widthInput" type="range" min="1" max="12" value="3" style="width:100%; margin-top:4px">
        </label>
      </div>
      <div class="row cap-toggle">
        <label><input type="radio" name="cap" value="arrow" checked><span>Arrows</span></label>
        <label><input type="radio" name="cap" value="circle"><span>Circles</span></label>
      </div>
    </div>

    <div class="panel">
      <h3>Measurements</h3>
      <div class="row units-toggle">
        <label>
          <input type="radio" name="units" value="imperial" checked style="display:none">
          <span>Imperial</span>
        </label>
        <label>
          <input type="radio" name="units" value="metric" style="display:none">
          <span>Metric</span>
        </label>
      </div>
      
      <div id="imperialFields">
        <div class="row">
          <input id="ftInput" type="number" placeholder="ft" style="flex:1">
          <input id="inInput" type="number" placeholder="in" style="flex:1">
        </div>
        <div class="row">
          <input id="numInput" type="number" placeholder="num" style="flex:1">
          <select id="denInput" style="flex:1">
            <option value="2">/2</option>
            <option value="4">/4</option>
            <option value="8" selected>/8</option>
            <option value="16">/16</option>
            <option value="32">/32</option>
          </select>
        </div>
        <div class="row">
          <button id="applyValueBtn" class="ok" style="flex:1">Apply Value</button>
        </div>
      </div>
      
      <div class="hidden" id="metricFields">
        <div class="row">
          <input id="mmInput" type="number" placeholder="mm" style="flex:1">
          <button id="applyMetricBtn" class="ok" style="flex:1">Apply</button>
        </div>
      </div>
      
      <div class="footer-note">Values go to Inbox if no line selected</div>
      <div class="chips" id="inbox"></div>
      <div class="row">
        <button id="clearInboxBtn" style="flex:1">Clear Inbox</button>
      </div>
    </div>

    <div class="panel">
      <h3>Line Info</h3>
      <div class="row">
        <input id="descInput" type="text" placeholder="Description" 
               style="width:100%" disabled>
      </div>
      <div class="row">
        <input id="addressInput" type="text" placeholder="Address (optional)" style="width:100%">
      </div>
      <div class="row">
        <input id="seriesInput" type="text" value="A" title="Tag prefix" style="width:60px">
        <button id="renumberBtn">Renumber All</button>
      </div>
    </div>

    <div class="panel">
      <h3>Bluetooth</h3>
      <div class="row">
        <select id="devicePreset" style="flex:1">
          <option value="auto" selected>Auto</option>
          <option value="leica_d2">Leica D2</option>
          <option value="vh80">Magpie VH80</option>
        </select>
      </div>
      <div class="row">
        <button id="connectBtn" style="flex:1">Connect</button>
        <button id="disconnectBtn" disabled style="flex:1">Disconnect</button>
      </div>
      <div class="row">
        <label>
          <input type="checkbox" id="beepOnCapture" checked> Beep on capture
        </label>
      </div>
      <div class="row">
        <button id="simulateBtn" style="flex:1">Simulate 2' 6-3/32"</button>
      </div>
      <div class="hint">Requires HTTPS or localhost for Web Bluetooth</div>
    </div>
  </aside>

  <!-- Main canvas area -->
  <main class="main">
    <div id="canvasContainer">
      <canvas id="imageCanvas" width="1280" height="800"></canvas>
      <canvas id="drawCanvas" width="1280" height="800"></canvas>
    </div>
  </main>

  <!-- Floating action button to open sidebar -->
  <button class="fab" id="menuFab">☰</button>

  <!-- Zoom controls -->
  <div class="zoom-controls">
    <button class="zoom-btn" id="zoomInBtn">+</button>
    <button class="zoom-btn" id="zoomOutBtn">−</button>
    <button class="zoom-btn" id="fitBtn" title="Fit">⌂</button>
  </div>

  <!-- Mobile toolbar at bottom -->
  <div class="mobile-toolbar">
    <div class="tool-group">
      <button id="mobileDrawBtn" class="active">Draw</button>
      <button id="mobileSelectBtn">Select</button>
    </div>
    <button id="mobileDeleteBtn" class="danger">Delete</button>
    <button id="mobileUndoBtn">Undo</button>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden">
    <div class="modal-content">
      <h3>Settings</h3>
      <label for="companyInput">Company Name</label>
      <input id="companyInput" type="text" placeholder="Company Name" />
      <label for="companyEmailInput">Email</label>
      <input id="companyEmailInput" type="text" placeholder="Email" />
      <label for="companyAddressInput">Address</label>
      <input id="companyAddressInput" type="text" placeholder="Address" />
      <label for="defaultLogoInput">Default Logo</label>
      <input id="defaultLogoInput" type="file" accept="image/*" />
      <div class="actions">
        <button id="saveSettingsBtn" class="ok">Save</button>
        <button id="closeSettingsBtn">Cancel</button>
      </div>
      <div class="hint">Settings stored locally on device</div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(()=>{
  // ======= State =======
  const imageCanvas = document.getElementById('imageCanvas');
  const drawCanvas  = document.getElementById('drawCanvas');
  const imgCtx      = imageCanvas.getContext('2d');
  const ctx         = drawCanvas.getContext('2d');
  const container   = document.getElementById('canvasContainer');
  const sidebar     = document.getElementById('sidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const menuFab     = document.getElementById('menuFab');
  
  // Form inputs
  const projectInput   = document.getElementById('projectInput');
  const areaInput      = document.getElementById('areaInput');
  const addressInput   = document.getElementById('addressInput');

  const state = {
    tool: 'draw', // 'draw' | 'select' | 'recolor'
    palette: ['#ff4d4f','#ffa502','#ffd166','#2ed573','#1e90ff','#a29bfe','#f368e0','#f1f2f6','#57606a'],
    color: '#1e90ff',
    width: 3,
    cap: 'arrow', // 'arrow' | 'circle'
    followAngle: true,
    units: 'imperial',
    series: 'A',
    nextIndex: 1,
    shapes: [],
    selectedId: null,
    dragging: null,
    img: null,
    imgNatural: {w:0,h:0},
    scale: 1,
    offset: {x:0,y:0},
    logo: null,
    zoom: 1,
    settings: { company: '', email: '', address: '' },
    history: [],
    sidebarOpen: false
  };

  // ======= Mobile UI Controls =======
  function toggleSidebar(force = null) {
    state.sidebarOpen = force !== null ? force : !state.sidebarOpen;
    sidebar.classList.toggle('open', state.sidebarOpen);
    sidebarOverlay.classList.toggle('visible', state.sidebarOpen);
    menuFab.textContent = state.sidebarOpen ? '✕' : '☰';
  }

  menuFab.onclick = () => toggleSidebar();
  sidebarOverlay.onclick = () => toggleSidebar(false);

  // Mobile toolbar controls
  const mobileDrawBtn = document.getElementById('mobileDrawBtn');
  const mobileSelectBtn = document.getElementById('mobileSelectBtn');
  const mobileDeleteBtn = document.getElementById('mobileDeleteBtn');
  const mobileUndoBtn = document.getElementById('mobileUndoBtn');

  function setMobileTool(tool) {
    state.tool = tool;
    [mobileDrawBtn, mobileSelectBtn].forEach(btn => btn.classList.remove('active'));
    if(tool === 'draw') mobileDrawBtn.classList.add('active');
    if(tool === 'select') mobileSelectBtn.classList.add('active');
    
    // Sync with sidebar tools
    $$('.tool').forEach(b => b.classList.remove('active'));
    if(tool === 'draw') document.getElementById('toolDraw')?.classList.add('active');
    if(tool === 'select') document.getElementById('toolSelect')?.classList.add('active');
  }

  mobileDrawBtn.onclick = () => setMobileTool('draw');
  mobileSelectBtn.onclick = () => setMobileTool('select');
  mobileDeleteBtn.onclick = () => deleteSelected();
  mobileUndoBtn.onclick = () => undoLast();

  // File dropdown
  const fileMenuBtn = document.getElementById('fileMenuBtn');
  const fileDropdown = document.getElementById('fileDropdown');
  
  fileMenuBtn.onclick = (e) => {
    e.stopPropagation();
    fileDropdown.parentElement.classList.toggle('open');
  };
  
  document.addEventListener('click', () => {
    fileDropdown.parentElement.classList.remove('open');
  });

  // ======= Core Functions (keeping original logic) =======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function fitCanvasToImage(){
    if(!state.img) { drawGrid(); return; }
    const cw = container.clientWidth; const ch = container.clientHeight;
    const iw = state.imgNatural.w; const ih = state.imgNatural.h;
    const scale = Math.min(cw/iw, ch/ih, 1);
    imageCanvas.width = drawCanvas.width = Math.floor(iw*scale);
    imageCanvas.height = drawCanvas.height = Math.floor(ih*scale);
    state.scale = scale; state.offset = {x:(cw-imageCanvas.width)/2, y:(ch-imageCanvas.height)/2};
    renderImage(); render();
  }

  function renderImage(){
    imgCtx.clearRect(0,0,imageCanvas.width,imageCanvas.height);
    if(state.img){ imgCtx.drawImage(state.img,0,0,imageCanvas.width,imageCanvas.height); }
    else { drawGrid(); }
  }

  function midpoint(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function distancePointToSegment(p,a,b){
    const l2 = Math.max(dist(a,b)**2, 1e-6);
    const t = Math.max(0, Math.min(1, ((p.x-a.x)*(b.x-a.x)+(p.y-a.y)*(b.y-a.y))/l2));
    const proj = {x: a.x + t*(b.x-a.x), y: a.y + t*(b.y-a.y)};
    return {d: dist(p,proj), t, proj};
  }
  function angle(a,b){ return Math.atan2(b.y-a.y, b.x-a.x); }

  function nextTag(){ return state.series + (state.nextIndex++); }

  function formatImperial(val){
    const sign = val<0 ? '-' : '';
    val = Math.abs(val);
    const feet = Math.floor(val/12);
    let inches = val - feet*12;
    const denom = parseInt(document.getElementById('denInput').value,10) || 16;
    const wholeIn = Math.floor(inches);
    let frac = inches - wholeIn;
    let num = Math.round(frac * denom + 1e-6);
    if(num === denom){ inches = wholeIn+1; num = 0; }
    const pieces = [];
    pieces.push(`${feet}'`);
    if(wholeIn>0 || num>0) {
      const inchStr = num>0 ? `${wholeIn}-${num}/${denom}` : `${wholeIn}`;
      pieces.push(` ${inchStr}"`);
    } else {
      pieces.push(` 0"`);
    }
    return sign + pieces.join('');
  }

  function labelTextForPDF(txt){
    return (txt||'').replace(/'/g, "'").replace(/"/g, '"');
  }

  function parseASCIIReading(str){
    str = (str||'').trim().toLowerCase();
    const mm = str.match(/([\d.]+)\s*mm/);
    const cm = str.match(/([\d.]+)\s*cm/);
    const m  = str.match(/([\d.]+)\s*m(?!m)/);
    const inch = str.match(/([\d.]+)\s*in/);
    const feetIn = str.match(/(\d+)[\'\s]*([\d.]*)\s*(?:-\s*(\d+)\/(\d+))?/);
    let inchesTotal = null;
    if(mm){ inchesTotal = parseFloat(mm[1]) / 25.4; }
    else if(cm){ inchesTotal = parseFloat(cm[1]) / 2.54; }
    else if(m){ inchesTotal = parseFloat(m[1]) * 39.3701; }
    else if(inch){ inchesTotal = parseFloat(inch[1]); }
    else if(feetIn){
      const ft = parseFloat(feetIn[1]||'0');
      const wIn = parseFloat(feetIn[2]||'0');
      const num = parseFloat(feetIn[3]||'0');
      const den = parseFloat(feetIn[4]||'1');
      inchesTotal = ft*12 + wIn + (den? num/den : 0);
    }
    return inchesTotal;
  }

  function measureToLabel(shape){
    if(shape.units==='metric' && typeof shape.mm === 'number'){
      return `${Math.round(shape.mm)} mm`;
    }
    if(typeof shape.inches === 'number'){
      return formatImperial(shape.inches);
    }
    return '';
  }

  function saveHistory(){
    if(state.shapes.length > 0){
      const snapshot = state.shapes.map(s => ({
        id: s.id, tag: s.tag, color: s.color, width: s.width, cap: s.cap,
        units: s.units, inches: s.inches, mm: s.mm, description: s.description,
        p1: { x: s.p1.x, y: s.p1.y }, p2: { x: s.p2.x, y: s.p2.y