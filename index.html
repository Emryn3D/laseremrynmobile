<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>EMRYN Measurement Tool</title>
<style>
  :root{
    --bg: rgba(14, 15, 18, 0.95);
    --panel: rgba(21, 24, 33, 0.9);
    --muted: rgba(39, 43, 54, 0.8);
    --text: #e8ecf1;
    --sub: #b6c0cf;
    --accent: #69b3ff;
    --danger: #ff6b6b;
    --ok: #52d273;
    --overlay: rgba(0, 0, 0, 0.5);
    --emryn-red: #ff2953;
  }
  
  * { box-sizing: border-box; }
  html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  }
  
  body {
    background: #0e0f12;
    color: var(--text);
    position: relative;
  }

  /* Top toolbar like DISTO */
  .top-toolbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 60px;
    background: var(--emryn-red);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 15px;
    z-index: 100;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  }

  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .emryn-logo {
    height: 32px;
    width: auto;
    cursor: pointer;
    filter: invert(1);
  }

  .back-btn {
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .toolbar-center {
    flex: 1;
    text-align: center;
  }

  .project-info {
    color: #fff;
    font-size: 14px;
    font-weight: 500;
  }

  .toolbar-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .toolbar-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 12px;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    min-width: 50px;
  }

  .toolbar-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .toolbar-btn-icon {
    font-size: 18px;
  }

  /* Dropdown menus */
  .dropdown {
    position: relative;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    min-width: 180px;
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 8px 0;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.2s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }

  .dropdown.open .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: var(--text);
    cursor: pointer;
    transition: background-color 0.2s;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
  }

  .dropdown-item:hover {
    background: rgba(105, 179, 255, 0.1);
  }

  .dropdown-item-icon {
    width: 20px;
    text-align: center;
  }

  /* Main canvas area */
  .main {
    position: fixed;
    top: 60px;
    left: 0;
    right: 0;
    bottom: 70px;
    background: #0a0b0e;
  }

  #canvasContainer {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: none;
  }

  #imageCanvas, #drawCanvas {
    position: absolute;
    max-width: 100%;
    max-height: 100%;
  }
  
  #imageCanvas {
    background: #0b0e13;
    z-index: 1;
  }
  
  #drawCanvas {
    background: transparent;
    z-index: 2;
    touch-action: none;
  }

  /* Side panel (narrower like DISTO) */
  .side-panel {
    position: fixed;
    top: 60px;
    right: 0;
    width: 280px;
    height: calc(100vh - 130px);
    background: var(--panel);
    backdrop-filter: blur(20px);
    border-left: 1px solid var(--muted);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 150;
    overflow-y: auto;
    padding: 20px;
  }

  .side-panel.open {
    transform: translateX(0);
  }

  .panel-overlay {
    position: fixed;
    top: 60px;
    left: 0;
    right: 280px;
    bottom: 70px;
    background: var(--overlay);
    backdrop-filter: blur(2px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 140;
  }

  .panel-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Menu sections */
  .menu-section {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--muted);
  }

  .menu-section:last-child {
    border-bottom: none;
  }

  .menu-section h3 {
    margin: 0 0 12px 0;
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .menu-row {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .menu-row:last-child {
    margin-bottom: 0;
  }

  /* Bottom toolbar */
  .bottom-toolbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: var(--panel);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--muted);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 20px;
    z-index: 90;
  }

  .bottom-btn {
    background: var(--muted);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: var(--text);
    padding: 10px 16px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    min-width: 60px;
    min-height: 50px;
  }

  .bottom-btn:hover, .bottom-btn.active {
    background: var(--accent);
    color: #000;
    transform: translateY(-2px);
  }

  .bottom-btn.danger {
    background: var(--danger);
    color: #fff;
  }

  .bottom-btn-icon {
    font-size: 18px;
  }

  /* Floating controls */
  .floating-controls {
    position: fixed;
    bottom: 90px;
    right: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 80;
  }

  .float-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--panel);
    backdrop-filter: blur(10px);
    border: 1px solid var(--muted);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
  }

  .float-btn:hover {
    background: var(--accent);
    color: #000;
    transform: scale(1.05);
  }

  .float-btn.laser-active {
    background: var(--ok);
    color: #000;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Laser control */
  .laser-control {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 80;
  }

  .laser-btn {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #333;
    border: 4px solid #555;
    color: #fff;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    transition: all 0.2s ease;
  }

  .laser-btn.connected {
    background: var(--ok);
    border-color: #4a9960;
    color: #000;
  }

  .laser-btn.measuring {
    background: var(--emryn-red);
    border-color: #ff1a47;
    animation: pulse 1s infinite;
  }

  /* Buttons and inputs */
  .btn {
    padding: 10px 14px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: var(--muted);
    color: var(--text);
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
    text-align: center;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .btn:hover, .btn:active {
    background: var(--accent);
    color: #000;
    transform: translateY(-1px);
  }

  .btn.active {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
  }

  .btn.danger {
    background: var(--danger);
    border-color: var(--danger);
    color: #fff;
  }

  .btn.ok {
    background: var(--ok);
    border-color: var(--ok);
    color: #000;
  }

  .btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
    width: 100%;
  }

  .btn-group.three {
    grid-template-columns: 1fr 1fr 1fr;
  }

  .btn-full {
    width: 100%;
  }

  /* Inputs */
  .input {
    padding: 10px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: rgba(0, 0, 0, 0.3);
    color: var(--text);
    font-size: 13px;
    width: 100%;
    min-height: 40px;
  }

  .input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(105, 179, 255, 0.2);
  }

  .input-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .input-group.four {
    grid-template-columns: 1fr 1fr 1fr 60px;
  }

  /* Color palette */
  .color-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
  }

  .color-swatch {
    width: 100%;
    height: 34px;
    border: 2px solid transparent;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .color-swatch.selected {
    border-color: var(--accent);
    transform: scale(1.05);
    box-shadow: 0 0 0 2px rgba(105, 179, 255, 0.3);
  }

  /* Range slider */
  .slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--muted);
    outline: none;
    -webkit-appearance: none;
  }

  .slider::-webkit-slider-thumb {
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }

  /* Radio groups */
  .radio-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px;
  }

  .radio-option {
    position: relative;
    cursor: pointer;
  }

  .radio-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .radio-option .radio-label {
    display: block;
    padding: 10px;
    border: 1px solid var(--muted);
    border-radius: 6px;
    background: var(--muted);
    color: var(--text);
    text-align: center;
    transition: all 0.2s ease;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .radio-option input:checked + .radio-label {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
  }

  /* Chips */
  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }

  .chip {
    background: rgba(27, 31, 42, 0.8);
    border: 1px solid var(--muted);
    padding: 6px 10px;
    border-radius: 16px;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s ease;
  }

  .chip:hover {
    background: var(--accent);
    color: #000;
  }

  /* Quick measurement input */
  .quick-measure-popup {
    position: fixed;
    bottom: 160px;
    right: 75px;
    width: 200px;
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 8px;
    padding: 15px;
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px) scale(0.95);
    transition: all 0.2s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  }

  .quick-measure-popup.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  .quick-measure-popup::after {
    content: '';
    position: absolute;
    bottom: -8px;
    right: 20px;
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid var(--panel);
  }

  /* Modal */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: var(--overlay);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
    padding: 20px;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    background: var(--panel);
    backdrop-filter: blur(20px);
    border: 1px solid var(--muted);
    border-radius: 12px;
    padding: 24px;
    width: 100%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal h3 {
    margin: 0 0 16px 0;
    font-size: 16px;
    color: var(--accent);
  }

  .modal label {
    display: block;
    margin: 0 0 4px 0;
    font-size: 12px;
    color: var(--sub);
    font-weight: 500;
  }

  .hint {
    color: var(--sub);
    font-size: 10px;
    margin-top: 6px;
    line-height: 1.3;
  }

  .hidden { display: none !important; }

  /* Responsive */
  @media (max-width: 480px) {
    .side-panel {
      width: 100vw;
      padding: 15px;
    }
    
    .panel-overlay {
      right: 0;
    }
    
    .toolbar-right {
      gap: 8px;
    }
    
    .toolbar-btn {
      min-width: 40px;
      font-size: 10px;
    }
    
    .quick-measure-popup {
      right: 15px;
      width: 180px;
    }
  }
</style>
</head>
<body>
  <!-- Top toolbar like DISTO -->
  <div class="top-toolbar">
    <div class="toolbar-left">
      <!-- EMRYN logo (will be replaced with your logo) -->
      <svg class="emryn-logo" viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
        <text x="10" y="35" font-family="Arial, sans-serif" font-size="32" font-weight="bold" fill="white">EMRYN</text>
      </svg>
      <div class="back-btn" id="backBtn">←</div>
    </div>
    
    <div class="toolbar-center">
      <div class="project-info" id="projectInfo">New Project</div>
    </div>
    
    <div class="toolbar-right">
      <div class="dropdown" id="exportDropdown">
        <button class="toolbar-btn" id="exportBtn">
          <div class="toolbar-btn-icon">↗</div>
          <div>Export</div>
        </button>
        <div class="dropdown-menu">
          <button class="dropdown-item" id="exportJpgBtn">
            <div class="dropdown-item-icon">🖼</div>
            <span>JPG</span>
          </button>
          <button class="dropdown-item" id="exportPdfBtn">
            <div class="dropdown-item-icon">📄</div>
            <span>PDF Basic</span>
          </button>
          <button class="dropdown-item" id="exportProBtn">
            <div class="dropdown-item-icon">📋</div>
            <span>PDF Pro</span>
          </button>
        </div>
      </div>
      
      <div class="dropdown" id="toolsDropdown">
        <button class="toolbar-btn" id="toolsBtn">
          <div class="toolbar-btn-icon">🛠</div>
          <div>Tools</div>
        </button>
        <div class="dropdown-menu">
          <button class="dropdown-item" id="drawSettingsBtn">
            <div class="dropdown-item-icon">⚙</div>
            <span>Draw Settings</span>
          </button>
          <button class="dropdown-item" id="textToolBtn">
            <div class="dropdown-item-icon">T</div>
            <span>Text</span>
          </button>
          <button class="dropdown-item" id="markerToolBtn">
            <div class="dropdown-item-icon">📍</div>
            <span>Marker</span>
          </button>
          <button class="dropdown-item" id="editTagsBtn">
            <div class="dropdown-item-icon">🏷</div>
            <span>Edit Tags</span>
          </button>
        </div>
      </div>
      
      <button class="toolbar-btn" id="undoToolbarBtn">
        <div class="toolbar-btn-icon">↶</div>
        <div>Undo</div>
      </button>
      
      <button class="toolbar-btn" id="newBtn">
        <div class="toolbar-btn-icon">📄</div>
        <div>New</div>
      </button>
    </div>
  </div>

  <!-- Main canvas area -->
  <main class="main">
    <div id="canvasContainer">
      <canvas id="imageCanvas"></canvas>
      <canvas id="drawCanvas"></canvas>
    </div>
  </main>

  <!-- Side panel overlay -->
  <div class="panel-overlay" id="panelOverlay"></div>

  <!-- Side panel -->
  <div class="side-panel" id="sidePanel">
    <!-- File Operations -->
    <div class="menu-section">
      <h3>File</h3>
      <input id="fileInput" type="file" accept="image/*" class="hidden" />
      <div class="btn-group">
        <button class="btn" id="chooseBtn">Gallery</button>
        <button class="btn" id="cameraBtn">Camera</button>
      </div>
      <div class="menu-row" style="margin-top: 10px;">
        <input class="input" id="projectInput" type="text" placeholder="Project Name" />
      </div>
      <div class="menu-row">
        <input class="input" id="areaInput" type="text" placeholder="Area/Room" />
      </div>
    </div>

    <!-- Colors -->
    <div class="menu-section">
      <h3>Colors</h3>
      <div class="color-grid" id="colorGrid"></div>
    </div>

    <!-- Line Style -->
    <div class="menu-section">
      <h3>Line Style</h3>
      <div class="menu-row">
        <label>Width: <span id="widthDisplay">3</span></label>
      </div>
      <div class="menu-row">
        <input class="slider" id="widthSlider" type="range" min="1" max="12" value="3" />
      </div>
      <div class="radio-group" style="margin-top: 12px;">
        <div class="radio-option">
          <input type="radio" name="endcap" value="arrow" id="capArrow" checked />
          <label class="radio-label" for="capArrow">Arrows</label>
        </div>
        <div class="radio-option">
          <input type="radio" name="endcap" value="circle" id="capCircle" />
          <label class="radio-label" for="capCircle">Circles</label>
        </div>
      </div>
    </div>

    <!-- Measurements -->
    <div class="menu-section">
      <h3>Measurements</h3>
      <div class="radio-group">
        <div class="radio-option">
          <input type="radio" name="units" value="imperial" id="unitsImperial" checked />
          <label class="radio-label" for="unitsImperial">Imperial</label>
        </div>
        <div class="radio-option">
          <input type="radio" name="units" value="metric" id="unitsMetric" />
          <label class="radio-label" for="unitsMetric">Metric</label>
        </div>
      </div>

      <!-- Imperial inputs -->
      <div id="imperialInputs">
        <div class="input-group four" style="margin-top: 12px;">
          <input class="input" id="ftInput" type="number" placeholder="ft" />
          <input class="input" id="inInput" type="number" placeholder="in" />
          <input class="input" id="numInput" type="number" placeholder="num" />
          <select class="input" id="fracSelect">
            <option value="2">/2</option>
            <option value="4">/4</option>
            <option value="8" selected>/8</option>
            <option value="16">/16</option>
            <option value="32">/32</option>
          </select>
        </div>
        <button class="btn ok btn-full" id="applyImperialBtn" style="margin-top: 8px;">Apply</button>
      </div>

      <!-- Metric inputs -->
      <div id="metricInputs" class="hidden">
        <div class="menu-row" style="margin-top: 12px;">
          <input class="input" id="mmInput" type="number" placeholder="mm" style="flex: 1;" />
          <button class="btn ok" id="applyMetricBtn">Apply</button>
        </div>
      </div>

      <!-- Inbox -->
      <div style="margin-top: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <span style="font-size: 11px; color: var(--sub);">Inbox</span>
          <button class="btn" id="clearInboxBtn" style="padding: 2px 6px; font-size: 10px;">Clear</button>
        </div>
        <div class="chips" id="inbox"></div>
        <div class="hint">Tap measurement to apply to selected line</div>
      </div>
    </div>

    <!-- Bluetooth -->
    <div class="menu-section">
      <h3>Bluetooth Laser</h3>
      <div class="menu-row">
        <select class="input" id="deviceSelect">
          <option value="auto">Auto-detect</option>
          <option value="leica">Leica DISTO</option>
          <option value="bosch">Bosch GLM</option>
        </select>
      </div>
      <div class="btn-group">
        <button class="btn" id="connectBtn">Connect</button>
        <button class="btn" id="disconnectBtn" disabled>Disconnect</button>
      </div>
      <div class="menu-row" style="margin-top: 8px;">
        <label style="display: flex; align-items: center; gap: 6px;">
          <input type="checkbox" id="beepToggle" checked />
          <span>Beep on measurement</span>
        </label>
      </div>
      <button class="btn btn-full" id="testBtn">Test: 8' 6"</button>
      <div class="hint">Requires HTTPS. Measurements auto-apply to selected lines.</div>
    </div>

    <!-- Settings -->
    <div class="menu-section">
      <h3>Settings</h3>
      <button class="btn btn-full" id="settingsBtn">Company Info</button>
    </div>
  </div>

  <!-- Bottom toolbar -->
  <div class="bottom-toolbar">
    <button class="bottom-btn active" id="drawToolBtn">
      <div class="bottom-btn-icon">✏️</div>
      <div>Draw</div>
    </button>
    <button class="bottom-btn" id="selectToolBtn">
      <div class="bottom-btn-icon">👆</div>
      <div>Select</div>
    </button>
    <button class="bottom-btn danger" id="deleteToolBtn">
      <div class="bottom-btn-icon">🗑</div>
      <div>Delete</div>
    </button>
  </div>

  <!-- Floating controls -->
  <div class="floating-controls">
    <button class="float-btn" id="undoFloatBtn" title="Undo">
      <div>↶</div>
    </button>
    <button class="float-btn" id="measureFloatBtn" title="Quick Measure">
      <div>📏</div>
    </button>
  </div>

  <!-- Laser control (like DISTO) -->
  <div class="