<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>EMRYN Measurement Tool</title>
<style>
  :root {
    --bg: #0e0f12;
    --panel: rgba(21, 24, 33, 0.95);
    --muted: rgba(39, 43, 54, 0.8);
    --text: #e8ecf1;
    --sub: #b6c0cf;
    --accent: #004025; /* Brand */
    --danger: #ff6b6b;
    --ok: #52d273;
    --overlay: rgba(0, 0, 0, 0.6);
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; }
  body { background: var(--bg); color: var(--text); position: relative; }

  /* Utility */
  .hidden { display: none; }
  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

  /* Home screen */
  .home-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); z-index: 300; display: flex; flex-direction: column; padding: 20px; }
  .home-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 0 20px; border-bottom: 1px solid #ddd; margin-bottom: 18px; }
  .home-logo { height: 40px; width: auto; opacity: 0.95; cursor: pointer; }
  .home-title { font-size: 18px; font-weight: 600; color: #333; }
  .home-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 0 4px; }
  .home-card { background: #fff; border-radius: 12px; padding: 22px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; min-height: 124px; justify-content: center; }
  .home-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); }
  .home-card-icon { width: 56px; height: 56px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
  .home-card-title { font-size: 15px; font-weight: 600; color: #333; margin: 0; }

  /* Side menu */
  .menu-overlay { position: fixed; inset: 0; background: var(--overlay); opacity: 0; pointer-events: none; transition: opacity 0.25s ease; z-index: 350; }
  .menu-overlay.visible { opacity: 1; pointer-events: auto; }
  .side-menu { position: fixed; top: 0; left: 0; width: 280px; height: 100vh; background: #fff; transform: translateX(-100%); transition: transform 0.25s ease; z-index: 400; box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1); }
  .side-menu.open { transform: translateX(0); }
  .side-menu-header { background: var(--accent); color: white; padding: 18px; display: flex; align-items: center; gap: 14px; }
  .side-menu-close { color: white; font-size: 24px; cursor: pointer; padding: 5px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
  .side-menu-logo { height: 30px; width: auto; }
  .side-menu-title { font-size: 16px; font-weight: 600; }
  .side-menu-item { display: flex; align-items: center; gap: 14px; padding: 14px 18px; color: #333; cursor: pointer; transition: background-color 0.15s; border: none; background: none; width: 100%; text-align: left; font-size: 15px; min-height: 50px; }
  .side-menu-item:hover { background: #f8f9fa; }

  /* Top toolbar */
  .app-interface { position: fixed; inset: 0; background: var(--bg); z-index: 100; }
  .top-toolbar { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: var(--accent); display: flex; align-items: center; justify-content: space-between; padding: 0 12px; z-index: 150; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
  .toolbar-left { display: flex; align-items: center; gap: 10px; }
  .emryn-logo { height: 28px; width: auto; cursor: pointer; filter: invert(1); opacity: 0.95; }
  .back-btn { color: #fff; font-size: 18px; cursor: pointer; padding: 8px; border-radius: 6px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
  .back-btn:hover { background: rgba(255, 255, 255, 0.12); }
  .project-info { color: #fff; font-size: 14px; font-weight: 600; }
  .toolbar-right { display: flex; align-items: center; gap: 6px; }
  .toolbar-btn { background: none; border: none; color: #fff; font-size: 11px; padding: 6px 8px; border-radius: 6px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; min-width: 44px; min-height: 44px; }
  .toolbar-btn:hover { background: rgba(255, 255, 255, 0.12); }

  /* Canvas */
  .main { position: fixed; top: 56px; left: 0; right: 0; bottom: 120px; background: #0a0b0e; }
  #canvasContainer { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; touch-action: none; }
  #imageCanvas, #drawCanvas { position: absolute; max-width: 100%; max-height: 100%; }
  #imageCanvas { background: #0b0e13; z-index: 1; }
  #drawCanvas { background: transparent; z-index: 2; touch-action: none; }

  /* History */
  .measurement-history { position: fixed; bottom: 0; left: 0; right: 0; height: 120px; background: var(--panel); backdrop-filter: blur(18px); border-top: 1px solid var(--muted); z-index: 140; display: flex; flex-direction: column; }
  .history-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; border-bottom: 1px solid var(--muted); }
  .history-title { font-size: 12px; font-weight: 700; color: var(--sub); text-transform: uppercase; letter-spacing: 0.5px; }
  .history-list { flex: 1; overflow-x: auto; padding: 8px 14px; display: flex; gap: 8px; align-items: center; }
  .history-item { background: var(--muted); border: 1px solid rgba(255, 255, 255, 0.12); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap; transition: all 0.15s; min-height: 34px; display: flex; align-items: center; }
  .history-item:hover { background: var(--accent); color: #fff; transform: translateY(-1px); }

  /* Laser */
  .laser-control { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); z-index: 130; }
  .laser-btn { width: 76px; height: 76px; border-radius: 50%; background: #333; border: 4px solid #555; color: #fff; font-size: 11px; font-weight: 800; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4); transition: all 0.2s; }
  .laser-btn.connected { background: var(--accent); border-color: #006635; }
  .laser-btn.measuring { animation: pulse 1s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); } 50% { opacity: 0.9; transform: translateX(-50%) scale(1.04); } }

  /* Floating controls */
  .floating-controls { position: fixed; bottom: 140px; right: 12px; display: flex; flex-direction: column; gap: 8px; z-index: 130; }
  .float-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--panel); backdrop-filter: blur(10px); border: 1px solid var(--muted); color: var(--text); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); transition: .15s; }
  .float-btn:hover { background: var(--accent); color: #fff; transform: scale(1.05); }

  /* Context menu */
  .context-menu { position: fixed; background: var(--panel); border: 1px solid var(--muted); border-radius: 8px; padding: 6px 0; z-index: 200; opacity: 0; visibility: hidden; transform: scale(0.95); transition: all 0.15s; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); min-width: 200px; }
  .context-menu.visible { opacity: 1; visibility: visible; transform: scale(1); }
  .context-menu-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; color: var(--text); cursor: pointer; transition: background-color 0.15s; border: none; background: none; width: 100%; text-align: left; font-size: 14px; min-height: 44px; }
  .context-menu-item:hover { background: rgba(0, 64, 37, 0.1); }
  .context-menu-item.danger:hover { background: rgba(255, 107, 107, 0.12); color: var(--danger); }

  /* Panels */
  .panel-screen { position: fixed; inset: 0; background: var(--bg); z-index: 250; display: none; flex-direction: column; }
  .panel-screen.visible { display: flex; }
  .panel-header { height: 56px; background: var(--accent); display: flex; align-items: center; padding: 0 12px; gap: 12px; }
  .panel-back { color: #fff; font-size: 18px; cursor: pointer; padding: 8px; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
  .panel-title { color: #fff; font-size: 16px; font-weight: 700; }
  .panel-content { flex: 1; padding: 14px; overflow-y: auto; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-row { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
  .label { font-size: 12px; color: var(--sub); }
  .input, .select { padding: 12px; border: 1px solid var(--muted); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--text); font-size: 14px; min-height: 44px; }
  .btn { padding: 12px 14px; border: none; border-radius: 6px; font-size: 14px; font-weight: 700; cursor: pointer; min-height: 44px; }
  .btn.primary { background: var(--accent); color: #fff; }
  .btn.secondary { background: var(--muted); color: var(--text); }

  /* Source chooser */
  .source-chooser { position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%) scale(0.92); background: var(--panel); border: 1px solid var(--muted); border-radius: 12px; padding: 20px; z-index: 260; opacity: 0; visibility: hidden; transition: .2s; box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5); min-width: 280px; }
  .source-chooser.visible { opacity: 1; visibility: visible; transform: translate(-50%, 50%) scale(1); }
  .chooser-title { font-size: 16px; font-weight: 700; color: var(--text); margin-bottom: 14px; text-align: center; }
  .chooser-buttons { display: flex; flex-direction: column; gap: 10px; }
  .chooser-btn { padding: 14px 18px; border: 1px solid var(--muted); border-radius: 8px; background: var(--muted); color: var(--text); font-size: 15px; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 10px; min-height: 50px; }
  .chooser-btn:hover { background: var(--accent); color: #fff; }

  /* Organizer */
  .project-card { background: var(--panel); border: 1px solid var(--muted); border-radius: 8px; padding: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .project-actions { display: flex; gap: 8px; }

  /* Measurement keypad */
  .measurement-keypad { position: fixed; bottom: 50%; left: 50%; transform: translate(-50%, 50%) scale(0.92); background: var(--panel); border: 1px solid var(--muted); border-radius: 12px; padding: 20px; z-index: 260; opacity: 0; visibility: hidden; transition: .2s; width: 320px; max-width: 95vw; }
  .measurement-keypad.visible { opacity: 1; visibility: visible; transform: translate(-50%, 50%) scale(1); }
  .keypad-inputs { display: grid; grid-template-columns: 1fr 1fr 60px; gap: 10px; margin-bottom: 12px; }
  .fraction-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; grid-column: 1 / -1; }
  .keypad-input { padding: 12px; border: 1px solid var(--muted); border-radius: 6px; background: rgba(0,0,0,0.3); color: var(--text); font-size: 14px; min-height: 44px; text-align: center; }
  .keypad-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  @media (max-width: 480px) {
    .home-grid { grid-template-columns: 1fr; }
    .toolbar-btn { min-width: 40px; font-size: 10px; padding: 6px 8px; }
  }
</style>
</head>
<body>
  <!-- Home screen -->
  <div class="home-screen" id="homeScreen">
    <div class="home-header">
      <img alt="Menu" class="home-logo" id="homeMenuBtn" />
      <div class="home-title">Home</div>
    </div>
    <div class="home-grid">
      <div class="home-card" id="sketchOnPhotoCard" aria-label="Sketch on Photo"><div class="home-card-icon">📐</div><h3 class="home-card-title">Sketch on Photo</h3></div>
      <div class="home-card" id="organiserCard" aria-label="Organizer"><div class="home-card-icon">📁</div><h3 class="home-card-title">Organizer</h3></div>
    </div>
  </div>

  <!-- Menu overlay and side menu -->
  <div class="menu-overlay" id="menuOverlay"></div>
  <div class="side-menu" id="sideMenu" aria-label="Menu">
    <div class="side-menu-header">
      <div class="side-menu-close" id="sideMenuClose">✕</div>
      <img alt="EMRYN" class="side-menu-logo" id="sideMenuLogo" />
      <div class="side-menu-title">Menu</div>
    </div>
    <div>
      <button class="side-menu-item" id="menuSketchPhoto">📐 Sketch on Photo</button>
      <button class="side-menu-item" id="menuOrganiser">📁 Organizer</button>
      <button class="side-menu-item" id="menuMyDevices">📱 My Devices</button>
      <button class="side-menu-item" id="menuSettings">⚙️ Settings</button>
    </div>
  </div>

  <!-- Main app interface -->
  <div class="app-interface hidden" id="appInterface">
    <div class="top-toolbar">
      <div class="toolbar-left">
        <img alt="Menu" class="emryn-logo" id="emrynLogo" />
        <div class="back-btn" id="backBtn" title="Back">←</div>
      </div>
      <div class="project-info" id="projectInfo">New Project</div>
      <div class="toolbar-right">
        <button class="toolbar-btn" id="titleBtn" title="Set Title">📝<span class="sr-only">Title</span></button>
        <button class="toolbar-btn" id="exportBtn" title="Export">↗<span class="sr-only">Export</span></button>
        <button class="toolbar-btn" id="undoBtn" title="Undo">↶<span class="sr-only">Undo</span></button>
        <button class="toolbar-btn" id="newBtn" title="New">📄<span class="sr-only">New</span></button>
      </div>
    </div>
    <main class="main">
      <div id="canvasContainer"><canvas id="imageCanvas"></canvas><canvas id="drawCanvas"></canvas></div>
    </main>
    <div class="measurement-history">
      <div class="history-header"><div class="history-title">Recent Measurements</div><button class="btn secondary" id="clearHistoryBtn">Clear</button></div>
      <div class="history-list" id="historyList"><div style="color: var(--sub); font-size: 11px; text-align: center; width: 100%;">Measurements from laser or manual entry will appear here</div></div>
    </div>
    <div class="floating-controls">
      <button class="float-btn" id="lineToolBtn" title="Draw Line">✏️</button>
      <button class="float-btn" id="textToolBtn" title="Add Text">🅰</button>
      <button class="float-btn" id="manualMeasureBtn" title="Manual Entry">📏</button>
    </div>
    <div class="laser-control"><button class="laser-btn" id="laserBtn"><div style="font-size: 10px;">LASER</div><div id="laserStatus">OFF</div></button></div>
    <div class="context-menu" id="contextMenu">
      <button class="context-menu-item" id="contextEdit">✏️ Edit Measurement</button>
      <button class="context-menu-item" id="contextDuplicate">📋 Duplicate</button>
      <button class="context-menu-item" id="contextAddText">🅰 Add Text</button>
      <button class="context-menu-item" id="contextMoveToProject">📁 Move to Project</button>
      <button class="context-menu-item danger" id="contextDelete">🗑 Delete</button>
    </div>
  </div>

  <!-- Source chooser -->
  <div class="source-chooser" id="sourceChooser" role="dialog" aria-modal="true">
    <div class="chooser-title">Select Source</div>
    <div class="chooser-buttons">
      <button class="chooser-btn" id="chooserCamera" aria-label="Camera">📷 Camera</button>
      <button class="chooser-btn" id="chooserGallery" aria-label="Photo Library">🖼 Photo Library</button>
      <button class="chooser-btn" id="chooserPdf" aria-label="PDF">📄 PDF</button>
      <button class="chooser-btn" id="chooserCancel" aria-label="Cancel">✕ Cancel</button>
    </div>
  </div>

  <!-- Manual measurement keypad -->
  <div class="measurement-keypad" id="measurementKeypad" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <div style="font-size:16px;font-weight:700;">Enter Measurement</div>
      <button class="btn secondary" id="keypadClose">✕</button>
    </div>
    <div class="keypad-inputs">
      <input class="keypad-input" id="feetInput" type="number" placeholder="ft" min="0" />
      <input class="keypad-input" id="inchesInput" type="number" placeholder="in" min="0" max="11" />
      <input class="keypad-input" id="numInput" type="number" placeholder="num" min="0" />
      <div class="fraction-inputs">
        <select class="keypad-input" id="denomInput">
          <option value="2">1/2</option>
          <option value="4">1/4</option>
          <option value="8">1/8</option>
          <option value="16">1/16</option>
          <option value="32">1/32</option>
          <option value="64" selected>1/64</option>
        </select>
      </div>
    </div>
    <div class="keypad-actions"><button class="btn secondary" id="keypadCancel">Cancel</button><button class="btn primary" id="keypadApply">Apply</button></div>
  </div>

  <!-- My Devices -->
  <div class="panel-screen" id="myDevicesScreen">
    <div class="panel-header"><div class="panel-back" id="devicesBack">←</div><div class="panel-title">My Devices</div></div>
    <div class="panel-content">
      <div class="project-card">
        <div style="display:flex; align-items:center; gap:12px;">
          <div style="width:48px; height:48px; background: var(--muted); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:20px;">📡</div>
          <div>
            <div style="font-weight:700;">Laser Measure Device</div>
            <div id="deviceStatus" style="font-size:12px; color: var(--sub);">Not connected</div>
          </div>
        </div>
        <div class="project-actions">
          <button class="btn primary" id="connectDeviceBtn">Connect</button>
          <button class="btn secondary" id="disconnectDeviceBtn" disabled>Disconnect</button>
        </div>
      </div>
      <div class="project-card">
        <div>
          <div style="font-weight:700;">Auto-connect</div>
          <div style="font-size:12px;color:var(--sub)">Automatically reconnect to last device</div>
        </div>
        <label style="position: relative; width: 50px; height: 26px; background: var(--muted); border-radius: 13px; cursor: pointer;">
          <input type="checkbox" id="autoConnectToggle" style="display:none;" />
          <span style="position:absolute; top:2px; left:2px; width:22px; height:22px; background:#fff; border-radius:50%; transition: transform 0.2s;" id="autoConnectKnob"></span>
        </label>
      </div>
      <div style="font-size:12px;color:var(--sub);line-height:1.5;">
        Web Bluetooth requires HTTPS and a supported browser. iOS Safari is not supported.
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div class="panel-screen" id="settingsScreen">
    <div class="panel-header"><div class="panel-back" id="settingsBack">←</div><div class="panel-title">Settings</div></div>
    <div class="panel-content">
      <h4>Branding</h4>
      <div class="form-row"><label class="label">Menu Logo</label><input type="file" id="menuLogoInput" accept="image/*"><img id="menuLogoPreview" alt="Menu logo preview" style="max-width:160px;display:block;margin-top:8px;" /></div>
      <div class="form-row"><label class="label">Watermark Logo</label><input type="file" id="watermarkLogoInput" accept="image/*"><img id="watermarkLogoPreview" alt="Watermark preview" style="max-width:160px;display:block;margin-top:8px;" /></div>

      <h4>User</h4>
      <div class="form-grid">
        <div class="form-row"><label class="label" for="userNameInput">Name</label><input class="input" id="userNameInput" placeholder="Your name" /></div>
        <div class="form-row"><label class="label" for="companyInput">Company</label><input class="input" id="companyInput" placeholder="Company" /></div>
        <div class="form-row"><label class="label" for="emailInput">Email</label><input class="input" id="emailInput" type="email" placeholder="name@example.com" /></div>
        <div class="form-row"><label class="label" for="phoneInput">Phone</label><input class="input" id="phoneInput" type="tel" placeholder="(555) 123-4567" /></div>
      </div>

      <h4>Units</h4>
      <div class="form-row"><label class="label">Display Units</label><select id="unitsSelect" class="select"><option value="imperial">Feet and Inches</option><option value="metric">Millimeters</option></select></div>

      <h4>Draw Settings</h4>
      <div class="form-row"><label class="label">Snapping</label><input type="checkbox" id="snapToggle" /></div>
      <div class="form-row"><label class="label">Guides</label><input type="checkbox" id="guidesToggle" /></div>
      <div class="form-row"><label class="label">Endpoint Snap</label><input type="checkbox" id="endpointSnapToggle" /></div>
      <div class="form-row"><label class="label">Dashed Leader (default)</label><input type="checkbox" id="leaderDashedToggle" checked /></div>

      <div style="display:flex;gap:10px;margin-top:10px;">
        <button class="btn secondary" id="settingsCancelBtn">Cancel</button>
        <button class="btn primary" id="settingsSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Organizer -->
  <div class="panel-screen" id="organizerScreen">
    <div class="panel-header"><div class="panel-back" id="organizerBack">←</div><div class="panel-title">Organizer</div></div>
    <div class="panel-content">
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button class="btn primary" id="addProjectBtn">Add New Project</button>
        <button class="btn secondary" id="renameProjectBtn">Rename</button>
        <button class="btn secondary" id="deleteProjectBtn">Delete</button>
      </div>
      <div style="margin-bottom:8px; font-size:12px; color: var(--sub);">Sections</div>
      <div class="project-card"><div>Recently Opened</div><button class="btn secondary" id="viewRecentBtn">Open</button></div>
      <div class="project-card"><div>All Projects</div><button class="btn secondary" id="viewAllBtn">Open</button></div>
      <div style="margin: 14px 0 8px; font-weight:700;">Projects</div>
      <div id="projectsList"></div>
    </div>
  </div>

  <!-- Hidden file inputs -->
  <input type="file" id="fileInput" accept="image/*" class="hidden" />
  <input type="file" id="pdfInput" accept=".pdf" class="hidden" />

<script>
(() => {
  // ===== State =====
  const state = {
    currentScreen: 'home',
    tool: 'line',
    activeColor: '#1e90ff',
    lineWidth: 3,
    units: 'imperial',
    shapes: [],
    selectedShape: null,
    dragging: null,
    image: null,
    imageNaturalSize: {w:0,h:0},
    zoom: 1,
    history: [],
    measurementHistory: [],
    bluetooth: {device: null, connected: false, measuring: false, autoConnect: false},
    currentTitle: '',
    projects: [],
    currentProjectId: null,
    drawSettings: { snap: false, guides: false, endpointSnap: false, dashedLeader: true },
    language: 'en',
    user: { name: '', company: '', email: '', phone: '' },
    branding: {
      menuLogo: localStorage.getItem('menuLogo') || 'EmrynLogo-White.png',
      watermarkLogo: localStorage.getItem('watermarkLogo') || '20240930_173442880_iOS.png'
    }
  };

  // ===== Elements =====
  const homeScreen = document.getElementById('homeScreen');
  const appInterface = document.getElementById('appInterface');
  const sideMenu = document.getElementById('sideMenu');
  const menuOverlay = document.getElementById('menuOverlay');
  const projectInfo = document.getElementById('projectInfo');
  const projectsList = document.getElementById('projectsList');
  const imageCanvas = document.getElementById('imageCanvas');
  const drawCanvas = document.getElementById('drawCanvas');
  const container = document.getElementById('canvasContainer');
  const imgCtx = imageCanvas.getContext('2d');
  let drawCtx = drawCanvas.getContext('2d');

  // ===== Init =====
  initBranding();
  loadSettings();
  loadProjects();
  setupEventListeners();
  showScreen('home');
  updateHistoryDisplay();
  updateAutoConnectUI();
  updateProjectInfo();
  httpsGuard();

  function initBranding(){
    const homeMenuBtn = document.getElementById('homeMenuBtn');
    const emrynLogo = document.getElementById('emrynLogo');
    const sideMenuLogo = document.getElementById('sideMenuLogo');
    [homeMenuBtn, emrynLogo, sideMenuLogo].forEach(el=>{ el.src = state.branding.menuLogo; });
    // Preload watermark
    const w = new Image(); w.src = state.branding.watermarkLogo; w.onload = () => state._watermark = w;
  }

  // ===== Events =====
  function setupEventListeners(){
    // Home
    document.getElementById('homeMenuBtn').addEventListener('click', () => toggleSideMenu(true));
    document.getElementById('sketchOnPhotoCard').addEventListener('click', showSourceChooser);
    document.getElementById('organiserCard').addEventListener('click', () => showScreen('organizer'));

    // Menu
    document.getElementById('sideMenuClose').addEventListener('click', () => toggleSideMenu(false));
    document.getElementById('menuSketchPhoto').addEventListener('click', () => { toggleSideMenu(false); showSourceChooser(); });
    document.getElementById('menuOrganiser').addEventListener('click', () => { toggleSideMenu(false); showScreen('organizer'); });
    document.getElementById('menuMyDevices').addEventListener('click', () => { toggleSideMenu(false); showScreen('devices'); });
    document.getElementById('menuSettings').addEventListener('click', () => { toggleSideMenu(false); showScreen('settings'); });
    menuOverlay.addEventListener('click', () => toggleSideMenu(false));

    // Toolbar
    document.getElementById('emrynLogo').addEventListener('click', () => toggleSideMenu(true));
    document.getElementById('backBtn').addEventListener('click', () => showScreen('home'));
    document.getElementById('undoBtn').addEventListener('click', undo);
    document.getElementById('exportBtn').addEventListener('click', exportImage);
    document.getElementById('newBtn').addEventListener('click', showSourceChooser);
    document.getElementById('titleBtn').addEventListener('click', setTitle);

    // Tools
    document.getElementById('lineToolBtn').addEventListener('click', () => setTool('line'));
    document.getElementById('textToolBtn').addEventListener('click', () => setTool('text'));
    document.getElementById('manualMeasureBtn').addEventListener('click', showMeasurementKeypad);

    // Laser
    document.getElementById('laserBtn').addEventListener('click', handleLaserClick);

    // Source chooser
    document.getElementById('chooserCamera').addEventListener('click', () => { hideSourceChooser(); openCamera(); });
    document.getElementById('chooserGallery').addEventListener('click', () => { hideSourceChooser(); document.getElementById('fileInput').click(); });
    document.getElementById('chooserPdf').addEventListener('click', () => { hideSourceChooser(); document.getElementById('pdfInput').click(); });
    document.getElementById('chooserCancel').addEventListener('click', hideSourceChooser);

    // Files
    document.getElementById('fileInput').addEventListener('change', (e) => { const f=e.target.files[0]; if (f) loadImageFile(f); });
    document.getElementById('pdfInput').addEventListener('change', (e) => { const f=e.target.files[0]; if (f) loadPdfFile(f); });

    // Keypad
    document.getElementById('keypadClose').addEventListener('click', hideMeasurementKeypad);
    document.getElementById('keypadCancel').addEventListener('click', hideMeasurementKeypad);
    document.getElementById('keypadApply').addEventListener('click', applyManualMeasurement);

    // Devices
    document.getElementById('devicesBack').addEventListener('click', () => showScreen('home'));
    document.getElementById('connectDeviceBtn').addEventListener('click', connectBluetooth);
    document.getElementById('disconnectDeviceBtn').addEventListener('click', disconnectBluetooth);
    document.getElementById('autoConnectToggle').addEventListener('change', toggleAutoConnect);

    // Settings
    document.getElementById('settingsBack').addEventListener('click', () => showScreen('home'));
    document.getElementById('settingsCancelBtn').addEventListener('click', () => showScreen('home'));
    document.getElementById('settingsSaveBtn').addEventListener('click', saveSettingsFromUI);
    document.getElementById('menuLogoInput').addEventListener('change', onMenuLogoUpload);
    document.getElementById('watermarkLogoInput').addEventListener('change', onWatermarkUpload);

    // Organizer
    document.getElementById('organizerBack').addEventListener('click', () => showScreen('home'));
    document.getElementById('addProjectBtn').addEventListener('click', addProject);
    document.getElementById('renameProjectBtn').addEventListener('click', renameProject);
    document.getElementById('deleteProjectBtn').addEventListener('click', deleteProject);
    document.getElementById('viewRecentBtn').addEventListener('click', () => alert('Recently Opened coming soon'));
    document.getElementById('viewAllBtn').addEventListener('click', () => renderProjects());

    // Canvas
    setupCanvasEvents();

    // Global clicks
    document.addEventListener('click', (e) => { const cm = document.getElementById('contextMenu'); if (!cm.contains(e.target) && !e.target.closest('#drawCanvas')) hideContextMenu(); });

    // Keyboard
    document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); } if (e.key === 'Delete') { deleteSelected(); } if (e.key === 'Escape') { hideContextMenu(); hideMeasurementKeypad(); hideSourceChooser(); } });

    // Resize
    window.addEventListener('resize', () => { if (state.currentScreen === 'app') setTimeout(fitToScreen, 100); });
  }

  // ===== Screens =====
  function showScreen(screen){
    state.currentScreen = screen;
    toggle(homeScreen, screen==='home');
    toggle(appInterface, screen==='app');
    toggle(document.getElementById('myDevicesScreen'), screen==='devices', 'visible');
    toggle(document.getElementById('settingsScreen'), screen==='settings', 'visible');
    toggle(document.getElementById('organizerScreen'), screen==='organizer', 'visible');
    if (screen==='app') setTimeout(()=>{ initCanvas(); fitToScreen(); }, 80);
  }
  function toggle(el, on, altClass){ if (!altClass){ el.classList.toggle('hidden', !on); } else { el.classList.toggle(altClass, on); el.classList.toggle('hidden', !on); } }
  function toggleSideMenu(show){ sideMenu.classList.toggle('open', show); menuOverlay.classList.toggle('visible', show); }

  // ===== Source chooser =====
  function showSourceChooser(){ const sc = document.getElementById('sourceChooser'); sc.classList.add('visible'); }
  function hideSourceChooser(){ const sc = document.getElementById('sourceChooser'); sc.classList.remove('visible'); }

  // ===== Tools =====
  function setTool(tool){ state.tool = tool; const on=(id,active)=>{ const b=document.getElementById(id); b.style.background=active?'var(--accent)':''; b.style.color=active?'#fff':''; }; on('lineToolBtn', tool==='line'); on('textToolBtn', tool==='text'); }

  // ===== Canvas Drawing (includes leader-line behavior) =====
  function setupCanvasEvents(){
    let isDrawing=false, startPoint=null, lastTouch=0;
    drawCanvas.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      const p=getCanvasPoint(e); const now=Date.now(); if (now-lastTouch<300){ fitToScreen(); return; } lastTouch=now;
      if (state.tool==='line'){
        const calloutHit=findCalloutHit(p); if (calloutHit){ state.selectedShape=calloutHit.id; state.dragging='callout'; hideContextMenu(); return; }
        const lineHit=findLineHit(p); if (lineHit){ state.selectedShape=lineHit.id; showContextMenu(e.clientX,e.clientY); redraw(); return; }
        isDrawing=true; startPoint=p; hideContextMenu(); state.selectedShape=null;
      } else if (state.tool==='text'){
        hideContextMenu(); const t=prompt('Enter text:'); if (t&&t.trim()){ saveToHistory(); state.shapes.push({ id:id(), type:'text', pos:{x:p.x,y:p.y}, text:t.trim() }); redraw(); }
      }
    });
    drawCanvas.addEventListener('pointermove', (e)=>{ if (!isDrawing && !state.dragging) return; e.preventDefault(); const p=getCanvasPoint(e); if (isDrawing&&startPoint){ drawPreview(startPoint,p); } else if (state.dragging==='callout'){ handleCalloutDrag(p); } });
    drawCanvas.addEventListener('pointerup', (e)=>{ if (isDrawing&&startPoint){ const p=getCanvasPoint(e); addMeasurementLine(startPoint,p); isDrawing=false; startPoint=null; } state.dragging=null; });

    // Pinch zoom
    let initialDistance=0, initialZoom=1;
    drawCanvas.addEventListener('touchstart', (e)=>{ if (e.touches.length===2){ const [t1,t2]=e.touches; initialDistance=Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY); initialZoom=state.zoom; } });
    drawCanvas.addEventListener('touchmove', (e)=>{ if (e.touches.length===2){ e.preventDefault(); const [t1,t2]=e.touches; const d=Math.hypot(t1.clientX-t2.clientX,t1.clientY-t2.clientY); if (initialDistance>0){ const scale=d/initialDistance; const newZoom=Math.max(0.5, Math.min(3, initialZoom*scale)); adjustZoom(newZoom/state.zoom); } } });
  }

  function getCanvasPoint(e){ const r=drawCanvas.getBoundingClientRect(); const sx=drawCanvas.width/r.width; const sy=drawCanvas.height/r.height; return { x:(e.clientX-r.left)*sx, y:(e.clientY-r.top)*sy }; }
  function findCalloutHit(p){ for (const s of [...state.shapes].reverse()){ if (s.type==='line'&&s.callout&&dist(p,s.callout)<30) return s; } return null; }
  function findLineHit(p){ for (const s of [...state.shapes].reverse()){ if (s.type!=='line') continue; if (distanceToLine(p,s.p1,s.p2)<Math.max(15,s.width+5)) return s; } return null; }
  function handleCalloutDrag(p){ const s=getSel(); if (!s) return; s.callout={x:p.x,y:p.y}; const t=getT(s.callout,s.p1,s.p2); s.leaderAnchor=Math.max(0,Math.min(1,t)); redraw(); }
  function getT(pt,a,b){ const A=pt.x-a.x,B=pt.y-a.y,C=b.x-a.x,D=b.y-a.y; const dot=A*C+B*D; const len=C*C+D*D; return len===0?0:dot/len; }
  function drawPreview(start,end){ redraw(); drawCtx.save(); drawCtx.strokeStyle=state.activeColor; drawCtx.lineWidth=state.lineWidth; drawCtx.setLineDash([8,4]); drawCtx.beginPath(); drawCtx.moveTo(start.x,start.y); drawCtx.lineTo(end.x,end.y); drawCtx.stroke(); drawCtx.restore(); }
  function addMeasurementLine(p1,p2){ const d=Math.hypot(p2.x-p1.x,p2.y-p1.y); if (d<10) return; saveToHistory(); const mid={x:(p1.x+p2.x)/2,y:(p1.y+p2.y)/2}; state.shapes.push({ id:id(), type:'line', p1:{...p1}, p2:{...p2}, value:null, callout:{x:mid.x+50,y:mid.y-30}, leaderAnchor:0.5, color:state.activeColor, width:state.lineWidth, units:state.units }); state.selectedShape=state.shapes[state.shapes.length-1].id; redraw(); }
  function redraw(){ drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height); for (const s of state.shapes){ if (s.type==='line') drawLine(s); if (s.type==='text') drawText(s); } }
  function drawLine(s){ const sel=s.id===state.selectedShape; drawCtx.save(); drawCtx.strokeStyle=s.color; drawCtx.lineWidth=s.width; drawCtx.lineCap='round'; drawCtx.beginPath(); drawCtx.moveTo(s.p1.x,s.p1.y); drawCtx.lineTo(s.p2.x,s.p2.y); drawCtx.stroke(); drawEndCap(s.p1,s.p2,s.color,s.width); drawEndCap(s.p2,s.p1,s.color,s.width); if (s.value&&s.callout) drawCallout(s); if (sel&&s.callout) drawCalloutSelection(s.callout); drawCtx.restore(); }
  function drawText(s){ drawCtx.save(); drawCtx.font='14px system-ui'; drawCtx.textAlign='left'; drawCtx.textBaseline='bottom'; const m=drawCtx.measureText(s.text); const w=m.width+14,h=26; drawCtx.fillStyle='rgba(18,20,27,0.9)'; drawCtx.strokeStyle='rgba(255,255,255,0.2)'; drawCtx.lineWidth=1; drawCtx.beginPath(); roundRect(drawCtx,s.pos.x,s.pos.y-h,w,h,8); drawCtx.fill(); drawCtx.stroke(); drawCtx.fillStyle='#fff'; drawCtx.fillText(s.text,s.pos.x+7,s.pos.y-7); drawCtx.restore(); }
  function drawEndCap(p,other,color,width){ const a=Math.atan2(p.y-other.y,p.x-other.x); drawCtx.save(); drawCtx.translate(p.x,p.y); drawCtx.rotate(a); drawCtx.fillStyle=color; drawCtx.beginPath(); drawCtx.moveTo(0,0); drawCtx.lineTo(-12,-6); drawCtx.lineTo(-12,6); drawCtx.closePath(); drawCtx.fill(); drawCtx.restore(); }
  function drawCallout(s){ const ax=s.p1.x+s.leaderAnchor*(s.p2.x-s.p1.x); const ay=s.p1.y+s.leaderAnchor*(s.p2.y-s.p1.y); drawCtx.save(); drawCtx.strokeStyle=s.color; drawCtx.lineWidth=1; if (state.drawSettings.dashedLeader) drawCtx.setLineDash([6,4]); drawCtx.beginPath(); drawCtx.moveTo(s.callout.x,s.callout.y); drawCtx.lineTo(ax,ay); drawCtx.stroke(); drawCtx.setLineDash([]); const txt=formatMeasurement(s.value,s.units); drawBubble(txt,s.callout); drawCtx.restore(); }
  function drawCalloutSelection(c){ drawCtx.save(); drawCtx.fillStyle='rgba(0, 64, 37, 0.2)'; drawCtx.strokeStyle='var(--accent)'; drawCtx.lineWidth=2; drawCtx.beginPath(); drawCtx.arc(c.x,c.y,12,0,Math.PI*2); drawCtx.fill(); drawCtx.stroke(); drawCtx.restore(); }
  function drawBubble(text,pos){ drawCtx.save(); drawCtx.font='13px system-ui'; drawCtx.textAlign='center'; drawCtx.textBaseline='middle'; const m=drawCtx.measureText(text); const w=m.width+16,h=28; drawCtx.fillStyle='rgba(18,20,27,0.9)'; drawCtx.strokeStyle='rgba(255,255,255,0.2)'; drawCtx.lineWidth=1; drawCtx.beginPath(); roundRect(drawCtx,pos.x-w/2,pos.y-h/2,w,h,12); drawCtx.fill(); drawCtx.stroke(); drawCtx.fillStyle='#fff'; drawCtx.fillText(text,pos.x,pos.y); drawCtx.restore(); }
  function roundRect(ctx,x,y,w,h,r){ ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); }

  function showContextMenu(x,y){ const cm=document.getElementById('contextMenu'); cm.style.left=Math.min(x,window.innerWidth-220)+'px'; cm.style.top=Math.min(y,window.innerHeight-220)+'px'; cm.classList.add('visible'); }
  function hideContextMenu(){ document.getElementById('contextMenu').classList.remove('visible'); }

  // ===== Laser =====
  function handleLaserClick(){ if (state.bluetooth.connected){ takeMeasurement(); } else { showScreen('devices'); } }
  function takeMeasurement(){ if (!state.bluetooth.connected) return; state.bluetooth.measuring=true; document.getElementById('laserBtn').classList.add('measuring'); document.getElementById('laserStatus').textContent='MEASURING'; beep(); setTimeout(()=>{ const m={ value: 102.5, units: state.units }; handleMeasurement(m); stopMeasurement(); }, 1200); }
  function stopMeasurement(){ state.bluetooth.measuring=false; document.getElementById('laserBtn').classList.remove('measuring'); document.getElementById('laserStatus').textContent='READY'; }
  function handleMeasurement(m){ addToMeasurementHistory(m); const s=getSel(); if (s){ if (s.value){ if (confirm(`Overwrite ${formatMeasurement(s.value,s.units)} with ${formatMeasurement(m.value,m.units)}?`)) applyMeasurementToShape(s,m); } else { applyMeasurementToShape(s,m); } } }
  function applyMeasurementToShape(s,m){ s.value=m.value; s.units=m.units; if (!s.callout){ const mid={x:(s.p1.x+s.p2.x)/2,y:(s.p1.y+s.p2.y)/2}; s.callout={x:mid.x+50,y:mid.y-30}; s.leaderAnchor=0.5; } redraw(); }

  // ===== Manual keypad =====
  function showMeasurementKeypad(){ const k=document.getElementById('measurementKeypad'); k.classList.add('visible'); ['feetInput','inchesInput','numInput'].forEach(id=>document.getElementById(id).value=''); document.getElementById('denomInput').value='64'; }
  function hideMeasurementKeypad(){ document.getElementById('measurementKeypad').classList.remove('visible'); }
  function applyManualMeasurement(){ if (state.units==='metric'){ const mm=parseFloat(prompt('Enter millimeters:')||'0'); if (!isFinite(mm)||mm<=0){ hideMeasurementKeypad(); return; } handleMeasurement({ value: Math.round(mm), units: 'metric' }); hideMeasurementKeypad(); return; } const ft=+document.getElementById('feetInput').value||0; let inches=+document.getElementById('inchesInput').value||0; const num=+document.getElementById('numInput').value||0; const den=+document.getElementById('denomInput').value||1; if (inches>=12){ inches-=12; ft+=1; } const total=ft*12+inches+num/den; handleMeasurement({ value: total, units: 'imperial' }); hideMeasurementKeypad(); }

  function addToMeasurementHistory(m){ const f=formatMeasurement(m.value,m.units); state.measurementHistory.unshift({ ...m, formatted:f, ts:Date.now() }); if (state.measurementHistory.length>20) state.measurementHistory.pop(); updateHistoryDisplay(); }
  function updateHistoryDisplay(){ const list=document.getElementById('historyList'); if (state.measurementHistory.length===0){ list.innerHTML='<div style="color: var(--sub); font-size: 11px; text-align: center; width: 100%;">Measurements from laser or manual entry will appear here</div>'; return; } list.innerHTML=''; state.measurementHistory.forEach(m=>{ const item=document.createElement('div'); item.className='history-item'; item.textContent=m.formatted; item.addEventListener('click',()=>{ const s=getSel(); if (s){ if (s.value && !confirm(`Apply ${m.formatted} to selected line?`)) return; applyMeasurementToShape(s,m); } else { alert('Select a line first to apply this measurement'); } }); list.appendChild(item); }); }

  function formatMeasurement(v,u){ if (u==='imperial'){ const sign=v<0?'-':''; v=Math.abs(v); const ft=Math.floor(v/12); const rem=v-ft*12; const whole=Math.floor(rem); const frac=rem-whole; const den=64; let num=Math.round(frac*den); if (num===den) return `${sign}${ft}' ${whole+1}\"`; if (num===0) return `${sign}${ft}' ${whole}\"`; const g=(a,b)=>b===0?a:g(b,a%b); const div=g(num,den); return `${sign}${ft}' ${whole}-${num/div}/${den/div}\"`; } return `${Math.round(v)} mm`; }

  // ===== Text & Selection helpers =====
  function getSel(){ return state.shapes.find(s=>s.id===state.selectedShape); }
  function duplicateSelected(){ const s=getSel(); if (!s) return; saveToHistory(); const copy=JSON.parse(JSON.stringify(s)); copy.id=id(); if (copy.type==='line'){ copy.p1.x+=20; copy.p1.y+=20; copy.p2.x+=20; copy.p2.y+=20; if (copy.callout){ copy.callout.x+=20; copy.callout.y+=20; } } else if (copy.type==='text'){ copy.pos.x+=20; copy.pos.y+=20; } state.shapes.push(copy); state.selectedShape=copy.id; redraw(); }
  function deleteSelected(){ if (!state.selectedShape) return; saveToHistory(); state.shapes=state.shapes.filter(s=>s.id!==state.selectedShape); state.selectedShape=null; redraw(); }
  function undo(){ if (state.history.length===0) return; const prev=state.history.pop(); state.shapes=JSON.parse(JSON.stringify(prev)); state.selectedShape=null; redraw(); }
  function saveToHistory(){ if (state.history.length>=20) state.history.shift(); state.history.push(JSON.parse(JSON.stringify(state.shapes))); }

  // ===== Camera & Files =====
  async function openCamera(){ try { const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }); const overlay=document.createElement('div'); overlay.style.cssText='position:fixed;inset:0;background:black;z-index:600;display:flex;flex-direction:column;'; const video=document.createElement('video'); video.srcObject=stream; video.autoplay=true; video.playsInline=true; video.style.cssText='flex:1;width:100%;object-fit:cover;'; const controls=document.createElement('div'); controls.style.cssText='position:absolute;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:16px;align-items:center;'; const captureBtn=document.createElement('button'); captureBtn.innerHTML='📷'; captureBtn.style.cssText='width:70px;height:70px;border-radius:50%;background:var(--accent);color:white;border:4px solid white;font-size:24px;cursor:pointer;'; const retakeBtn=document.createElement('button'); retakeBtn.innerHTML='🔄'; retakeBtn.style.cssText='width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);font-size:20px;cursor:pointer;display:none;'; const useBtn=document.createElement('button'); useBtn.innerHTML='✓'; useBtn.style.cssText='width:50px;height:50px;border-radius:50%;background:var(--ok);color:white;border:none;font-size:20px;cursor:pointer;display:none;'; const closeBtn=document.createElement('button'); closeBtn.innerHTML='✕'; closeBtn.style.cssText='position:absolute;top:20px;right:20px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.6);color:white;border:none;font-size:20px;cursor:pointer;'; controls.append(retakeBtn,captureBtn,useBtn); overlay.append(video,controls,closeBtn); document.body.appendChild(overlay); let imgData=null; const cleanup=()=>{ stream.getTracks().forEach(t=>t.stop()); overlay.remove(); }; captureBtn.onclick=()=>{ const c=document.createElement('canvas'); c.width=video.videoWidth||1920; c.height=video.videoHeight||1080; c.getContext('2d').drawImage(video,0,0); imgData=c.toDataURL('image/jpeg',0.9); video.style.display='none'; const img=document.createElement('img'); img.src=imgData; img.style.cssText='flex:1;width:100%;height:100%;object-fit:cover;'; overlay.insertBefore(img,controls); captureBtn.style.display='none'; retakeBtn.style.display='block'; useBtn.style.display='block'; }; retakeBtn.onclick=()=>{ overlay.querySelector('img')?.remove(); video.style.display='block'; captureBtn.style.display='block'; retakeBtn.style.display='none'; useBtn.style.display='none'; imgData=null; }; useBtn.onclick=()=>{ if (imgData){ const img=new Image(); img.onload=()=>{ state.image=img; state.imageNaturalSize={w:img.naturalWidth,h:img.naturalHeight}; showScreen('app'); setTimeout(()=>fitToScreen(),80); cleanup(); }; img.src=imgData; } }; closeBtn.onclick=cleanup; } catch (err) { console.error('Camera access failed:', err); const input=document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='environment'; input.onchange=(e)=>{ const f=e.target.files[0]; if (f) loadImageFile(f); }; input.click(); } }
  function loadImageFile(file){ const reader=new FileReader(); reader.onload=(e)=>{ const img=new Image(); img.onload=()=>{ state.image=img; state.imageNaturalSize={ w: img.naturalWidth, h: img.naturalHeight }; showScreen('app'); setTimeout(()=>fitToScreen(),80); }; img.onerror=()=>alert('Failed to load image.'); img.src=e.target.result; }; reader.readAsDataURL(file); }
  function loadPdfFile(){ alert('PDF import will be implemented in an update.'); }

  // ===== Bluetooth (HTTPS enforced) =====
  async function connectBluetooth(){ const connectBtn=document.getElementById('connectDeviceBtn'); const disconnectBtn=document.getElementById('disconnectDeviceBtn'); const deviceStatus=document.getElementById('deviceStatus'); connectBtn.disabled=true; connectBtn.textContent='Connecting...'; deviceStatus.textContent='Connecting...'; try { if (!navigator.bluetooth) throw new Error('Web Bluetooth not supported in this browser'); if (location.protocol!=='https:') throw new Error('HTTPS required'); const device=await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: ['generic_access'] }); const server=await device.gatt.connect(); state.bluetooth.device=device; state.bluetooth.connected=true; connectBtn.disabled=true; disconnectBtn.disabled=false; connectBtn.textContent='Connected'; deviceStatus.textContent='Connected'; deviceStatus.style.color='var(--accent)'; document.getElementById('laserBtn').classList.add('connected'); document.getElementById('laserStatus').textContent='READY'; device.addEventListener('gattserverdisconnected', ()=>{ state.bluetooth.connected=false; connectBtn.disabled=false; disconnectBtn.disabled=true; connectBtn.textContent='Connect'; deviceStatus.textContent='Not connected'; deviceStatus.style.color='var(--sub)'; document.getElementById('laserBtn').classList.remove('connected','measuring'); document.getElementById('laserStatus').textContent='OFF'; }); } catch (err) { console.error('Bluetooth failed:', err); connectBtn.disabled=false; connectBtn.textContent='Connect'; deviceStatus.textContent=`Error: ${err.message}`; alert(`Bluetooth connection failed: ${err.message}`); } }
  function disconnectBluetooth(){ if (state.bluetooth.device){ state.bluetooth.device.gatt.disconnect(); } }
  function toggleAutoConnect(e){ state.bluetooth.autoConnect=e.target.checked; saveSettings(); updateAutoConnectUI(); }
  function updateAutoConnectUI(){ const t=document.getElementById('autoConnectToggle'); const knob=document.getElementById('autoConnectKnob'); t.checked=!!state.bluetooth.autoConnect; knob.style.transform=t.checked?'translateX(24px)':'translateX(0)'; t.parentElement.style.background=t.checked?'var(--accent)':'var(--muted)'; }
  function httpsGuard(){ if (location.protocol!=='https:'){ alert('Bluetooth requires HTTPS. Host this app on GitHub Pages and enable Enforce HTTPS in Settings → Pages.'); } }

  // ===== Export with watermark & timestamp =====
  async function exportImage(){ if (!state.image){ alert('Please load an image first'); return; } if (!state.currentTitle){ const t=prompt('Enter title for export:', 'Measurement_'+new Date().toISOString().slice(0,10)); if (!t) return; state.currentTitle=t.trim(); updateProjectInfo(); }
    const exportCanvas=document.createElement('canvas'); exportCanvas.width=imageCanvas.width; exportCanvas.height=imageCanvas.height; const ctx=exportCanvas.getContext('2d'); ctx.drawImage(state.image,0,0,exportCanvas.width,exportCanvas.height); const original=drawCtx; drawCtx=ctx; for (const s of state.shapes){ if (s.type==='line') drawLine(s); if (s.type==='text') drawText(s); } drawCtx=original; await addBrandingOverlay(ctx, exportCanvas.width, exportCanvas.height); const blob=await new Promise(res=>exportCanvas.toBlob(res,'image/jpeg',0.9)); if (window.showSaveFilePicker){ try { const handle=await window.showSaveFilePicker({ suggestedName: state.currentTitle + '.jpg', types:[{ description:'JPEG Image', accept:{'image/jpeg':['.jpg','.jpeg']} }] }); const writable=await handle.createWritable(); await writable.write(blob); await writable.close(); alert(`Saved to: ${handle.name}`); return; } catch(e){ console.warn('File picker failed; fallback to download', e); } } const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=state.currentTitle+'.jpg'; a.click(); URL.revokeObjectURL(url); alert(`Saved to: ${state.currentTitle}.jpg`); }

  async function addBrandingOverlay(ctx,w,h){ const ts=new Date().toLocaleString(); // timestamp box
    ctx.save(); ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(10,h-38,180,28); ctx.fillStyle='#fff'; ctx.font='12px system-ui'; ctx.fillText(ts, 18, h-20); // watermark logo
    if (state._watermark){ const mw=Math.min(140, state._watermark.width); const mh=state._watermark.height * (mw/state._watermark.width); ctx.globalAlpha=0.95; ctx.drawImage(state._watermark, w-mw-10, 10, mw, mh); ctx.globalAlpha=1; } else { ctx.fillStyle='rgba(0,0,0,0.7)'; ctx.fillRect(w-140,10,130,28); ctx.fillStyle='#fff'; ctx.fillText('EMRYN', w-130, 28); }
    ctx.restore(); }

  // ===== Zoom & Canvas sizing =====
  function adjustZoom(f){ state.zoom=Math.max(0.5, Math.min(3, state.zoom*f)); container.style.transform=`scale(${state.zoom})`; }
  function fitToScreen(){ if (!state.image){ drawPlaceholder(); return; } const main=document.querySelector('.main'); const r=main.getBoundingClientRect(); const cw=r.width,ch=r.height; const iw=state.imageNaturalSize.w, ih=state.imageNaturalSize.h; const scale=Math.min(cw/iw, ch/ih, 1); const W=Math.floor(iw*scale), H=Math.floor(ih*scale); imageCanvas.width=drawCanvas.width=W; imageCanvas.height=drawCanvas.height=H; state.zoom=1; container.style.transform='scale(1)'; drawImage(); redraw(); }
  function drawImage(){ imgCtx.clearRect(0,0,imageCanvas.width,imageCanvas.height); if (state.image){ imgCtx.drawImage(state.image,0,0,imageCanvas.width,imageCanvas.height); } else { drawPlaceholder(); } }
  function drawPlaceholder(){ const w=imageCanvas.width||400,h=imageCanvas.height||300; imgCtx.fillStyle='#0b0e13'; imgCtx.fillRect(0,0,w,h); imgCtx.strokeStyle='#161a22'; imgCtx.lineWidth=1; for (let x=0;x<w;x+=40){ imgCtx.beginPath(); imgCtx.moveTo(x,0); imgCtx.lineTo(x,h); imgCtx.stroke(); } for (let y=0;y<h;y+=40){ imgCtx.beginPath(); imgCtx.moveTo(0,y); imgCtx.lineTo(w,y); imgCtx.stroke(); } imgCtx.fillStyle='#666'; imgCtx.font='16px system-ui'; imgCtx.textAlign='center'; imgCtx.textBaseline='middle'; imgCtx.fillText('Select "Sketch on Photo" to begin', w/2, h/2); }
  function initCanvas(){ const main=document.querySelector('.main'); const r=main.getBoundingClientRect(); imageCanvas.width=drawCanvas.width=r.width; imageCanvas.height=drawCanvas.height=r.height; drawPlaceholder(); }

  // ===== Organizer =====
  function loadProjects(){ try { state.projects=JSON.parse(localStorage.getItem('emrynProjects')||'[]'); renderProjects(); } catch { state.projects=[]; } }
  function saveProjects(){ localStorage.setItem('emrynProjects', JSON.stringify(state.projects)); }
  function renderProjects(){ projectsList.innerHTML=''; if (state.projects.length===0){ const empty=document.createElement('div'); empty.style.cssText='color:var(--sub);font-size:12px;'; empty.textContent='No projects yet'; projectsList.appendChild(empty); return; } state.projects.forEach(p=>{ const card=document.createElement('div'); card.className='project-card'; const left=document.createElement('div'); left.textContent=p.name; const right=document.createElement('div'); const openBtn=document.createElement('button'); openBtn.className='btn secondary'; openBtn.textContent='Open'; openBtn.onclick=()=>{ state.currentProjectId=p.id; updateProjectInfo(); alert(`Opened project: ${p.name}`); }; right.appendChild(openBtn); card.append(left,right); projectsList.appendChild(card); }); }
  function addProject(){ const name=prompt('Project name:'); if (!name) return; const p={ id:id(), name:name.trim(), createdAt: Date.now() }; state.projects.unshift(p); state.currentProjectId=p.id; saveProjects(); renderProjects(); updateProjectInfo(); }
  function renameProject(){ if (!state.currentProjectId){ alert('Open a project first'); return; } const p=state.projects.find(x=>x.id===state.currentProjectId); if (!p){ alert('Project not found'); return; } const name=prompt('New project name:', p.name); if (!name) return; p.name=name.trim(); saveProjects(); renderProjects(); updateProjectInfo(); }
  function deleteProject(){ if (!state.currentProjectId){ alert('Open a project first'); return; } const p=state.projects.find(x=>x.id===state.currentProjectId); if (!p){ alert('Project not found'); return; } if (!confirm(`Delete project "${p.name}"?`)) return; state.projects=state.projects.filter(x=>x.id!==p.id); state.currentProjectId=null; saveProjects(); renderProjects(); updateProjectInfo(); }
  function moveSelectedToProject(){ if (!state.selectedShape){ alert('Select an item first'); return; } if (state.projects.length===0){ alert('Create a project first'); return; } const names=state.projects.map((p,i)=>`${i+1}. ${p.name}`).join('
'); const pick=prompt(`Move to which project?
${names}
Enter number:`); const idx=parseInt(pick,10)-1; if (isNaN(idx)||idx<0||idx>=state.projects.length) return; state.currentProjectId=state.projects[idx].id; updateProjectInfo(); alert('Item associated with project: '+state.projects[idx].name); }
  function updateProjectInfo(){ const p=state.projects.find(x=>x.id===state.currentProjectId); const title=state.currentTitle?` – ${state.currentTitle}`:''; projectInfo.textContent=(p?p.name:'New Project')+title; }
  function setTitle(){ const t=prompt('Set item title:', state.currentTitle || ''); if (!t) return; state.currentTitle=t.trim(); updateProjectInfo(); }

  // ===== Settings =====
  function loadSettings(){ try { const saved=JSON.parse(localStorage.getItem('emrynMeasurementSettings')||'{}'); state.bluetooth.autoConnect=!!saved.autoConnect; state.units=saved.units||'imperial'; state.drawSettings=saved.drawSettings||state.drawSettings; state.language=saved.language||'en'; state.user=saved.user||state.user; document.getElementById('unitsSelect').value=state.units; document.getElementById('snapToggle').checked=!!state.drawSettings.snap; document.getElementById('guidesToggle').checked=!!state.drawSettings.guides; document.getElementById('endpointSnapToggle').checked=!!state.drawSettings.endpointSnap; document.getElementById('leaderDashedToggle').checked=state.drawSettings.dashedLeader!==false; document.getElementById('userNameInput').value=state.user.name||''; document.getElementById('companyInput').value=state.user.company||''; document.getElementById('emailInput').value=state.user.email||''; document.getElementById('phoneInput').value=state.user.phone||''; // branding previews
      document.getElementById('menuLogoPreview').src=state.branding.menuLogo; document.getElementById('watermarkLogoPreview').src=state.branding.watermarkLogo; } catch (e) { console.warn('Failed to load settings'); }
  }
  function saveSettingsFromUI(){ state.units=document.getElementById('unitsSelect').value; state.drawSettings.snap=document.getElementById('snapToggle').checked; state.drawSettings.guides=document.getElementById('guidesToggle').checked; state.drawSettings.endpointSnap=document.getElementById('endpointSnapToggle').checked; state.drawSettings.dashedLeader=document.getElementById('leaderDashedToggle').checked; state.user.name=document.getElementById('userNameInput').value.trim(); state.user.company=document.getElementById('companyInput').value.trim(); state.user.email=document.getElementById('emailInput').value.trim(); state.user.phone=document.getElementById('phoneInput').value.trim(); saveSettings(); showScreen('home'); initBranding(); }
  function saveSettings(){ try { localStorage.setItem('emrynMeasurementSettings', JSON.stringify({ autoConnect: state.bluetooth.autoConnect, units: state.units, drawSettings: state.drawSettings, language: state.language, user: state.user })); } catch (e) { console.warn('Failed to save settings'); } }
  function onMenuLogoUpload(e){ const file=e.target.files[0]; if (!file) return; const r=new FileReader(); r.onload=ev=>{ state.branding.menuLogo=ev.target.result; localStorage.setItem('menuLogo', state.branding.menuLogo); initBranding(); document.getElementById('menuLogoPreview').src=state.branding.menuLogo; }; r.readAsDataURL(file); }
  function onWatermarkUpload(e){ const file=e.target.files[0]; if (!file) return; const r=new FileReader(); r.onload=ev=>{ state.branding.watermarkLogo=ev.target.result; localStorage.setItem('watermarkLogo', state.branding.watermarkLogo); const w=new Image(); w.src=state.branding.watermarkLogo; w.onload=()=>state._watermark=w; document.getElementById('watermarkLogoPreview').src=state.branding.watermarkLogo; }; r.readAsDataURL(file); }

  // ===== Utilities =====
  function distanceToLine(pt,a,b){ const A=pt.x-a.x,B=pt.y-a.y,C=b.x-a.x,D=b.y-a.y; const dot=A*C+B*D; const len=C*C+D*D; if (len===0) return dist(pt,a); let param=dot/len; let xx,yy; if (param<0){ xx=a.x; yy=a.y; } else if (param>1){ xx=b.x; yy=b.y; } else { xx=a.x+param*C; yy=a.y+param*D; } return dist(pt,{x:xx,y:yy}); }
  function dist(p1,p2){ return Math.hypot(p2.x-p1.x,p2.y-p1.y); }
  function id(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }
  function beep(){ try { const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.connect(g); g.connect(ac.destination); o.frequency.value=800; g.gain.value=0.1; o.start(); setTimeout(()=>{ o.stop(); ac.close(); }, 150); } catch {}
  }
})();
</script>
</body>
</html>
